---
title: "Data analysis TransitSHIME"
author: "Yorick Minnebo"
date: "19-8-2019"
output:
  html_document: 
    theme: paper
    toc: true
    number_sections: true
  pdf_document: 
    toc: TRUE 
editor_options: 
  chunk_output_type: inline
---
# Initialisation
```{r Setup, include=F}
knitr::opts_chunk$set(#eval = TRUE, 
                      #echo = TRUE, 
                      cache = TRUE,
                      #include = FALSE,
                      collapse = FALSE,
                      dependson = NULL,
                      warning = FALSE,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.align = "center",
                      cache.lazy = FALSE)

# Create_directories, echo=FALSE, cache=FALSE, eval=TRUE, message=FALSE
wdir <- function() setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/TransitSHIME") #load dataframe
savedir <- function() setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data/Results") #save results
saveplots <- function () setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data/Results/plots") #save plots
```



# Load and manipulate stuff
## Load packages
```{r Load_packages, echo=TRUE, results=FALSE, error=FALSE}
# loading in data
# library(rJava)
# library(devtools)

# formatting data
library(reshape2)
library(plyr)
library(dplyr)
library(tidyr)
library(tidyverse)

# plotting data
library(ggplot2)
library(cowplot)
library("gridExtra")
# install_github("hrbrmstr/ggeconodist")
# library("ggeconodist")

#Statistics
# install.packages("RVAideMemoire")
library(RVAideMemoire)
library(lawstat)
# library(car)
library(ggpubr)
library(rstatix)

#combine panels 
library(grid)
library(gtable)

# For db-RDA
library(vegan)
library(ggrepel)
library(lemon)

# own R-scripts
source('YM_KDP_papertheme.R')
source('YM_fusetoplayer.R')
# source("YM_paperplot.R")

library(vegan)
library(phyloseq)
sessionInfo()
# sessionInfo(package = "stats")


# Make supplementary figures in grey values for cheaper printing. For paper make = false
BW = TRUE
```

## Load labels and colours
Load labels and colours. Colours are consistent throughout the project
```{r labels and colours, message=FALSE, warning=FALSE}
# Universal colours for the project
source("YM_colours.R")

# Labels
donor.labs <- c("Donor 1", "Donor 2", "Donor 3", "Donor 4", "Donor 5", "Donor 6")
names(donor.labs) <- c("1", "2", "3", "4","5","6")
PD_Colon.labs <- c("Faecal sample","Proximal colon", "Distal colon")
names(PD_Colon.labs) <- c("FS","P", "D")
PD_Colon.labsPC <- c("Faecal sample","Proximal colon", "Distal colon")
names(PD_Colon.labsPC) <- c("FS","P", "D")


saveplots <- function () setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data/Results/Plots") #save plots
RDP <- T
otu <- FALSE

# italiced in vivo labels
lblinvivo <- "\U0001d62a\U0001D62F \U0001D637\U0001d62a\U0001D637\U0001D630"
lblInvivo <- "\U0001D43C\U0001D62F \U0001D637\U0001d62a\U0001D637\U0001D630"
cat(lblinvivo)


# Margins for plots
# marginforplots <- margin(t = 0, r = 0, b = 0, l = 5, unit = "cm")

# Parameters plot
point_size <- 20
xaxis = c("Days of treatment")
lbl = c("PC, 1","PC, 2","PC, 3","PC, 4","PC, 5","PC, 6","DC, 1","DC, 2","DC, 3","DC, 4","DC, 5","DC, 6","FS, 1","FS, 2","FS, 3","FS, 4","FS, 5","FS, 6") # labels for plots
lblP = c("PC, 1","PC, 2","PC, 3","PC, 4","PC, 5","PC, 6") # labels for plots in proximal colon
lblD = c("DC, 1","DC, 2","DC, 3","DC, 4","DC, 5","DC, 6") # labels for plots in distal colon
lblPD = c("PC, 1","PC, 2","PC, 3","PC, 4","PC, 5","PC, 6","DC, 1","DC, 2","DC, 3","DC, 4","DC, 5","DC, 6") # labels for plots in PC and DC
lblVFA = c("Acetate","Propionate","Butyrate", "Total")

# Labels
VFA.labs <- c("Acetate", "Propionate", "Butyrate", "Total")
names(VFA.labs) <- c("Acetate", "Propionate", "Butyrate", "total_SCFA")

donor.labs <- c("Donor 1 - Short", "Donor 2 - Short", "Donor 3 - Medium", "Donor 4 - Long", "Donor 5 - Long", "Donor 6 - Medium")
names(donor.labs) <- c("1", "2", "3", "4","5","6")

Vessel.labs <- c("Faecal sample","Proximal colon", "Distal colon")
names(Vessel.labs) <- c("FS","P", "D")

Transit.labs <- c("Short transit", "Medium transit", "Long transit")
names(Transit.labs) <- c("ST", "MT", "LT")

donor.labs <- c("Donor 1", "Donor 2", "Donor 3", "Donor 4", "Donor 5", "Donor 6")
names(donor.labs) <- c("1", "2", "3", "4","5","6")
```

## Load and manipulate functional data
Load an manipulate the functional data. Create 
```{r Load and manipulate functional data, include=FALSE}
# Set working directory and load functional data
wdir();getwd() 
functdata <- read.csv2("Dataframe_alt.csv", sep=",")
# functdata <- read.csv2("Dataframe.csv", sep=",")
# order levels and transform from continuous scale to factor
functdata$Donor[functdata$Donor == 4] <- 7; functdata$Donor[functdata$Donor == 6] <- 4
functdata$Donor[functdata$Donor == 7] <- 6; 
functdata$Donor <- as.ordered(factor(functdata$Donor,levels=c("1","2","3","4","5","6")))
functdata$Vessel <- as.ordered(factor(functdata$Vessel,levels=c("P","D","FS")))
functdata$Ninetransit <- as.ordered(factor(functdata$Ninetransit,levels=c("0","1","2","3","4")))
functdata$Transit <- as.ordered(factor(functdata$Transit,levels=c("ST","MT","LT","FS")))

# Make columns numeric
i <- c(9:34) # Specify columns you want to change
functdata[ , i] <- apply(functdata[ , i], 2,            # Specify own function within apply
                    function(x) as.numeric(as.character(x)))

class(functdata[,9:34]); head(functdata[,9:34])

# x2 compensation to faecal sample of donor 5 (number 400, was diluted extra in preparation process)
functdatatrt <- subset(functdata, Samplenumber == 400)
functdatatrt[,9:18] <- functdatatrt[,9:18]*2
functdata <- rbind(subset(functdata, Samplenumber != 400), functdatatrt)

# Add total_SCFA ratio of SCFA and branched to dataframe
functdatanet <- functdata # To use down below
functdata <- mutate(functdata,total_SCFA=Acetate+Propionate+Butyrate+Isobutyrate+Isovalerate+Valerate+Isocaproate+Caproate+Heptanoate)
functdata <- mutate(functdata,Acetateratio=Acetate/total_SCFA,
                    Propionateratio=Propionate/total_SCFA,
                    Butyrateratio=Butyrate/total_SCFA,
                    Branched = Isovalerate+Isobutyrate, 
                    Branchedratio = Branched/total_SCFA,
                    But_prop=Butyrate/Propionate)

# Omit NA from dataframe 
functdata <- functdata %>% filter(!is.na(Acetate))
functdatabrut <- functdata

# Create dataframe without stabilisation
functdatatrt <- functdata %>% filter(!is.na(Ninetransit))

## Create dataframe without pumps and halfway transit
functdatatransit <- subset(functdatatrt,Ninetransit=='0'|Ninetransit=='3')

df.melted <- melt(functdata, id.vars = c("Day","Vessel","Donor","Transit","Ninetransit"))

## Proximal vs distal
functdatatransit2 <- subset(functdatatrt,Ninetransit=='3')
functdatatrtP <- subset(functdatatransit2,Vessel=="P")
functdatatrtD <- subset(functdatatransit2,Vessel=="D")

rm(functdatatransit2)

# Add total_SCFA ratio of SCFA and branched to dataframe
## Proximal vs distal
functdataP <- subset(functdata, Vessel == "P")
functdataD <- subset(functdata, Vessel == "D")

# Create dataframe without stabilisation
functdatatrt <- subset(functdata, Ninetransit == 3)
# functdatatrt <- subset(functdata, Ninetransit == 3|Ninetransit == 4)
df.melted <- melt(functdatatrt, id.vars = c("Day", "Vessel", "Donor", "Transit"))

# Mean of metabolites per donor, Nutrient_Load and PD_Colon
df.mean <- subset(functdatatrt, select = c("Day", "Vessel", "Donor", "Transit", "Butyrate", "Acetate", "Propionate", 
                                           "NH4.", "Lactate", "total_SCFA", "Branched", "Total_cells_events.ml"))
df.mean <- subset(df.mean, Vessel == "P" | Vessel == "D")
df.meanX <- group_by_at(df.mean, vars(Donor, Transit, Vessel))
df.meanX <- summarise_at(df.meanX, vars(Acetate, Propionate, Butyrate, NH4., Branched, total_SCFA,
                                        Lactate,Total_cells_events.ml), funs(
                                          # n(),
                                          sd, mean))

colnames(df.meanX)[colnames(df.meanX) %in% c("Acetate_sd",	"Propionate_sd", "Butyrate_sd",	"NH4._sd", "Branched_sd", 
   "total_SCFA_sd",	"Lactate_sd", "Total_cells_events.ml_sd",	"Acetate_mean",	"Propionate_mean", "Butyrate_mean", 
   "NH4._mean",	"Branched_mean",	"total_SCFA_mean",	"Lactate_mean", "Total_cells_events.ml_mean")] <- c("Acet_sd",
   "Prop_sd",	"Buty_sd",	"Amm_sd",	"Branched_sd",	"SCFA_sd",	"Lact_SD",	"Total_cells_events.ml_SD", "Acetate",	
   "Propionate",	"Butyrate",		"Ammonium",	"Branched",	"total_SCFA", "Lactate",	"Total_cells_events.ml")

# Add begin and end values for stacked VFA barplots
df.meanX <- mutate(df.meanX, ybeginA = Acetate + Propionate + Butyrate - Acet_sd, 
                   yendA = Acetate + Propionate + Butyrate + Acet_sd, 
                   ybeginP = Propionate + Butyrate - Prop_sd,
                   yendP = Propionate + Butyrate + Prop_sd, 
                   ybeginB = Butyrate - Buty_sd, 
                   yendB = Butyrate + Buty_sd)
                   
df.mean <- df.meanX
df.mean$Vessel <- as.ordered(factor(df.mean$Vessel, levels = c("P", "D", "FS")))
df.mean2 <- df.mean

df.meanX <- melt(df.meanX, id.vars = c("Vessel", "Donor", "Transit"))
df.meanbegin <- data.frame(Acet = df.mean$ybeginA, Prop = df.mean$ybeginP, But = df.mean$ybeginB)
df.meanbegin <- melt(df.meanbegin)
df.meanend <- data.frame(Acet = df.mean$yendA, Prop = df.mean$yendP, But = df.mean$yendB)
df.meanend <- melt(df.meanend)
df.meanSD <- data.frame(Acet = df.mean$Acet_sd, Prop = df.mean$Prop_sd, But = df.mean$Buty_sd)
df.meanSD <- melt(df.meanSD)
df.meanVFA <- subset(df.meanX, variable == "Acetate" | variable == "Propionate" | 
    variable == "Butyrate")
df.meanVFA <- cbind(df.meanVFA, SD = df.meanSD$value, ybegin = df.meanbegin$value, 
    yend = df.meanend$value)




# Volumetric net production rate
functdatabruto <- functdatanet
functdataP <- subset(functdatanet, Vessel == "P")
functdataD <- subset(functdatanet, Vessel == "D")
volcorr = F
if(volcorr == T){
test1 <- subset(functdataP, Transit == "ST"); test1$volume <- 0.200
test2 <- subset(functdataP, Transit == "MT"); test2$volume <- 0.400
test3 <- subset(functdataP, Transit == "LT"); test3$volume <- 0.600
functdataP <- rbind(test1, test2, test3)
test1 <- subset(functdataD, Transit == "ST"); test1$volume <- 0.325
test2 <- subset(functdataD, Transit == "MT"); test2$volume <- 0.650
test3 <- subset(functdataD, Transit == "LT"); test3$volume <- 0.975
functdataD <- rbind(test1, test2, test3)}

 ## proximal net production
 if(volcorr == T){functdataPnetnr  <- subset(functdataP,select=c(Acetate:Lactate))*(600/1000)*(1/functdataP$volume)
 }else{functdataPnetnr  <- subset(functdataP,select=c(Acetate:Lactate))*(600/1000)}
 functdataPnet <- cbind(subset(functdataP,select=c(Samplenumber:Transitnumber)),
                       functdataPnetnr, subset(functdataP,select=c(Intact_cells_events.ml:SD_percentage_intact)))

 ## distal net production
 if(volcorr == T){functdataDnetnr  <- (subset(functdataD,select=c(Acetate:Lactate))-subset(functdataP,select=c(Acetate:Lactate)))*(600/1000)*(1/functdataD$volume)
 }else{functdataDnetnr  <- (subset(functdataD,select=c(Acetate:Lactate))-subset(functdataP,select=c(Acetate:Lactate)))*(600/1000)}
 functdataDnet <- cbind(subset(functdataD,select=c(Samplenumber:Transitnumber)),
                       functdataDnetnr, subset(functdataD,select=c(Intact_cells_events.ml:SD_percentage_intact)))
 
 ## functdata net
 functdatanet <- rbind(functdataPnet, functdataDnet, subset(functdatanet, Vessel == "FS"))
 functdatanet[c(9: 18)] <- replace(functdatanet[c(9: 18)], functdatanet[c(9: 18)] < 0, 0)
 functdatanet <- mutate(functdatanet, total_SCFA = Acetate + Propionate + Butyrate + Isobutyrate + 
    Isovalerate + Valerate + Isocaproate + Caproate + Heptanoate)
 functdatanet <- mutate(functdatanet, Acetateratio = Acetate/total_SCFA, Propionateratio = Propionate/total_SCFA, 
    Butyrateratio = Butyrate/total_SCFA, Branched = Isovalerate + Isobutyrate, Branchedratio = Branched/total_SCFA,
    But_prop = Butyrate/Propionate)



# Add total_SCFA ratio of SCFA and branched to dataframe
functdata <- functdatanet

## Proximal vs distal
functdataP <- subset(functdata, Vessel == "P")
functdataD <- subset(functdata, Vessel == "D")

# Create dataframe without stabilisation
# functdatatrt <- subset(functdata, Ninetransit == 3|Ninetransit == 4)
functdatatrt <- subset(functdata, Ninetransit == 3)
df.melted <- melt(functdatatrt, id.vars = c("Day", "Vessel", "Donor", "Transit"))

# Mean of metabolites per donor, Nutrient_Load and PD_Colon
df.mean <- subset(functdatatrt, select = c("Day", "Vessel", "Donor", "Transit", "Butyrate", "Acetate", "Propionate", 
                                           "NH4.", "Lactate", "total_SCFA", "Branched", "Total_cells_events.ml"))
df.mean <- subset(df.mean, Vessel == "P" | Vessel == "D")

df.meantransit <- group_by_at(df.mean, vars(Transit, Vessel))
df.meantransit <- summarise_at(df.meantransit, vars(Acetate, Propionate, Butyrate, Branched, total_SCFA), funs(sd, mean))

df.meanX <- group_by_at(df.mean, vars(Donor, Transit, Vessel))
df.meanX <- summarise_at(df.meanX, vars(Acetate, Propionate, Butyrate, NH4., Branched, total_SCFA,
                                        Lactate,Total_cells_events.ml), funs(
                                          # n(),
                                          sd, mean))

colnames(df.meanX)[colnames(df.meanX) %in% c("Acetate_sd",	"Propionate_sd", "Butyrate_sd",	"NH4._sd", "Branched_sd", 
   "total_SCFA_sd",	"Lactate_sd", "Total_cells_events.ml_sd",	"Acetate_mean",	"Propionate_mean", "Butyrate_mean", 
   "NH4_mean",	"Branched_mean",	"total_SCFA_mean",	"Lactate_mean", "Total_cells_events.ml_mean")] <- c("Acet_sd",
   "Prop_sd",	"Buty_sd",	"Amm_sd",	"Branched_sd",	"SCFA_sd",	"Lact_SD",	"Total_cells_events.ml_SD", "Acetate",	
   "Propionate",	"Butyrate",		"Ammonium",	"Branched",	"total_SCFA", "Lactate",	"Total_cells_events.ml")

# Add begin and end values for stacked VFA barplots
df.meanX <- mutate(df.meanX, ybeginA = Acetate + Propionate + Butyrate - Acet_sd, 
                   yendA = Acetate + Propionate + Butyrate + Acet_sd, 
                   ybeginP = Propionate + Butyrate - Prop_sd,
                   yendP = Propionate + Butyrate + Prop_sd, 
                   ybeginB = Butyrate - Buty_sd, 
                   yendB = Butyrate + Buty_sd)
                   
df.mean <- df.meanX
df.mean$Vessel <- as.ordered(factor(df.mean$Vessel, levels = c("P", "D", "FS")))
df.mean2 <- df.mean

df.meanX <- melt(df.meanX, id.vars = c("Vessel", "Donor", "Transit"))
df.meanbegin <- data.frame(Acet = df.mean$ybeginA, Prop = df.mean$ybeginP, But = df.mean$ybeginB)
df.meanbegin <- melt(df.meanbegin)
df.meanend <- data.frame(Acet = df.mean$yendA, Prop = df.mean$yendP, But = df.mean$yendB)
df.meanend <- melt(df.meanend)
df.meanSD <- data.frame(Acet = df.mean$Acet_sd, Prop = df.mean$Prop_sd, But = df.mean$Buty_sd)
df.meanSD <- melt(df.meanSD)
df.meanVFAnet <- subset(df.meanX, variable == "Acetate" | variable == "Propionate" | 
    variable == "Butyrate")
df.meanVFAnet <- cbind(df.meanVFAnet, SD = df.meanSD$value, ybegin = df.meanbegin$value, 
    yend = df.meanend$value)


df1 <- subset(df.meanVFAnet, Donor == 1 |Donor == 2); df1$intTransit <- "Short transit donor"
df2 <- subset(df.meanVFAnet, Donor == 3 |Donor == 4); df2$intTransit <- "Medium transit donor"
df3 <- subset(df.meanVFAnet, Donor == 5 |Donor == 6); df3$intTransit <- "Long transit donor"
df.meanVFAnet <- rbind(df1, df2,df3); rm(df1, df2, df3)
df.meanVFAnet$intTransit <- as.ordered(factor(df.meanVFAnet$intTransit, 
                  levels = c("Short transit donor", "Medium transit donor", "Long transit donor")))
```


# Figure S14 - Correlations between BSS, Freq and corn
```{r Paperplot faecal samples, fig.height=8.5, fig.width=11}
# saveplots()
# ggsave(plot = comb, width = 16, height = 11, dpi = 400, filename = "microbialload_stabilised_hires.tiff")
# ggsave(plot = comb, width = 16, height = 11, dpi = 100, filename = "microbialload_stabilised_lores.tiff")
## Check for correlations
df2 <- data.frame(Donor = c(1,2,3,4,5,6))
df <- subset(df2, Donor == 1); df$Corntransit <- 21; df$cornmean <- 20; df$BSS <- 4; df$Frequency <- 7
df3 <- subset(df2, Donor == 2); df3$Corntransit <- 19; df3$cornmean <- 20; df3$BSS <- 4; df3$Frequency <- 7
df4 <- subset(df2, Donor == 3); df4$Corntransit <- 43; df4$cornmean <- 39; df4$BSS <- 3; df4$Frequency <- 4.6
df5 <- subset(df2, Donor == 4); df5$Corntransit <- 34; df5$cornmean <- 39; df5$BSS <- 2; df5$Frequency <- 3.5
df6 <- subset(df2, Donor == 5); df6$Corntransit <- 75; df6$cornmean <- 68; df6$BSS <- 1; df6$Frequency <- 2.3
df7 <- subset(df2, Donor == 6); df7$Corntransit <- 61; df7$cornmean <- 68; df7$BSS <- 2; df7$Frequency <- 2.3
df<- rbind(df,df3,df4,df5,df6,df7)
df$Corntransit <- as.numeric(df$Corntransit)
df$cornmean <- as.numeric(df$cornmean)

df2 <- df; df <- data.frame()
for (i in unique(df2$Donor)) {
  df1 <- subset(df2, Donor == i)
  if(i == 1 | i == 2){df1$intTransit <- "Short transit donor"}
  if(i == 3 | i == 4){df1$intTransit <- "Medium transit donor"}
  if(i == 5 | i == 6){df1$intTransit <- "Long transit donor"}
  df<- rbind(df, df1)
}

df$BSS <- as.numeric(df$BSS)
df$cornmean <- as.numeric(df$cornmean)
df$Corntransit <- as.numeric(df$Corntransit)
df$Frequency <- as.numeric(df$Frequency)
df$Donor <- as.ordered(factor(df$Donor,levels=c("1","2","3","4","5","6")))
df$intTransit <- as.ordered(factor(df$intTransit,
                                   levels=c("Short transit donor","Medium transit donor","Long transit donor")))

rhot <- cor.test(df$BSS, df$Corntransit, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, " = -0.90; ","p = 1.77E-06"))
summary(lm(df$BSS ~ df$Corntransit))
plot1 <- papertheme(ggplot(df, aes(x = as.numeric(BSS), y = as.numeric(Corntransit), color = Donor
                          , shape = intTransit #, fill = intTransit
                          ))+ 
             geom_point(size = 5,alpha = 0.8)) + ylab("Corn transit time (h)") + 
  geom_smooth(color = "black", 
              # fill = "#ffd9cc",
              method=lm, inherit.aes = F, mapping = aes(x = as.numeric(BSS), y = as.numeric(Corntransit)))+
  xlab("Bristol stool score") +
  scale_color_manual(values = sixdonors, name = "Donor") +
  scale_shape_manual(name = expression(paste(italic("In vivo"), " transit")), 
              values = c("Short transit donor" = 16, "Medium transit donor" = 17, "Long transit donor" = 15), 
              labels = c("Short", "Medium", "Long")
              )+ guides(color = guide_legend(ncol = 2))+
  theme(legend.position = c(0.1,0.25), legend.direction = "vertical")+
  geom_text(x = 1.62, y = 81, size = 7, colour = "black", family='sans', label = rho_text, parse = TRUE, hjust = 0)


if(BW == TRUE){plot1 <- plot1 + scale_color_grey(name = "Donor", start = 0, end = 0.6)}
# plot1


rhot <- cor.test(df$BSS, df$Frequency, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, " = 0.955; ","p = 0.003"))
summary(lm(df$BSS ~ df$Frequency))
plot2 <- papertheme(ggplot(df, aes(x = as.numeric(BSS), y = as.numeric(Frequency), color = Donor
                          , shape = intTransit #, fill = intTransit
                          ))+ 
             geom_jitter(size = 5,alpha = 0.8)) + ylab("Corn transit time (h)") + 
  geom_smooth(color = "black", 
              # fill = "#ffd9cc",
              method=lm, inherit.aes = F, mapping = aes(x = as.numeric(BSS), y = as.numeric(Frequency)))+
  xlab("Bristol stool score") +
  ylab(expression(paste("Stool defecation frequency (",week^{"-1"}, ")")))+
  scale_color_manual(values = sixdonors, name = "Donor") +
  scale_shape_manual(name = expression(paste(italic("In vivo"), " transit")), 
              values = c("Short transit donor" = 16, "Medium transit donor" = 17, "Long transit donor" = 15), labels = c("Short", "Medium", "Long"))+ guides(color = guide_legend(ncol = 2))+
  theme(legend.position = c(0.9,0.25), legend.direction = "vertical")+
  geom_text(x = 1, y = 7, size = 7, colour = "black", family='sans', label = rho_text, parse = TRUE, hjust = 0) 
# plot2
if(BW == TRUE){plot2 <- plot2 + scale_color_grey(name = "Donor", start = 0, end = 0.6)}


rhot <- cor.test(df$Corntransit, df$Frequency, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, " = -0.912; ","p = 0.01"))
summary(lm(df$BSS ~ df$Frequency))
plot3 <- papertheme(ggplot(df, aes(x = as.numeric(Corntransit), y = as.numeric(Frequency), color = Donor
                          , shape = intTransit #, fill = intTransit
                          ))+ 
             geom_point(size = 5,alpha = 0.8)) +
  geom_smooth(color = "black", 
              # fill = "#ffd9cc",
              method=lm, inherit.aes = F, mapping = aes(x = as.numeric(Corntransit), y = as.numeric(Frequency)))+
  xlab("Corn transit time (h)") + 
  ylab(expression(paste("Stool defecation frequency (",week^{"-1"}, ")")))+
  scale_color_manual(values = sixdonors, name = "Donor") +
  scale_shape_manual(name = expression(paste(italic("In vivo"), " transit")), 
              values = c("Short transit donor" = 16, "Medium transit donor" = 17, "Long transit donor" = 15), 
              labels = c("Short", "Medium", "Long"))+ guides(color = guide_legend(ncol = 2)
                                                               )+
  theme(legend.position = c(0.1,0.25), legend.direction = "vertical")+
  geom_text(x = 35, y = 7, size = 7, colour = "black", family='sans', label = rho_text, parse = TRUE, hjust = 0) 
# plot3

if(BW == TRUE){plot3 <- plot3 + scale_color_grey(name = "Donor", start = 0, end = 0.6)}
leg <- g_legend(plot3)

plot <- ggarrange(NULL, plot3 + theme(legend.position = "none"), NULL, plot2 + theme(legend.position = "none"), 
          NULL, plot1 + theme(legend.position = "none"), NULL, ggarrange(NULL, ggarrange(leg, NULL, nrow = 2), widths = c(0.5,1)), labels = c("A","", "B","", "C"), font.label = list(size =20), ncol = 4,nrow =2, widths = c(0.05,1,0.05,1))

plot 

saveplots();ggsave(plot = plot, width = 15, height = 12, dpi = 400, bg = "white", filename = "FigureS14.pdf")
# rm(df, df2, df5)
```



# Black and white Figure S14 - Correlations between BSS, Freq and corn
```{r Paperplot faecal samples, fig.height=8.5, fig.width=11}
# saveplots()
# ggsave(plot = comb, width = 16, height = 11, dpi = 400, filename = "microbialload_stabilised_hires.tiff")
# ggsave(plot = comb, width = 16, height = 11, dpi = 100, filename = "microbialload_stabilised_lores.tiff")
## Check for correlations
df2 <- data.frame(Donor = c(1,2,3,4,5,6))
df <- subset(df2, Donor == 1); df$Corntransit <- 21; df$cornmean <- 20; df$BSS <- 4; df$Frequency <- 7
df3 <- subset(df2, Donor == 2); df3$Corntransit <- 19; df3$cornmean <- 20; df3$BSS <- 4; df3$Frequency <- 7
df4 <- subset(df2, Donor == 3); df4$Corntransit <- 43; df4$cornmean <- 39; df4$BSS <- 3; df4$Frequency <- 4.6
df5 <- subset(df2, Donor == 4); df5$Corntransit <- 34; df5$cornmean <- 39; df5$BSS <- 2; df5$Frequency <- 3.5
df6 <- subset(df2, Donor == 5); df6$Corntransit <- 75; df6$cornmean <- 68; df6$BSS <- 1; df6$Frequency <- 2.3
df7 <- subset(df2, Donor == 6); df7$Corntransit <- 61; df7$cornmean <- 68; df7$BSS <- 2; df7$Frequency <- 2.3
df<- rbind(df,df3,df4,df5,df6,df7)
df$Corntransit <- as.numeric(df$Corntransit)
df$cornmean <- as.numeric(df$cornmean)

df2 <- df; df <- data.frame()
for (i in unique(df2$Donor)) {
  df1 <- subset(df2, Donor == i)
  if(i == 1 | i == 2){df1$intTransit <- "Short transit donor"}
  if(i == 3 | i == 4){df1$intTransit <- "Medium transit donor"}
  if(i == 5 | i == 6){df1$intTransit <- "Long transit donor"}
  df<- rbind(df, df1)
}

df$BSS <- as.numeric(df$BSS)
df$cornmean <- as.numeric(df$cornmean)
df$Corntransit <- as.numeric(df$Corntransit)
df$Frequency <- as.numeric(df$Frequency)
df$Donor <- as.ordered(factor(df$Donor,levels=c("1","2","3","4","5","6")))
df$intTransit <- as.ordered(factor(df$intTransit,
                                   levels=c("Short transit donor","Medium transit donor","Long transit donor")))

rhot <- cor.test(df$BSS, df$Corntransit, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, " = -0.90; ","p = 1.77E-06"))
summary(lm(df$BSS ~ df$Corntransit))
plot1 <- papertheme(ggplot(df, aes(x = as.numeric(BSS), y = as.numeric(Corntransit), shape = Donor
                          , color = intTransit #, fill = intTransit
                          ))+ 
             geom_point(size = 5,alpha = 1)) + ylab("Corn transit time (h)") + 
  geom_smooth(color = "black", 
              # fill = "#ffd9cc",
              method=lm, inherit.aes = F, mapping = aes(x = as.numeric(BSS), y = as.numeric(Corntransit)))+
  xlab("Bristol stool score") +
  scale_color_grey(name = expression(paste(italic("In vivo"), " transit")), labels = c("Short", "Medium", "Long"), 
                                           start = 0, end = 0.5) +
  scale_shape_manual(name = "Donor", 
              values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))+ 
  guides(shape = guide_legend(ncol = 2))+
  theme(legend.position = c(0.1,0.25), legend.direction = "vertical")+
  geom_text(x = 1.62, y = 81, size = 7, colour = "black", family='sans', label = rho_text, parse = TRUE, hjust = 0)


# if(BW == TRUE){plot1 <- plot1 + scale_color_grey(name = "Donor", start = 0, end = 0.6)}
# plot1


rhot <- cor.test(df$BSS, df$Frequency, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, " = 0.955; ","p = 0.003"))
summary(lm(df$BSS ~ df$Frequency))
plot2 <- papertheme(ggplot(df, aes(x = as.numeric(BSS), y = as.numeric(Frequency), shape = Donor
                          , color = intTransit #, fill = intTransit
                          ))+ 
             geom_jitter(size = 5,alpha = 0.8)) + ylab("Corn transit time (h)") + 
  geom_smooth(color = "black", 
              # fill = "#ffd9cc",
              method=lm, inherit.aes = F, mapping = aes(x = as.numeric(BSS), y = as.numeric(Frequency)))+
  xlab("Bristol stool score") +
  ylab(expression(paste("Stool defecation frequency (",week^{"-1"}, ")")))+
  scale_color_grey(name = expression(paste(italic("In vivo"), " transit")), labels = c("Short", "Medium", "Long"), 
                                           start = 0, end = 0.5) +
  scale_shape_manual(name = "Donor", 
              values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))+ 
  guides(shape = guide_legend(ncol = 2))+
  theme(legend.position = c(0.9,0.25), legend.direction = "vertical")+
  geom_text(x = 1, y = 7, size = 7, colour = "black", family='sans', label = rho_text, parse = TRUE, hjust = 0) 
# plot2
# if(BW == TRUE){plot2 <- plot2 + scale_color_grey(name = "Donor", start = 0, end = 0.6)}


rhot <- cor.test(df$Corntransit, df$Frequency, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, " = -0.912; ","p = 0.01"))
summary(lm(df$BSS ~ df$Frequency))
plot3 <- papertheme(ggplot(df, aes(x = as.numeric(Corntransit), y = as.numeric(Frequency), shape = Donor
                          , color = intTransit #, fill = intTransit
                          ))+ 
             geom_point(size = 5,alpha = 0.8)) +
  geom_smooth(color = "black", 
              # fill = "#ffd9cc",
              method=lm, inherit.aes = F, mapping = aes(x = as.numeric(Corntransit), y = as.numeric(Frequency)))+
  xlab("Corn transit time (h)") + 
  ylab(expression(paste("Stool defecation frequency (",week^{"-1"}, ")")))+
  scale_color_grey(name = expression(paste(italic("In vivo"), " transit")), labels = c("Short", "Medium", "Long"), 
                                           start = 0, end = 0.5) +
  scale_shape_manual(name = "Donor", 
              values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))+  guides(shape = guide_legend(ncol = 2)
                                                               )+
  theme(legend.position = c(0.1,0.25), legend.direction = "vertical")+
  geom_text(x = 35, y = 7, size = 7, colour = "black", family='sans', label = rho_text, parse = TRUE, hjust = 0) 
# plot3

# if(BW == TRUE){plot3 <- plot3 + scale_color_grey(name = "Donor", start = 0, end = 0.6)}
leg <- g_legend(plot3)

plot <- ggarrange(NULL, plot3 + theme(legend.position = "none"), NULL, plot2 + theme(legend.position = "none"), 
          NULL, plot1 + theme(legend.position = "none"), NULL, ggarrange(NULL, ggarrange(leg, NULL, nrow = 2), widths = c(0.5,1)), labels = c("A","", "B","", "C"), font.label = list(size =20), ncol = 4,nrow =2, widths = c(0.05,1,0.05,1))

plot 

saveplots();ggsave(plot = plot, width = 15, height = 12, dpi = 400, bg = "white", filename = "FigureS14.pdf")
# rm(df, df2, df5)
```




# Net production with loading rate
## Calculate it
```{r Net production}
  # Calculate with or without volume correction in a for loop. Code will save the correct one automatically
  # Needs to be corrected for nutrient load! No correction for CH and biomass!
  for(volcor1 in c(T, F)){
    volcorr <- volcor1
    
  # CELL COUNTS
  if(exists("by_nr") == F){by_nr <- read.csv("cellcounts.csv")} # Import cell counts
  df.counts <- by_nr
  
  # Start with bruto production
  netproduction <- subset(df.counts, Ninetransit == 3)
  netproduction$comb <- paste0(netproduction$Day, netproduction$Donor, netproduction$Transit, netproduction$Vessel)

  
  netproduction <- netproduction[!duplicated(netproduction), ]
  netproduction$comb2 <- paste0(netproduction$Donor, "_", netproduction$Transit,"_",netproduction$Vessel)
  
  df.carbohydrates <- read.csv2("Filtered_carbohydrateanalyses.csv", sep=";")
  df.carbohydrates$Carbohydrate <- as.numeric(df.carbohydrates$Carbohydrate)
  df.carbohydrates$Carbohydrate_differences <- as.numeric(df.carbohydrates$Carbohydrate_differences)
  df.carbohydrates$Medium <- as.numeric(df.carbohydrates$Medium)
  df.carbohydrates$CH <- df.carbohydrates$Carbohydrate
  
  netproduction <-  merge(netproduction, df.carbohydrates, by.x = "comb2",by.y="Combination")
  netproduction <- subset(netproduction, select = -c(comb2))
  
  # Add reactor volumes, dosage rate and influent substrate concentration
  test1 <- subset(netproduction, Vessel == "P" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
  test1$volume <- 0.200; test1$infldosage <- 0.600; test1$inflsubstrate <- (23.4*0.04666666666667)/0.2
  test2 <- subset(netproduction, Vessel == "P" & Transit == "MT") # 94 mL of 23.4g/L medium per 200 mL influent
  test2$volume <- 0.400; test2$infldosage <- 0.600; test2$inflsubstrate <- (23.4*0.0933333333333333)/0.2
  test3 <- subset(netproduction, Vessel == "P" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
  test3$volume <- 0.600; test3$infldosage <- 0.600; test3$inflsubstrate <- (23.4*0.14)/0.2
  test4 <- subset(netproduction, Vessel == "D" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
  test4$volume <- 0.325; test4$infldosage <- 0.600; test4$inflsubstrate <- (23.4*0.0466666666666667)/0.2
  test5 <- subset(netproduction, Vessel == "D" & Transit == "MT") # 93 mL of 23.4g/L medium per 200 mL influent
  test5$volume <- 0.650; test5$infldosage <- 0.600; test5$inflsubstrate <- (23.4*0.0933333333333333)/0.2
  test6 <- subset(netproduction, Vessel == "D" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
  test6$volume <- 0.975; test6$infldosage <- 0.600; test6$inflsubstrate <- (23.4*0.14)/0.2
  netprodP <- rbind(test1, test2, test3); netprodP<- netprodP[order(netprodP$comb), ]  
  netprodD <- rbind(test4, test5, test6); netprodD<- netprodD[order(netprodD$comb), ] 
  
  # place carbohydrates at the end
  netprodP <- relocate(netprodP, Carbohydrate, .after = last_col())
  netprodP$Carbohydrate <- as.numeric(netprodP$Carbohydrate)
  netprodD <- relocate(netprodD, Carbohydrate, .after = last_col())
  netprodD$Carbohydrate <- as.numeric(netprodD$Carbohydrate)  
    
  
  # Net production
  if(volcorr == T){
    netprodP1  <- subset(netprodP, select=c(SDtot:meanPER))*(600/1000)*(1/netprodP$volume)
    netprodD_CH  <- (netprodP$Medium - subset(netprodP,select=c(Carbohydrate)))*(600/1000)*(1/netprodP$volume)
   netprodP1 <- cbind(netprodP1, netprodD_CH)
  }else{netprodP1  <- subset(netprodP,select=c(SDtot:meanPER))*(600/1000)
   netprodD_CH  <- (netprodP$Medium - subset(netprodP,select=c(Carbohydrate)))*(600/1000)
   netprodP1 <- cbind(netprodP1, netprodD_CH)
   }
   netprodPnet <- cbind(subset(netprodP,select=c(Nr)),
                         netprodP1, subset(netprodP,select=c(Donor:inflsubstrate)))
   
  
   
   ## distal net production
   if(volcorr == T){netprodD1  <- (subset(netprodD,select=c(SDtot:meanPER)) - subset(netprodP, 
                                        select=c(SDtot:meanPER)))*(600/1000)*(1/netprodD$volume)
   netprodD_CH  <- (subset(netprodD,select=c(Carbohydrate)) - subset(netprodP, 
                                        select=c(Carbohydrate)))*(-600/1000)*(1/netprodD$volume)
   netprodD1 <- cbind(netprodD1, netprodD_CH)
   }else{
     netprodD1 <- (subset(netprodD,select=c(SDtot:meanPER))-subset(netprodP, 
                                            select=c(SDtot:meanPER)))*(600/1000)
   netprodD_CH  <- (subset(netprodD,select=c(Carbohydrate)) - subset(netprodP, 
                                        select=c(Carbohydrate)))*(-600/1000)
     netprodD1 <- cbind(netprodD1, netprodD_CH)
   }
   netprodDnet <- cbind(subset(netprodD,select=c(Nr)),
                         netprodD1, subset(netprodD,select=c(Donor:inflsubstrate)))
    netproduction.counts <- rbind(netprodPnet, netprodDnet)
  
  
  
  
    
  
  
  # SCFAs
  # Start with bruto production
  netproduction <- functdatabruto
  
  
  # Add reactor volumes, dosage rate and influent substrate concentration
  test1 <- subset(netproduction, Vessel == "P" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
  test1$volume <- 0.200; test1$infldosage <- 0.600; test1$inflsubstrate <- (23.4*0.04666666666667)/0.2
  
  test2 <- subset(netproduction, Vessel == "P" & Transit == "MT") # 94 mL of 23.4g/L medium per 200 mL influent
  test2$volume <- 0.400; test2$infldosage <- 0.600; test2$inflsubstrate <- (23.4*0.0933333333333333)/0.2
  
  test3 <- subset(netproduction, Vessel == "P" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
  test3$volume <- 0.600; test3$infldosage <- 0.600; test3$inflsubstrate <- (23.4*0.14)/0.2
  
  test4 <- subset(netproduction, Vessel == "D" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
  test4$volume <- 0.325; test4$infldosage <- 0.600; test4$inflsubstrate <- (23.4*0.0466666666666667)/0.2
  
  test5 <- subset(netproduction, Vessel == "D" & Transit == "MT") # 93 mL of 23.4g/L medium per 200 mL influent
  test5$volume <- 0.650; test5$infldosage <- 0.600; test5$inflsubstrate <- (23.4*0.0933333333333333)/0.2
  
  test6 <- subset(netproduction, Vessel == "D" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
  test6$volume <- 0.975; test6$infldosage <- 0.600; test6$inflsubstrate <- (23.4*0.14)/0.2
  
  netprodP <- rbind(test1, test2, test3)
  netprodD <- rbind(test4, test5, test6)
  
  
  
  # Net production
  # volcorr = F # Needs to be corrected for load! No correction for CH and biomass!
  if(volcorr == T){netprodP1  <- subset(netprodP,
                          select=c(Acetate:Lactate))*(600/1000)*(1/netprodP$volume)
   }else{netprodP1  <- subset(netprodP,select=c(Acetate:Lactate))*(600/1000)}
   netprodPnet <- cbind(subset(netprodP,select=c(Samplenumber:Transitnumber)),
                         netprodP1, subset(netprodP,select=c(Intact_cells_events.ml:inflsubstrate)))
  
   ## distal net production
   if(volcorr == T){netprodD1  <- (subset(netprodD,select=c(Acetate:Lactate))-subset(netprodP,
        select=c(Acetate:Lactate)))*(600/1000)*(1/netprodD$volume)
   }else{netprodD1 <- (subset(netprodD,select=c(Acetate:Lactate))-subset(netprodP, 
                                                              select=c(Acetate:Lactate)))*(600/1000)}
   netprodDnet <- cbind(subset(netprodD,select=c(Samplenumber:Transitnumber)),
                         netprodD1, subset(netprodD,select=c(Intact_cells_events.ml:inflsubstrate)))
  
    netproduction <- rbind(netprodPnet, netprodDnet)
  if(volcorr == F){write.csv(netproduction,"netSCFAproduction.csv")}
  
  
  # Calculate nutrient load (g/d) = influent substrate conc * influent dosage
  netproduction$load <- netproduction$inflsubstrate*netproduction$infldosage
  unique(subset(netproduction, Vessel == "P")$load)
  
  # Calculate volumetric loading rate (g/Lr/d) = load (g/d) / reactor volume (Lr)
  netproduction$volloadrate <- netproduction$load/netproduction$volume
  unique(subset(netproduction, Vessel == "P")$volloadrate)


# Assume 100% conversion efficiency and assume that the substrate goes completely to product
# Concentration in vessel is the concentration of the SCFA

netproductionAmm <- netproduction
netproductionAmm <- netproductionAmm %>% filter(!is.na(NH4.))
netproductionAmm$ammonium <- netproductionAmm$NH4.

# Take only the stabilised communities and add cell counts
netproduction <- subset(netproduction, Ninetransit == 3)

netproduction <-  merge(netproduction, netproduction.counts[, c("Nr", "SDtot", "meantot", "meanINT", "SDINT", "Carbohydrate")], by.x = "Samplenumber",by.y="Nr", all.x=F)


# Biomass estimate relative to nutrient load
netprod <- subset(netproduction, select = c(Samplenumber, Date, Day, Transit, Donor, Vessel, 
                                            Ninetransit, Acetate, Propionate, Butyrate, load, 
                                            Valerate, Caproate, Heptanoate, Isovalerate , 
                                            Isobutyrate, Octanoic.acid))

metabolites_relative_load <- mutate(netprod, Acet_load = Acetate/load,
                        Prop_load =Propionate/load, Buty_load =Butyrate/load, 
                        Val_load = Valerate/load, Cap_load = Caproate/load,
                        Hep_load = Heptanoate/load, Oct_load = Octanoic.acid/load,
                        Isoval_load = Isovalerate/load, Isobut_load = Isobutyrate/load,
                        SCFA_load = Acet_load + Prop_load + Buty_load)
metabolites_relative_load <- subset(metabolites_relative_load, Vessel == "P")



df.1 <- subset(metabolites_relative_load, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(metabolites_relative_load, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(metabolites_relative_load, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
metabolites_relative_load <- test


metabolites_relative_carbohydrate <- mutate(netproduction, Acet_CH = Acetate/Carbohydrate,
                        Prop_CH =Propionate/Carbohydrate, Buty_CH =Butyrate/Carbohydrate, 
                        Val_CH = Valerate/Carbohydrate, Cap_CH = Caproate/Carbohydrate,
                        Hep_CH = Heptanoate/Carbohydrate, Oct_CH = Octanoic.acid/Carbohydrate,
                        Isoval_CH = Isovalerate/Carbohydrate, Isobut_CH = Isobutyrate/Carbohydrate,
                        SCFA_CH = Acet_CH + Prop_CH + Buty_CH)

df.1 <- subset(metabolites_relative_carbohydrate, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(metabolites_relative_carbohydrate, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(metabolites_relative_carbohydrate, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
metabolites_relative_carbohydrate <- test


# Production relative to biomass estimate
production_relative_biomass <- mutate(netproduction, Acet_biomass = Acetate/meantot,
                                      Prop_biomass = Propionate/meantot,
                                      But_biomass = Butyrate/meantot,
                                      total_SCFA = Acetate + Propionate + Butyrate,
                                      Branched = Isovalerate + Isobutyrate,
                                      SCFA_biomass = total_SCFA/meantot, 
                                      Branched_biomass = Branched/meantot,
                                      Val_biomass = Valerate/meantot, 
                                      Cap_biomass = Caproate/meantot,
                                      Hep_biomass = Heptanoate/meantot,
                                      Oct_biomass= Octanoic.acid/meantot,
                                      Isoval_biomass = Isovalerate/meantot, 
                                      Isobut_biomass = Isobutyrate/meantot
                                      ) 

df.1 <- subset(production_relative_biomass, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(production_relative_biomass, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(production_relative_biomass, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
production_relative_biomass <- test



production_relative_int_biomass <- mutate(netproduction, Acet_biomass = Acetate/meanINT,
                                      Prop_biomass = Propionate/meanINT,
                                      But_biomass = Butyrate/meanINT,
                                      total_SCFA = Acetate + Propionate + Butyrate, 
                                      Branched = Isovalerate + Isobutyrate,
                                      SCFA_biomass = total_SCFA/meanINT, 
                                      Branched_biomass = Branched/meanINT
                                      ) 


 # No correction for CH and biomass!
if(volcor1 == F){
  prod_biom <- production_relative_biomass
  prod_int <- production_relative_int_biomass
  met_CH <- metabolites_relative_carbohydrate
}else{met_load <- metabolites_relative_load}

}


production_relative_biomass <- prod_biom  
production_relative_int_biomass <- prod_int 
metabolites_relative_carbohydrate <- met_CH 
metabolites_relative_load <- met_load  

```

### Without carbs
```{r Net production without carbohydrates, include=F}

# CELL COUNTS
if(exists("by_nr") == F){by_nr <- read.csv("cellcounts.csv")} # Import cell counts
df.counts <- by_nr
# Start with bruto production
netproduction <- subset(df.counts, Ninetransit == 3)
netproduction$comb <- paste0(netproduction$Day, netproduction$Donor, netproduction$Transit, netproduction$Vessel)
# netproduction <- netproduction %>% group_by(comb) %>%
#     summarise(Donor = Donor, Transit = Transit, Vessel = Vessel, Day = Day, 
#               SDtot = sd(meantot), meantot = mean(meantot), SDint = sd(meanINT), meanint = mean(meanINT),
#               SDPer = sd(meanPER), meanperc = mean(meanPER))
netproduction <- netproduction[!duplicated(netproduction), ]
# Add reactor volumes, dosage rate and influent substrate concentration
test1 <- subset(netproduction, Vessel == "P" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test1$volume <- 0.200; test1$infldosage <- 0.600; test1$inflsubstrate <- (23.4*0.04666666666667)/0.2
test2 <- subset(netproduction, Vessel == "P" & Transit == "MT") # 94 mL of 23.4g/L medium per 200 mL influent
test2$volume <- 0.400; test2$infldosage <- 0.600; test2$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test3 <- subset(netproduction, Vessel == "P" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test3$volume <- 0.600; test3$infldosage <- 0.600; test3$inflsubstrate <- (23.4*0.14)/0.2
test4 <- subset(netproduction, Vessel == "D" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test4$volume <- 0.325; test4$infldosage <- 0.600; test4$inflsubstrate <- (23.4*0.0466666666666667)/0.2
test5 <- subset(netproduction, Vessel == "D" & Transit == "MT") # 93 mL of 23.4g/L medium per 200 mL influent
test5$volume <- 0.650; test5$infldosage <- 0.600; test5$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test6 <- subset(netproduction, Vessel == "D" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test6$volume <- 0.975; test6$infldosage <- 0.600; test6$inflsubstrate <- (23.4*0.14)/0.2
netprodP <- rbind(test1, test2, test3); netprodP<- netprodP[order(netprodP$comb), ]  
netprodD <- rbind(test4, test5, test6); netprodD<- netprodD[order(netprodD$comb), ] 

# Net production
volcorr = T #Needs to be corrected for nutrient load!
if(volcorr == T){netprodP1  <- subset(netprodP,select=c(SDtot:meanPER))*(600/1000)*(1/netprodP$volume)
 }else{netprodP1  <- subset(netprodP,select=c(SDtot:meanPER))*(600/1000)}
 netprodPnet <- cbind(subset(netprodP,select=c(Nr)),
                       netprodP1, subset(netprodP,select=c(Donor:inflsubstrate)))
 ## distal net production
 if(volcorr == T){netprodD1  <- (subset(netprodD,select=c(SDtot:meanPER))-subset(netprodP,
      select=c(SDtot:meanPER)))*(600/1000)*(1/netprodD$volume)
 }else{netprodD1 <- (subset(netprodD,select=c(SDtot:meanPER))-subset(netprodP, 
                                                            select=c(SDtot:meanPER)))*(600/1000)}
 netprodDnet <- cbind(subset(netprodD,select=c(Nr)),
                       netprodD1, subset(netprodD,select=c(Donor:inflsubstrate)))
  netproduction.counts <- rbind(netprodPnet, netprodDnet)
  
  
# Start with bruto production
netproduction <- functdatabruto

# Add reactor volumes, dosage rate and influent substrate concentration
test1 <- subset(netproduction, Vessel == "P" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test1$volume <- 0.200; test1$infldosage <- 0.600; test1$inflsubstrate <- (23.4*0.04666666666667)/0.2
test2 <- subset(netproduction, Vessel == "P" & Transit == "MT") # 94 mL of 23.4g/L medium per 200 mL influent
test2$volume <- 0.400; test2$infldosage <- 0.600; test2$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test3 <- subset(netproduction, Vessel == "P" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test3$volume <- 0.600; test3$infldosage <- 0.600; test3$inflsubstrate <- (23.4*0.14)/0.2
test4 <- subset(netproduction, Vessel == "D" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test4$volume <- 0.325; test4$infldosage <- 0.600; test4$inflsubstrate <- (23.4*0.0466666666666667)/0.2
test5 <- subset(netproduction, Vessel == "D" & Transit == "MT") # 93 mL of 23.4g/L medium per 200 mL influent
test5$volume <- 0.650; test5$infldosage <- 0.600; test5$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test6 <- subset(netproduction, Vessel == "D" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test6$volume <- 0.975; test6$infldosage <- 0.600; test6$inflsubstrate <- (23.4*0.14)/0.2
netprodP <- rbind(test1, test2, test3)
netprodD <- rbind(test4, test5, test6)

# Net production
# volcorr = F # Needs to be corrected for load!
if(volcorr == T){netprodP1  <- subset(netprodP,select=c(Acetate:Lactate))*(600/1000)*(1/netprodP$volume)
 }else{netprodP1  <- subset(netprodP,select=c(Acetate:Lactate))*(600/1000)}
 netprodPnet <- cbind(subset(netprodP,select=c(Samplenumber:Transitnumber)),
                       netprodP1, subset(netprodP,select=c(Intact_cells_events.ml:inflsubstrate)))
 
 ## distal net production
 if(volcorr == T){netprodD1  <- (subset(netprodD,select=c(Acetate:Lactate))-subset(netprodP,
      select=c(Acetate:Lactate)))*(600/1000)*(1/netprodD$volume)
 }else{netprodD1 <- (subset(netprodD,select=c(Acetate:Lactate))-subset(netprodP, 
                                                            select=c(Acetate:Lactate)))*(600/1000)}
 netprodDnet <- cbind(subset(netprodD,select=c(Samplenumber:Transitnumber)),
                       netprodD1, subset(netprodD,select=c(Intact_cells_events.ml:inflsubstrate)))
  netproduction <- rbind(netprodPnet, netprodDnet)
if(volcorr == F){write.csv(netproduction,"netSCFAproduction.csv")}
# Calculate load (g/d) = influent substrate conc * influent dosage
netproduction$load <- netproduction$inflsubstrate*netproduction$infldosage
unique(subset(netproduction, Vessel == "P")$load)
# Calculate volumetric loading rate (g/Lr/d) = load (g/d) / reactor volume (Lr)
netproduction$volloadrate <- netproduction$load/netproduction$volume
unique(subset(netproduction, Vessel == "P")$volloadrate)
# Assume 100% conversion efficiency and assume that the substrate goes completely to product
# Concentration in vessel is the concentration of the SCFA
# Take only the stabilised communities and add cell counts
netproduction <- subset(netproduction, Ninetransit == 3)
netproduction <-  merge(netproduction, netproduction.counts[, c("Nr", "SDtot", "meantot", "meanINT", "SDINT")], by.x = "Samplenumber",by.y="Nr", all.x=F)
# Biomass estimate relative to nutrient load
netprod <- subset(netproduction, select = c(Samplenumber, Date, Day, Transit, Donor, Vessel, Ninetransit, Acetate, Propionate, Butyrate, load, Valerate, Caproate, Heptanoate, Isovalerate , Isobutyrate, Octanoic.acid))
metabolites_relative_load <- mutate(netprod, Acet_load = Acetate/load,
                        Prop_load =Propionate/load, Buty_load =Butyrate/load, 
                        Val_load = Valerate/load, Cap_load = Caproate/load,
                        Hep_load = Heptanoate/load, Oct_load = Octanoic.acid/load,
                        Isoval_load = Isovalerate/load, Isobut_load = Isobutyrate/load,
                        SCFA_load = Acet_load + Prop_load + Buty_load)
metabolites_relative_load <- subset(metabolites_relative_load, Vessel == "P")
df.1 <- subset(metabolites_relative_load, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(metabolites_relative_load, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(metabolites_relative_load, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
metabolites_relative_load <- test
# Production relative to biomass estimate
production_relative_biomass <- mutate(netproduction, Acet_biomass = Acetate/meantot,
                                      Prop_biomass = Propionate/meantot,
                                      But_biomass = Butyrate/meantot,
                                      total_SCFA = Acetate + Propionate + Butyrate,
                                      Branched = Isovalerate + Isobutyrate,
                                      SCFA_biomass = total_SCFA/meantot, 
                                      Branched_biomass = Branched/meantot,
                                      Val_biomass = Valerate/meantot, 
                                      Cap_biomass = Caproate/meantot,
                                      Hep_biomass = Heptanoate/meantot,
                                      Oct_biomass= Octanoic.acid/meantot,
                                      Isoval_biomass = Isovalerate/meantot, 
                                      Isobut_biomass = Isobutyrate/meantot
                                      ) 
df.1 <- subset(production_relative_biomass, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(production_relative_biomass, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(production_relative_biomass, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
production_relative_biomass <- test
production_relative_int_biomass <- mutate(netproduction, Acet_biomass = Acetate/meanINT,
                                      Prop_biomass = Propionate/meanINT,
                                      But_biomass = Butyrate/meanINT,
                                      total_SCFA = Acetate + Propionate + Butyrate, 
                                      Branched = Isovalerate + Isobutyrate,
                                      SCFA_biomass = total_SCFA/meanINT, 
                                      Branched_biomass = Branched/meanINT
                                      ) 
```



# Statistics
## Statistical data analysis - non parametric - biomass - no volume correction!
```{r Kruskal-Wallis - biomass, fig.height=18, fig.width=18}
df <- production_relative_biomass
df <- group_by_at(df, vars(Transit, Vessel))
df <- summarise_at(df, vars(Acet_biomass,  Prop_biomass, But_biomass,total_SCFA ), funs(sd, mean), na.rm = T)

# Non parametric to 1-way ANOVA, alternative - Kruskal-Wallis
correction = "bonferroni"
correction = "holm"
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message("Kruskal-Wallis tests between transit times")
for (metabolite in c("Acet_biomass", "Prop_biomass", "But_biomass", "SCFA_biomass",
                     "Branched_biomass", "Val_biomass", "Cap_biomass", "Hep_biomass",
                      "Isoval_biomass", "Isobut_biomass")) {
for (i in c("P", "D")) {
  my_data <- subset(production_relative_biomass, Vessel == i)
  my_data$Transit <- as.ordered(factor(my_data$Transit,levels=c("ST","MT","LT")))
    levels(my_data$Transit)
  # if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(eval(parse(text = metabolite)) ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
     effsize2 <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Donor)
    if(effsize2$effsize>0.13){
      effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize2$effsize>0.06){
      effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
        
        
        effsize2 <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ ivTransit)
    if(effsize2$effsize>0.13){
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize2$effsize>0.06){
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (moderate effect size is detected)")
    }else{
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
        
        
  # effsize2 <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Vessel)
  #   if(effsize2$effsize2>0.13){
  #     effsize <- paste0(effsize2,"\n, effsize for vessel = ", signif(effsize2$effsize2, digits = 5)," (large effect size is detected)")
  #   }else{if(effsize2$effsize>0.06){
  #     effsize <- paste0(effsize2,"\n, effsize for vessel = ", signif(effsize2$effsize2, digits = 5)," (moderate effect size is detected)")
  #   }else{effsize <- paste0(effsize2,"\n, effsize for vessel = ", signif(effsize2$effsize2, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    if(metabolite == "Acet_biomass"){pwc <- wilcox_test(my_data2, Acet_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Prop_biomass"){pwc <- wilcox_test(my_data2, Prop_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "But_biomass"){pwc <- wilcox_test(my_data2, But_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "SCFA_biomass"){pwc <- wilcox_test(my_data2, SCFA_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Branched_biomass"){pwc <- wilcox_test(my_data2, Branched_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    
    
    if(metabolite == "Oct_biomass"){pwc <- wilcox_test(my_data2, Oct_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isoval_biomass"){pwc <- wilcox_test(my_data2, Isoval_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isobut_biomass"){pwc <- wilcox_test(my_data2, Isobut_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Hep_biomass"){pwc <- wilcox_test(my_data2, Hep_biomass ~ Transit, p.adjust.method = correction, paired = F)}
        if(metabolite == "Cap_biomass"){pwc <- wilcox_test(my_data2, Cap_biomass ~ Transit, p.adjust.method = correction, paired = F)}
        if(metabolite == "Val_biomass"){pwc <- wilcox_test(my_data2, Val_biomass ~ Transit, p.adjust.method = correction, paired = F)}
    
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ", i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = metabolite) +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0(metabolite, ", ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1
}
  } 
ggarrange(plotlist = gglist, nrow = 5, ncol = 2)




# Between colon vessels
gglist1 <- list(); x = 1; df.pwc1 <- data.frame()
message("Kruskal-Wallis tests between colon vessels")
for (metabolite in c("Acet_biomass", "Prop_biomass", "But_biomass", "SCFA_biomass",
                     "Branched_biomass", "Val_biomass", "Cap_biomass", 
                     # "Hep_biomass",
                     "Isoval_biomass", "Isobut_biomass")) {
for (i in c("ST", "MT", "LT")) {
  my_data <- subset(production_relative_biomass, Transit == i)
  my_data <- subset(my_data, Samplenumber != 115)
  my_data$Vessel <- as.ordered(factor(my_data$Vessel,levels=c("P","D")))
    levels(my_data$Vessel)
  if(i == "ST"){i = "Short transit"}; if(i == "MT"){i = "Medium transit"}; if(i == "LT"){i = "Long transit"}
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(eval(parse(text = metabolite)) ~ Vessel)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Vessel)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    if(metabolite == "Acet_biomass"){pwc <- wilcox_test(my_data2, Acet_biomass ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Prop_biomass"){pwc <- wilcox_test(my_data2, Prop_biomass ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "But_biomass"){pwc <- wilcox_test(my_data2, But_biomass ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "SCFA_biomass"){pwc <- wilcox_test(my_data2, SCFA_biomass ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Branched_biomass"){pwc <- wilcox_test(my_data2, Branched_biomass ~ Vessel, p.adjust.method = correction, paired = T)}
    
    if(metabolite == "Oct_biomass"){pwc <- wilcox_test(my_data2, Oct_biomass ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isoval_biomass"){pwc <- wilcox_test(my_data2, Isoval_biomass ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isobut_biomass"){pwc <- wilcox_test(my_data2, Isobut_biomass ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Hep_biomass"){pwc <- wilcox_test(my_data2, Hep_biomass ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Cap_biomass"){pwc <- wilcox_test(my_data2, Cap_biomass ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Val_biomass"){pwc <- wilcox_test(my_data2, Val_biomass ~ Vessel, p.adjust.method = correction, paired = F)}
    
    pwc <- subset(pwc, p != "ns")
    pwc$Transit <- i; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ", i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Vessel")
    gglist1[[x]]<- ggboxplot(my_data2, x = "Vessel", y = metabolite) +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0(metabolite, ", ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1
}
  } 
ggarrange(plotlist = gglist1, nrow = 5, ncol = 3)


View(df.pwc); View(df.pwc1)



rm(pwc, effsize, gglist,res.kruskal,my_data2)
```

## Statistical data analysis - non parametric - load - volume has to be corrected!!
```{r Kruskal-Wallis - nutrient load, fig.height=18, fig.width=18, include=FALSE}
if(volcorr == T){{write.csv(metabolites_relative_load,"SCFA_load.csv")}}
# Non parametric to 1-way ANOVA, alternative - Kruskal-Wallis
correction = "bonferroni"
correction = "holm"
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message("Kruskal-Wallis tests between transit times")
for (metabolite in c("Acet_load", "Prop_load", "Buty_load", "SCFA_load", 
                     "Val_load", "Cap_load", "Hep_load",
                      "Isoval_load", "Isobut_load")) {

  i = "P"
  my_data <- subset(metabolites_relative_load, Vessel == i)
  my_data$Transit <- as.ordered(factor(my_data$Transit,levels=c("ST","MT","LT")))
    levels(my_data$Transit)
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(eval(parse(text = metabolite)) ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    
            effsize2 <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Donor)
    if(effsize2$effsize>0.13){
      effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize2$effsize>0.06){
      effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
        
        
        effsize2 <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ ivTransit)
    if(effsize2$effsize>0.13){
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize2$effsize>0.06){
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (moderate effect size is detected)")
    }else{
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (WARNING: low effect size is detected)")
      }
      }
        

    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    if(metabolite == "Acet_load"){pwc <- wilcox_test(my_data2, Acet_load ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Prop_load"){pwc <- wilcox_test(my_data2, Prop_load ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Buty_load"){pwc <- wilcox_test(my_data2, Buty_load ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "SCFA_load"){pwc <- wilcox_test(my_data2, SCFA_load ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Branched_load"){pwc <- wilcox_test(my_data2, Branched_load ~ Transit, p.adjust.method = correction, paired = F)}

    # print(pwc) # print pairwise comparisons
    
      
    
    
     if(metabolite == "Oct_load"){pwc <- wilcox_test(my_data2, Oct_load ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isoval_load"){pwc <- wilcox_test(my_data2, Isoval_load ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isobut_load"){pwc <- wilcox_test(my_data2, Isobut_load ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Hep_load"){pwc <- wilcox_test(my_data2, Hep_load ~ Transit, p.adjust.method = correction, paired = F)}
        if(metabolite == "Cap_load"){pwc <- wilcox_test(my_data2, Cap_load ~ Transit, p.adjust.method = correction, paired = F)}
        if(metabolite == "Val_load"){pwc <- wilcox_test(my_data2, Val_load ~ Transit, p.adjust.method = correction, paired = F)}
    
        pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; df.pwc <- rbind(df.pwc, pwc)
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ", i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = metabolite) +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0(metabolite, ", ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1

  } 
ggarrange(plotlist = gglist, nrow = 5, ncol = 2)



View(df.pwc)
rm(pwc, effsize, gglist,res.kruskal,my_data2)
```


## Statistical data analysis - non parametric - carbohydrates - no volume correction!!
```{r Kruskal-Wallis - carbohydrates, fig.height=9, fig.width=18}

averages <- metabolites_relative_carbohydrate
# averages <- subset(averages, Donor == 5)
averages <- group_by_at(averages, vars(Transit, Vessel))
averages <- summarise_at(averages, vars(Acet_CH, Prop_CH, Buty_CH, SCFA_CH), funs(sd, mean), na.rm = T)


# Highest values of donors
averages2 <- metabolites_relative_carbohydrate
averages2 <- group_by_at(averages2, vars(Transit, Vessel, Donor))
averages2 <- summarise_at(averages2, vars(Acet_CH, Prop_CH, Buty_CH, SCFA_CH), funs(sd, mean), na.rm = T)
ave <- data.frame()
for(donor in c(1:6)){
  av <- subset(averages2, Donor == donor)
  av <- ungroup(av)
  av <- data.table::as.data.table(av)
  av1 <- av[, high := Acet_CH_mean==max(Acet_CH_mean), by=Vessel]; av1 <- subset(av1, high == TRUE)
  av2 <- av[, high := Prop_CH_mean==max(Prop_CH_mean), by=Vessel]; av2 <- subset(av2, high == TRUE)
  av3 <- av[, high := Buty_CH_mean==max(Buty_CH_mean), by=Vessel]; av3 <- subset(av3, high == TRUE)
  av4 <- av[, high := SCFA_CH_mean==max(SCFA_CH_mean), by=Vessel]; av4 <- subset(av4, high == TRUE)
 
  av5 <- data.frame(donor = donor, colon = av1$Vessel, 
                    acet_transit = av1$Transit, prop_transit = av2$Transit, 
                   buty_transit = av3$Transit, SCFA_transit = av4$Transit, 
                    Acet = av1$Acet_CH_mean, Acet_SD = av1$Acet_CH_sd,
                    Prop = av2$Prop_CH_mean, Prop_SD = av2$Prop_CH_sd,
                    Buty = av3$Buty_CH_mean, Buty_SD = av3$Buty_CH_sd,
                    SCFA = av4$SCFA_CH_mean, SCFA_SD = av4$SCFA_CH_sd)
  ave<- rbind(ave, av5)
}


metabolites_relative_carbohydrate <- subset(metabolites_relative_carbohydrate, Samplenumber != 288)
if(volcorr == F){{write.csv(metabolites_relative_carbohydrate,"SCFA_Carbohydrates.csv")}}
# Non parametric to 1-way ANOVA, alternative - Kruskal-Wallis
correction = "bonferroni"
correction = "holm"
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message("Kruskal-Wallis tests between transit times")
for (metabolite in c("Acet_CH", "Prop_CH", "Buty_CH", "SCFA_CH", 
                     "Val_CH", "Cap_CH", "Hep_CH",
                      "Isoval_CH", "Isobut_CH")) {

  for(i in c("P", "D")){
  my_data <- subset(metabolites_relative_carbohydrate, Vessel == i)
  my_data$Transit <- as.ordered(factor(my_data$Transit,levels=c("ST","MT","LT")))
    levels(my_data$Transit)
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(eval(parse(text = metabolite)) ~ Transit)
    print(res.kruskal[1,5])
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    
            effsize2 <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Donor)
    if(effsize2$effsize>0.13){
      effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize2$effsize>0.06){
      effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(effsize,"\n, effsize for donor = ", signif(effsize2$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
        
        
        effsize2 <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ ivTransit)
    if(effsize2$effsize>0.13){
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize2$effsize>0.06){
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (moderate effect size is detected)")
    }else{
      effsize <- paste0(effsize,"\n, effsize for IV = ", signif(effsize2$effsize, digits = 5)," (WARNING: low effect size is detected)")
      }
      }
        

    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    if(metabolite == "Acet_CH"){pwc <- wilcox_test(my_data2, Acet_CH ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Prop_CH"){pwc <- wilcox_test(my_data2, Prop_CH ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Buty_CH"){pwc <- wilcox_test(my_data2, Buty_CH ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "SCFA_CH"){pwc <- wilcox_test(my_data2, SCFA_CH ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Branched_CH"){pwc <- wilcox_test(my_data2, Branched_CH ~ Transit, p.adjust.method = correction, paired = F)}

    # print(pwc) # print pairwise comparisons
    
      
    
    
     if(metabolite == "Oct_CH"){pwc <- wilcox_test(my_data2, Oct_CH ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isoval_CH"){pwc <- wilcox_test(my_data2, Isoval_CH ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isobut_CH"){pwc <- wilcox_test(my_data2, Isobut_CH ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Hep_CH"){pwc <- wilcox_test(my_data2, Hep_CH ~ Transit, p.adjust.method = correction, paired = F)}
        if(metabolite == "Cap_CH"){pwc <- wilcox_test(my_data2, Cap_CH ~ Transit, p.adjust.method = correction, paired = F)}
        if(metabolite == "Val_CH"){pwc <- wilcox_test(my_data2, Val_CH ~ Transit, p.adjust.method = correction, paired = F)}
    
        pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; df.pwc <- rbind(df.pwc, pwc)
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ", i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = metabolite) +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0(metabolite, ", ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1

  }} 
ggarrange(plotlist = gglist, nrow = 2, ncol = 2)







# Between colon vessels
gglist1 <- list(); x = 1; df.pwc1 <- data.frame()
message("Kruskal-Wallis tests between colon vessels")
for (metabolite in c("Acet_CH", "Prop_CH", "Buty_CH", "SCFA_CH",
                      "Val_CH", "Cap_CH", 
                     "Hep_CH",
                     "Isoval_CH", "Isobut_CH")) {
for (i in c("ST", "MT", "LT")) {
  my_data <- subset(metabolites_relative_carbohydrate, Transit == i)
  my_data <- subset(my_data, Samplenumber != 115)
  my_data <- subset(my_data, Samplenumber != 287)
  my_data$Vessel <- as.ordered(factor(my_data$Vessel,levels=c("P","D")))
    levels(my_data$Vessel)
  if(i == "ST"){i = "Short transit"}; if(i == "MT"){i = "Medium transit"}; if(i == "LT"){i = "Long transit"}
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(eval(parse(text = metabolite)) ~ Vessel)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Vessel)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    if(metabolite == "Acet_CH"){pwc <- wilcox_test(my_data2, Acet_CH ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Prop_CH"){pwc <- wilcox_test(my_data2, Prop_CH ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Buty_CH"){pwc <- wilcox_test(my_data2, Buty_CH ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "SCFA_CH"){pwc <- wilcox_test(my_data2, SCFA_CH ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Branched_CH"){pwc <- wilcox_test(my_data2, Branched_CH ~ Vessel, p.adjust.method = correction, paired = T)}
    
    if(metabolite == "Oct_CH"){pwc <- wilcox_test(my_data2, Oct_CH ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isoval_CH"){pwc <- wilcox_test(my_data2, Isoval_CH ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isobut_CH"){pwc <- wilcox_test(my_data2, Isobut_CH ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Hep_CH"){pwc <- wilcox_test(my_data2, Hep_CH ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Cap_CH"){pwc <- wilcox_test(my_data2, Cap_CH ~ Vessel, p.adjust.method = correction, paired = F)}
    if(metabolite == "Val_CH"){pwc <- wilcox_test(my_data2, Val_CH ~ Vessel, p.adjust.method = correction, paired = F)}
    
    pwc <- subset(pwc, p != "ns")
    pwc$Transit <- i; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ", i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Vessel")
    gglist1[[x]]<- ggboxplot(my_data2, x = "Vessel", y = metabolite) +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0(metabolite, ", ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1
}
  } 
ggarrange(plotlist = gglist1, nrow = 2, ncol = 3)



View(df.pwc)
rm(pwc, effsize, gglist,res.kruskal,my_data2)
```





## Donors separately - DOES NOT WORK!
### Statistical data analysis - parametric
```{r two-way ANOVA, fig.height=18, fig.width=18}
my_data <- subset(functdata, Vessel == "P"); my_data <- subset(my_data, Ninetransit == 3)
my_data$Donor <- as.ordered(factor(my_data$Donor,levels=c(1,2,3,4,5,6)))
# Show a random sample
set.seed(1234)
dplyr::sample_n(my_data, 10)

# Check the structure
str(my_data)

# Generate frequency tables
table(my_data$Donor, my_data$Transit)

# Visualization
ggboxplot(my_data, x = "Donor", y = "Acetate", color = "Transit",
          palette = transitcolors)

ggline(my_data, x = "Donor", y = "Acetate", color = "Transit",
       add = c("mean_se", "dotplot"),
       palette = transitcolors)

# Two-way interaction plot
interaction.plot(x.factor = my_data$Donor, trace.factor = my_data$Transit, 
                 response = my_data$Acetate, fun = mean, 
                 type = "b", legend = TRUE, 
                 xlab = "Donor", ylab="TotalpermL",
                 pch=c(1,19), col = transitcolors)

# Compute 2 way ANOVA
res.aov2 <- aov(Acetate ~ Transit + Donor, data = my_data)
summary(res.aov2)


# Two-way ANOVA with interaction effect
# These two calls are equivalent
res.aov3 <- aov(Acetate ~ Transit * Donor, data = my_data)
summary(res.aov3)

# Post-hoc: Tukey multiple pairwise-comparisons
TukeyHSD(res.aov3, which = "Donor")
TukeyHSD(res.aov3, which = "Transit")


# Assumptions
# 1. Homogeneity of variances
plot(res.aov3, 1)

## Levene's test, p has to be LARGER than 0.05!
car::leveneTest(Acetate ~ Transit * Donor, data = my_data)

# 2. Normality, all the points have to fall approximately along this reference line to assume normality
plot(res.aov3, 2)

## Extract the residuals
aov_residuals <- residuals(object = res.aov3)
## Run Shapiro-Wilk test, H0: a variable is normally distributed in some population. Reject the null hypothesis if p < 0.05
t <- shapiro.test(x = aov_residuals); if(t[["p.value"]]<0.05){
  message(crayon::red(paste0("p=", t[["p.value"]],", Data is not normally distributed!")))} else{
    message(crayon::green("Data is normally distributed"))}
```

### Statistical data analysis - non parametric
```{r Kruskal-Wallis - donors separately, fig.height=18, fig.width=18}
# Non parametric to 1-way ANOVA, alternative - Kruskal-Wallis
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message("Kruskal-Wallis tests between transit times")
for (i in c("P", "D")) {
  my_data <- subset(functdatanet, Vessel == i); my_data <- subset(my_data, Ninetransit == 3)
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
  for (j in c(1,2,3,4,5,6)) {
    my_data2 <- subset(my_data, Donor == j)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(Acetate ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(Acetate ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    pwc <- my_data2 %>% wilcox_test(Acetate ~ Transit, p.adjust.method = "bonferroni", paired = F)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Donor ",j,", ",i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Donor ",j,", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = "Acetate") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}
}; ggarrange(plotlist = gglist, nrow = 4, ncol = 3)


# Between donors
gglist <- list(); x = 1; df.pwc1 <- data.frame()
message("Kruskal-Wallis tests with bonferroni correction between donors")
for (i in c("P", "D")) {
  my_data <- subset(functdatanet, Vessel == i); my_data <- subset(my_data, Ninetransit == 3);
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
  for (j in c("ST", "MT", "LT")) {
    my_data2 <- subset(my_data, Transit == j)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(Acetate ~ Donor)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(Acetate ~ Donor)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){ 
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(Acetate ~ Donor, p.adjust.method = "bonferroni")
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Transit ",j,", ",i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Transit ",j,", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Donor")
    gglist[[x]]<- ggboxplot(my_data2, x = "Donor", y = "Acetate") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Transit ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}
};  ggarrange(plotlist = gglist, nrow = 2, ncol = 3)

View(df.pwc); View(df.pwc1)


rm(pwc, effsize, gglist,res.kruskal,my_data2)
```

## Between transits. Donors combined
### Statistical data analysis - parametric
```{r one-way ANOVA, fig.height=18, fig.width=18}
my_data <- subset(functdata, Vessel == "P"); my_data <- subset(my_data, Ninetransit == 3)
my_data$Donor <- as.ordered(factor(my_data$Donor,levels=c(1,2,3,4,5,6)))
# Show a random sample
set.seed(1234)
dplyr::sample_n(my_data, 10)

# Check the structure
str(my_data)

# Show the levels
levels(my_data$Transit)

# Generate frequency tables
table(my_data$Donor, my_data$Transit)

# Visualization
ggboxplot(my_data, x = "Transit", y = "Acetate", color = "Transit",
          palette = transitcolors)

ggline(my_data, x = "Transit", y = "Acetate", color = "Transit",
       add = c("mean_se", "dotplot"),
       palette = transitcolors)

# Plotmeans
gplots::plotmeans(Acetate ~ Transit, data = my_data, frame = FALSE,
          xlab = "Transit", ylab = "Acetate (mM)",
          main="Mean Plot with 95% CI") 


# Compute the analysis of variance
res.aov <- aov(Acetate ~ Transit, data = my_data)
summary(res.aov)


# Post-hoc: Tukey multiple pairwise-comparisons
TukeyHSD(res.aov)


# Assumptions
# 1. Homogeneity of variances
plot(res.aov3, 1)

## Levene's test, p has to be LARGER than 0.05!
car::leveneTest(Acetate ~ Transit, data = my_data)

# 2. Normality, all the points have to fall approximately along this reference line to assume normality
plot(res.aov, 2)

## Extract the residuals
aov_residuals <- residuals(object = res.aov)
## Run Shapiro-Wilk test, H0: a variable is normally distributed in some population. Reject the null hypothesis if p < 0.05
t <- shapiro.test(x = aov_residuals); if(t[["p.value"]]<0.05){
  message(crayon::red(paste0("p=", t[["p.value"]],", Data is not normally distributed!")))} else{
    message(crayon::green("Data is normally distributed"))}
```

### Statistical data analysis - non parametric
```{r Kruskal-Wallis - between transits and donors combined, fig.height=18, fig.width=18}
# Non parametric to 1-way ANOVA, alternative - Kruskal-Wallis
correction = "bonferroni"
correction = "holm"
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message("Kruskal-Wallis tests between transit times")
for (metabolite in c("Acetate", "Propionate", "Butyrate", "total_SCFA", "Branched",
                     "Isobutyrate", "Isovalerate", "Valerate", 
                     "Caproate", "Heptanoate")) {
for (i in c("P", "D")) {
  my_data <- subset(functdatanet, Vessel == i); my_data <- subset(my_data, Ninetransit == 3)
  my_data$Transit <- as.ordered(factor(my_data$Transit,levels=c("ST","MT","LT")))
    levels(my_data$Transit)
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(eval(parse(text = metabolite)) ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    if(metabolite == "Acetate"){pwc <- wilcox_test(my_data2, Acetate ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Propionate"){pwc <- wilcox_test(my_data2, Propionate ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Butyrate"){pwc <- wilcox_test(my_data2, Butyrate ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "total_SCFA"){pwc <- wilcox_test(my_data2, total_SCFA ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Branched"){pwc <- wilcox_test(my_data2, Branched ~ Transit, p.adjust.method = correction, paired = F)}
    
    
        if(metabolite == "Isobutyrate"){pwc <- wilcox_test(my_data2, Isobutyrate ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Isovalerate"){pwc <- wilcox_test(my_data2, Isovalerate ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Valerate"){pwc <- wilcox_test(my_data2, Valerate ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Caproate"){pwc <- wilcox_test(my_data2, Caproate ~ Transit, p.adjust.method = correction, paired = F)}
    if(metabolite == "Heptanoate"){pwc <- wilcox_test(my_data2, Heptanoate ~ Transit, p.adjust.method = correction, paired = F)}
    
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ", i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = metabolite) +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0(metabolite, ", ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1
}
  } 
ggarrange(plotlist = gglist, nrow = 5, ncol = 2)




# Between colon vessels
gglist1 <- list(); x = 1; df.pwc1 <- data.frame()
message("Kruskal-Wallis tests between colon vessels")
for (metabolite in c("Acetate", "Propionate", "Butyrate", "total_SCFA", "Branched",
                     "Isobutyrate", "Isovalerate", "Valerate", 
                     "Caproate")) {
for (i in c("ST", "MT", "LT")) {
  my_data <- subset(functdatanet, Transit == i); my_data <- subset(my_data, Ninetransit == 3)
  my_data <- subset(my_data, Samplenumber != 115)
  my_data$Vessel <- as.ordered(factor(my_data$Vessel,levels=c("P","D")))
    levels(my_data$Vessel)
  if(i == "ST"){i = "Short transit"}; if(i == "MT"){i = "Medium transit"}; if(i == "LT"){i = "Long transit"}
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(eval(parse(text = metabolite)) ~ Vessel)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(eval(parse(text = metabolite)) ~ Vessel)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test, minimal sample size = 6!!:
    if(metabolite == "Acetate"){pwc <- wilcox_test(my_data2, Acetate ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Propionate"){pwc <- wilcox_test(my_data2, Propionate ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Butyrate"){pwc <- wilcox_test(my_data2, Butyrate ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "total_SCFA"){pwc <- wilcox_test(my_data2, total_SCFA ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Branched"){pwc <- wilcox_test(my_data2, Branched ~ Vessel, p.adjust.method = correction, paired = T)}
    
     if(metabolite == "Isobutyrate"){pwc <- wilcox_test(my_data2, Isobutyrate ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Isovalerate"){pwc <- wilcox_test(my_data2, Isovalerate ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Valerate"){pwc <- wilcox_test(my_data2, Valerate ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Caproate"){pwc <- wilcox_test(my_data2, Caproate ~ Vessel, p.adjust.method = correction, paired = T)}
    if(metabolite == "Heptanoate"){pwc <- wilcox_test(my_data2, Heptanoate ~ Vessel, p.adjust.method = correction, paired = T)}
    
    pwc <- subset(pwc, p != "ns")
    pwc$Transit <- i; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ", i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Metabolite = ",metabolite, ", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Vessel")
    gglist1[[x]]<- ggboxplot(my_data2, x = "Vessel", y = metabolite) +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0(metabolite, ", ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1
}
  } 
ggarrange(plotlist = gglist1, nrow = 5, ncol = 3)


View(df.pwc); View(df.pwc1)



rm(pwc, effsize, gglist,res.kruskal,my_data2)
```

### Averages and changes
```{r averages}
df <- functdatanet
df <- group_by_at(df, vars(Transit, Vessel))
df <- summarise_at(df, vars(Acetate, Propionate, Butyrate, NH4., Branched, total_SCFA, Lactate), funs(sd, mean), na.rm = T)
df <- subset(df, select = c("Transit", "Vessel","Acetate_mean", "Acetate_sd", "Propionate_mean", "Propionate_sd", "Butyrate_mean", 
                            "Butyrate_sd", "Branched_mean",  "Branched_sd", "total_SCFA_mean" ,   "total_SCFA_sd")) 
df[, 3:12] <- round(df[,3:12], digits = 2)

dfmean <- subset(df, select = c("Transit", "Vessel","Acetate_mean", "Propionate_mean", "Butyrate_mean", "Branched_mean", "total_SCFA_mean")) 
dfsd <- subset(df, select = c("Transit", "Vessel","Acetate_sd", "Propionate_sd", "Butyrate_sd", "Branched_sd", "total_SCFA_sd")) 
dfchanges <- data.frame(); dfchangesSD <- data.frame()
for (i in c("P", "D")) {
  # Means
  dfST <- subset(dfmean, Vessel == i& Transit == "ST"); dfMT <- subset(dfmean, Vessel == i& Transit == "MT")
  dfLT <- subset(dfmean, Vessel == i& Transit == "LT")
  dfSTLT <- dfLT[,3:7]- dfST[,3:7]; dfSTLT$Vessel <- i; dfSTLT$comb <- "STLT"
  dfSTMT <- dfMT[,3:7]- dfST[,3:7]; dfSTMT$Vessel <- i; dfSTMT$comb <- "STMT"
  dfMTLT <- dfLT[,3:7]- dfMT[,3:7]; dfMTLT$Vessel <- i; dfMTLT$comb <- "MTLT"
  dfchanges <- rbind(dfchanges, dfSTMT, dfMTLT, dfSTLT)
  
  # SD's
  dfST <- subset(dfsd, Vessel == i& Transit == "ST"); dfMT <- subset(dfsd, Vessel == i& Transit == "MT")
  dfLT <- subset(dfsd, Vessel == i& Transit == "LT")
  dfSTLT <- sqrt((dfLT[,3:7])^2+ (dfST[,3:7])^2); dfSTLT$Vessel <- i; dfSTLT$comb <- "STLT"
  dfSTMT <- sqrt((dfST[,3:7])^2+ (dfLT[,3:7])^2); dfSTMT$Vessel <- i; dfSTMT$comb <- "STMT"
  dfMTLT <- sqrt((dfLT[,3:7])^2+ (dfMT[,3:7])^2); dfMTLT$Vessel <- i; dfMTLT$comb <- "MTLT"
  dfchangesSD <- rbind(dfchangesSD, dfSTMT, dfMTLT, dfSTLT)
}
dfchanges <- cbind(dfchanges, dfchangesSD)
View(df); View(dfchanges)
```


# Plotting
## Faecal samples
```{r paperplot Faecal samples}
ggplot(subset(functdatanet, Vessel == "FS"), aes(x = Donor, y = Acetate, fill = Donor)) + geom_bar(stat = "identity") + scale_fill_manual(values = sixdonors)
ggplot(subset(functdatanet, Vessel == "FS"), aes(x = Donor, y = Propionate, fill = Donor)) + geom_bar(stat = "identity") + scale_fill_manual(values = sixdonors)
ggplot(subset(functdatanet, Vessel == "FS"), aes(x = Donor, y = Butyrate, fill = Donor)) + geom_bar(stat = "identity") + scale_fill_manual(values = sixdonors)
ggplot(subset(functdatanet, Vessel == "FS"), aes(x = Donor, y = total_SCFA, fill = Donor)) + geom_bar(stat = "identity") + scale_fill_manual(values = sixdonors)
```

## Bruto
```{r}
plotlist <- list()
df <- subset(functdatabruto, Ninetransit == 3)
df[c(9, 12)] <- replace(df[c(9, 12)], df[c(9, 12)] < 0, 0)
colons = F; xaxis = T; alfa = 0.5

# Acetate
max = max(df$Acetate); min = min(df$Acetate)
plot <- papertheme(ggplot(subset(df, Acetate >= 0), aes(x = Transit, y = Acetate, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Acetate >= 0), aes(x = Transit, y = Acetate, color = Donor), alpha = alfa) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs)) + 
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab("Acetate (mM)") + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(26,29,32, 15,18,21))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")

if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}; plotlist[[1]] <- plot
plot


# Propionate
max = max(df$Propionate); min = min(df$Propionate)
plot <- papertheme(ggplot(subset(df, Propionate >= 0), aes(x = Transit, y = Propionate, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Propionate >= 0), aes(x = Transit, y = Propionate, color = Donor), alpha = alfa) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs)) + 
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab("Propionate (mM)") + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(26,29,32, 15,18,21))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")

if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}; plotlist[[1]] <- plot
plot


# Butyrate
max = max(df$Butyrate); min = min(df$Butyrate)
plot <- papertheme(ggplot(subset(df, Butyrate >= 0), aes(x = Transit, y = Butyrate, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Butyrate >= 0), aes(x = Transit, y = Butyrate, color = Donor), alpha = alfa) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs)) + 
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab("Butyrate (mM)") + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(26,29,32, 15,18,21))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")

if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}; plotlist[[1]] <- plot
plot
```




# Figure S2 - Stabilisation + control period
```{r Paperplot Stabilisation and control, fig.height=16, fig.width=12}
if(BW == TRUE){
  color1 <- "#999999"
  color2 <- "#d6d6d6"
  color3 <- "lightgrey"
    
}else{
  color1 <- "#eeeeee"
  color2 <- "#e7e3f3"
  color3 <- "#D6E0F4"
}

# Place all columns below each other!
df <- subset(functdatabruto, Vessel != "FS")
df[c(9, 12)] <- replace(df[c(9, 12)], df[c(9, 12)] < 0, 0)

# add overlay options
dfST<- subset(df, Transit == "ST"); dfST$st <- 5.9; dfST$en <- 10.1
dfMT<- subset(df, Transit == "MT"); dfMT$st <- 10.9; dfMT$en <- 15.1
dfLT<- subset(df, Transit == "LT"); dfLT$st <- 14.9; dfLT$en <- 20.1
df <- rbind(dfST, dfMT, dfLT)
size = 3
ann_text <- data.frame(lbl = c(8,13,17.5), lbl1 = c(3,5.5,7.5), Transit = c("ST", "MT", "LT")); 
ann_text$Transit <- as.ordered(factor(ann_text$Transit, levels = c("ST", "MT", "LT", "FS")))

# Acetate
maxA = max(df$Acetate, na.rm = T); min = min(df$Acetate, na.rm=T) 
plot <- papertheme(ggplot(subset(df, Acetate > 0), aes(x = Day, y = Acetate, fill = Donor, color = Donor, shape = Donor))) + 
  facet_grid(cols = vars(Transit), rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs, Transit = Transit.labs) #, scales = "free_y"
             )+
  geom_rect(aes(xmin = st, xmax = en, ymin = -Inf, ymax = Inf), 
           fill = color1, alpha = 0.2, inherit.aes = FALSE) +
  # geom_text(data = ann_text,  mapping = aes(x = lbl, y = maxA, label = "Experimental"), size = size, inherit.aes = FALSE)+
   geom_rect(aes(xmin = 0, xmax = st, ymin = -Inf, ymax = Inf), 
           fill = color2, alpha = 0.2, inherit.aes = FALSE) 
  # geom_text(data = ann_text,  mapping = aes(x = lbl1, y = maxA, label = "Stabilisation"), size = size, inherit.aes = FALSE)+
if(BW == TRUE){
plot <- plot + 
    geom_point(size = 4, color = "black", alpha = 0.7)+
  scale_shape_manual(values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))+
  geom_line(color = "black") +
  scale_y_continuous(limits = c(0,86))}else{
    plot <- plot + geom_point()+ geom_line() +  
      scale_shape_manual(values=c("1" = 16, "2" = 16, "3" = 16 , "4" = 16, "5" = 16, "6" = 16))
  }

plot <- plot +
  # facet_grid(cols = vars(Transit), rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs, Transit = Transit.labs) #, scales = "free_y"
  #            ) + 
  theme(strip.background = element_rect(fill = color3)) +
  scale_color_manual(values = sixdonors) + 
  ylab("Acetate (mM)")+  xlab("Day") 

# Propionate
maxP = max(df$Propionate, na.rm=T); min = min(df$Propionate, na.rm=T)
plot1 <- papertheme(ggplot(subset(df, Propionate >= 0), aes(x = Day, y = Propionate, fill = Donor, color = Donor, shape = Donor))) + 
    geom_rect(aes(xmin = st, xmax = en, ymin = -Inf, ymax = Inf), 
           fill = color1, alpha = 0.2, inherit.aes = FALSE) +
  # geom_text(data = ann_text,  mapping = aes(x = lbl, y = maxP+3, label = "Experimental"), size = size, inherit.aes = FALSE)+
     geom_rect(aes(xmin = 0, xmax = st, ymin = -Inf, ymax = Inf), 
           fill = color2, alpha = 0.2, inherit.aes = FALSE) 
  # geom_text(data = ann_text,  mapping = aes(x = lbl1, y = maxP + 3, label = "Stabilisation"), size = size, inherit.aes = FALSE)+
if(BW == TRUE){
plot1 <- plot1 + 
    geom_point(size = 4, color = "black", alpha = 0.7)+
  scale_shape_manual(values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))+
  geom_line(color = "black") +
  scale_y_continuous(limits = c(0,86))}else{
    plot1 <- plot1 + geom_point()+ geom_line() +  
      scale_shape_manual(values=c("1" = 16, "2" = 16, "3" = 16 , "4" = 16, "5" = 16, "6" = 16))
  }

plot1 <- plot1 + scale_y_continuous(limits = c(0,45))+
  facet_grid(cols = vars(Transit), rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs, Transit = Transit.labs) #, scales = "free_y"
             ) + 
  theme(strip.background = element_rect(fill = color3)) +
  scale_color_manual(values = sixdonors) + 
  # ylab(expression(paste("Propionate (mM ",day^{"-1"}, ")"))) + 
  ylab("Propionate (mM)")+  xlab("Day")

# Butyrate
maxB = max(df$Butyrate, na.rm=T); min = min(df$Butyrate, na.rm=T)
plot2 <- papertheme(ggplot(subset(df, Butyrate >= 0), aes(x = Day, y = Butyrate, fill = Donor, color = Donor, shape = Donor))) +
  geom_rect(aes(xmin = st, xmax = en, ymin = -Inf, ymax = Inf), 
           fill = color1, alpha = 0.2, inherit.aes = FALSE) +
  # geom_text(data = ann_text,  mapping = aes(x = lbl, y = maxB-2, label = "Experimental"), size = size, inherit.aes = FALSE) +
     geom_rect(aes(xmin = 0, xmax = st, ymin = -Inf, ymax = Inf), 
           fill = color2,    alpha = 0.2, inherit.aes = FALSE) 
  # geom_text(data = ann_text,  mapping = aes(x = lbl1, y = maxB+2, label = "Stabilisation"), size = size, inherit.aes = FALSE)+
if(BW == TRUE){
plot2 <- plot2 + 
    geom_point(size = 4, color = "black", alpha = 0.7)+
  scale_shape_manual(values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))+
  geom_line(color = "black") +
  scale_y_continuous(limits = c(0,86))}else{
    plot2 <- plot2 + geom_point()+ geom_line() +  
      scale_shape_manual(values=c("1" = 16, "2" = 16, "3" = 16 , "4" = 16, "5" = 16, "6" = 16))
  }

plot2 <- plot2 +
  facet_grid(cols = vars(Transit), rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs, Transit = Transit.labs) #, scales = "free_y"
             ) + 
  theme(strip.background = element_rect(fill = color3)) +
  scale_color_manual(values = sixdonors) + 
  # ylab(expression(paste("Butyrate (mM ",day^{"-1"}, ")"))) + 
  ylab("Butyrate (mM)")+  xlab("Day")+scale_y_continuous(limits = c(0,25))

ggarrange(plot, plot1, plot2, nrow = 3, common.legend = T, legend = "bottom", labels = "AUTO", font.label = list(size =20))
 

# saveplots()
# ggsave(plot = plot2, width = 20, height = 15, dpi = 100, filename = "paperplot_vfa_stabilisation_comboplot.tiff")
```


```{r changes, fig.height=10, fig.width=15}
# Place all columns below each other!

df <- subset(functdata, Vessel != "FS")
df[c(9, 12)] <- replace(df[c(9, 12)], df[c(9, 12)] < 0, 0)
df <- subset(df, Donor == 2)
df$Vessel <- as.ordered(factor(df$Vessel, levels = c("P", "D")))
df$Transit <- as.ordered(factor(df$Transit, levels = c("ST", "MT", "LT")))

# Acetate
max = max(df$Acetate); min = min(df$Acetate)
plot <- papertheme(ggplot(subset(df, Acetate > 0), aes(x = as.numeric(Day), y = as.numeric(Acetate), fill = Donor, color = Donor)) + geom_point())+ geom_line() + 
  facet_grid(cols = vars(Transit), rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs, Transit = Transit.labs), scales = "free") +scale_x_continuous(breaks = seq(0,20,by=2))+
  theme(strip.background = element_rect(fill = "#D6E0F4")) +
  ylab(expression(paste("Acetate (mM ",day^{"-1"}, ")"))) + xlab("Day")
plot

# Propionate
max = max(df$Propionate); min = min(df$Propionate)
plot1 <- papertheme(ggplot(subset(df, Propionate >= 0), aes(x = as.numeric(Day), y = as.numeric(Propionate), fill = Donor, color = Donor)) + geom_point())+ geom_line() +
  facet_grid(cols = vars(Transit), rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs, Transit = Transit.labs), scales = "free") + scale_x_continuous(breaks = seq(0,20,by=2))+
  theme(strip.background = element_rect(fill = "#D6E0F4")) +
  ylab(expression(paste("Propionate (mM ",day^{"-1"}, ")"))) + xlab("Day")
plot1

# Butyrate
max = max(df$Butyrate); min = min(df$Butyrate)
plot2 <- papertheme(ggplot(subset(df, Butyrate >= 0), aes(x = as.numeric(Day), y = as.numeric(Butyrate), fill = Donor, color = Donor)) + geom_point())+ geom_line() +
  facet_grid(cols = vars(Transit), rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs, Transit = Transit.labs), scales = "free") + scale_x_continuous(breaks = seq(0,20,by=2))+
  theme(strip.background = element_rect(fill = "#D6E0F4")) +
  ylab(expression(paste("Butyrate (mM ",day^{"-1"}, ")"))) + xlab("Day")
plot2
ggarrange(plot, plot1, plot2, nrow = 3, common.legend = T, legend = "bottom")

# saveplots()
# ggsave(plot = plot2, width = 20, height = 15, dpi = 100, filename = "paperplot_vfa_stabilisation_comboplot.tiff")
```


## Paperplot pt 1 - Net production
```{r Paperplot combination, fig.height=7, fig.width=10}
# original: height = 15

# Place all columns below each other!
plotlist <- list()
df <- subset(functdatanet, Ninetransit == 3)
df[c(9, 12)] <- replace(df[c(9, 12)], df[c(9, 12)] < 0, 0)
colons = F; xaxis = T; alfa = 0.5; size = 3

# Acetate
max = max(df$Acetate); min = min(df$Acetate)
plot <- papertheme(ggplot(subset(df, Acetate >= 0), aes(x = Transit, y = Acetate, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Acetate >= 0), aes(x = Transit, y = Acetate, color = Donor), alpha = alfa, size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs)) + 
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Net acetate production (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(26,29,32, 15,18,21))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")

if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}

plotlist[[1]] <- plot

# Propionate
max = max(df$Propionate); min = min(df$Propionate)
plot <- papertheme(ggplot(subset(df, Propionate >= 0), aes(x = Transit, y = Propionate, fill = Transit)) + geom_boxplot())+ 
    geom_jitter(data = subset(df, Propionate >= 0), aes(x = Transit, y = Propionate, color = Donor), alpha = alfa,
                size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Net propionate production (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time") 

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(16,19,22,4,7,10))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")

if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}

plotlist[[2]] <- plot


# Butyrate
max = max(df$Butyrate); min = min(df$Butyrate)
plot <- papertheme(ggplot(subset(df, Butyrate >= 0), aes(x = Transit, y = Butyrate, fill = Transit)) + geom_boxplot())+
    geom_jitter(data = subset(df, Butyrate >= 0), aes(x = Transit, y = Butyrate, color = Donor), alpha = alfa,
                size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Net butyrate production (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")+
  scale_y_continuous(limits = c(0,8))

dat_text <- data.frame(label = c("a*", "b*", "a*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(5,7.3,5,2.5,5,8))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")

if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}

plotlist[[3]] <- plot



# total SCFA
max = max(df$total_SCFA); min = min(df$total_SCFA)
plot <- papertheme(ggplot(subset(df, total_SCFA >= 0), aes(x = Transit, y = total_SCFA, fill = Transit)) + geom_boxplot())+
    geom_jitter(data = subset(df, total_SCFA >= 0), aes(x = Transit, y = total_SCFA, color = Donor), alpha = alfa, 
                size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0,60))+
  ylab(expression(paste("Net total SCFA production (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(45,50,55,30,35,40))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")

if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}

plotlist[[4]] <- plot


# Branched SCFA
max = max(df$Branched); min = min(df$Branched)
plot <- papertheme(ggplot(subset(df, Branched >= 0), aes(x = Transit, y = Branched, fill = Transit)) + geom_boxplot())+ 
    geom_jitter(data = subset(df, Branched >= 0), aes(x = Transit, y = Branched, color = Donor), alpha = alfa, size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0,2.5))+
  ylab(expression(paste("Branched SCFA (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b*", "c*", "a", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.5,2,2.4,1,1,2.4))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")
colons = T
if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}

plotlist[[5]] <- plot

comboplot <- ggarrange(plotlist = plotlist, labels = "AUTO", ncol = 5, nrow=1, font.label = list(size = 20), 
                       # align = "hv", 
                       widths = c(1,1,1,1,1.2)); comboplot



plot <- papertheme(ggplot(df.meanVFAnet, aes(x = Transit, y = value, fill = Vessel)) + 
         geom_bar(position="dodge", stat="identity")  + 
         facet_grid(variable ~ intTransit + Donor, 
                    labeller = labeller(Donor = donor.labs), scales = "free")) +  
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = donorcolors, labels = c("Proximal colon", "Distal colon")) +
  ylab(expression(paste("net SCFA production (mM ",day^{"-1"}, ")"))) + xlab("SHIME transit time") +
  geom_errorbar(aes(ymin=value-SD, ymax=value+SD),width=.2,position=position_dodge(.9)) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) +
  theme(legend.position = c(0.90,0.93), legend.background = element_blank() ,
        legend.title = element_blank());ggarrange(plot, NULL, nrow = 2, heights = c(0.6, 0.4))
plot <- Fusetoplayer(plot) ; plot


plot2 <- ggarrange(comboplot, plot, nrow = 2, labels = c("", "F"), font.label = list(size = 20), heights = c(0.4, 0.6));plot2
saveplots()
ggsave(plot = plot2, width = 20, height = 15, dpi = 100, filename = "paperplot_vfa_comboplot.tiff")





# Ammonium netto
df2 <- subset(functdatabruto, Ninetransit == 4|Ninetransit ==3)
df2 <- subset(df2, select = c(Day, Transit, Donor, Vessel, NH4., Ninetransit))
df2 <- na.omit(df2)

  df2P <- subset(df2, Vessel == "P"); df2D <- subset(df2, Vessel == "D")
  df2P1  <- subset(df2P,select=c(NH4.))*(600/1000)
  df2Pnet <- cbind(subset(df2P,select=-c(NH4.)), df2P1)
  
  df2D1 <- (subset(df2D,select=c(NH4.))-subset(df2P,select=c(NH4.)))*(600/1000)
  df2Dnet <- cbind(subset(df2D,select=-c(NH4.)), df2D1)
  
    df2 <- rbind(df2Pnet, df2Dnet)

df.1 <- subset(df2, Vessel == "P" & Transit == "ST"); df.1$TT <- 8
df.2 <- subset(df2, Vessel == "P" & Transit == "MT"); df.2$TT <- 16
df.3 <- subset(df2, Vessel == "P" & Transit == "LT"); df.3$TT <- 24
df.4 <- subset(df2, Vessel == "D" & Transit == "ST"); df.4$TT <- 13
df.5 <- subset(df2, Vessel == "D" & Transit == "MT"); df.5$TT <- 26
df.6 <- subset(df2, Vessel == "D" & Transit == "LT"); df.6$TT <- 39
df2 <- rbind(df.1, df.2, df.3, df.4, df.5, df.6)



# Pearson correlation test
summary(lm(formula = NH4. ~ TT, data = df2))
result = cor(df2$NH4., df2$TT, method = "pearson") 
cat("Pearson correlation coefficient is:", result) 
t <- cor.test(df2$NH4., df2$TT, method = "spearman") 

rhot <- cor.test(df2$NH4., df2$TT, method = 'spearman')
rhot <- cor.test(df2$TT, df2$NH4.,  method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)


format(summary(lm(NH4. ~ TT, df2))$r.squared, digits = 3)
rhot
rho_text <- expression(paste("Spearman's ", rho, "= 0.662"))

max = max(df2$NH4.); min = min(df2$Branched)
dat_text <- data.frame(label = c("PC", "PC", "PC", "DC", "DC", "DC"),
  Vessel   = c("P","P","P","D","D","D"),
  TT  = c(8,16,24,13,26,39),
  value     = c(3,6,7,3,6.5,7))
  # value     = c(max - (min*2),max- min,max,max- (min*2),max-min,max))

dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
# for(i in c("P", "D")){
  # df3 <- subset(df2, Vessel == i)
  df3<- df2; 
plot3 <- papertheme(ggplot(subset(df3, NH4. >0), aes(x = TT, y = NH4.)) + 
                     geom_point(aes(color = Donor), size = 5) )
  min(ggplot_build(plot3)$data[[1]]$x); max(ggplot_build(plot3)$data[[1]]$y)
  # facet_grid(rows = vars(Vessel))+ 
plot3 <- plot3 +  geom_smooth(method='lm', se=F, color="black") +
  scale_color_manual(values = sixdonors)+
  # geom_text(x = 8+11, y = 19-2, label = lm_eqn(df3), parse = TRUE, size = 5.5, family='sans', color = "#505359") + 
  geom_text(data= dat_text,  mapping = aes(x = as.numeric(TT), y = as.numeric(value), label = label), 
            family = 'sans', colour = "#474747", size = 6, parse = TRUE, vjust = 0) +
  geom_text(x = 7, y = 8, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)+ 
      xlab("SHIME transit time (h)") + ylab(expression(paste("Net ammonium production (mmol ",day^{"-1"}, ")"))) + 
  theme(legend.position = c(0.8, 0.25), legend.title = element_text(size =17), 
                                                             legend.text = element_text(size = 17))
plotlist[[12]] <- plot3



## Ammonium
df2 <- subset(functdatabruto, Ninetransit == 4|Ninetransit ==3)
df2 <- subset(df2, select = c(Day, Transit, Donor, Vessel, NH4., Ninetransit))
df2 <- na.omit(df2)

df.1 <- subset(df2, Vessel == "P" & Transit == "ST"); df.1$TT <- 8
df.2 <- subset(df2, Vessel == "P" & Transit == "MT"); df.2$TT <- 16
df.3 <- subset(df2, Vessel == "P" & Transit == "LT"); df.3$TT <- 24
df.4 <- subset(df2, Vessel == "D" & Transit == "ST"); df.4$TT <- 13
df.5 <- subset(df2, Vessel == "D" & Transit == "MT"); df.5$TT <- 26
df.6 <- subset(df2, Vessel == "D" & Transit == "LT"); df.6$TT <- 39
df2 <- rbind(df.1, df.2, df.3, df.4, df.5, df.6)



# Pearson correlation test
summary(lm(formula = NH4. ~ TT, data = df2))
result = cor(df2$NH4., df2$TT, method = "pearson") 
cat("Pearson correlation coefficient is:", result) 
t <- cor.test(df2$NH4., df2$TT, method = "spearman") 

rhot <- cor.test(df2$NH4., df2$TT, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)


format(summary(lm(NH4. ~ TT, df2))$r.squared, digits = 3)
rho_text <- expression(paste("Spearman's ", rho, "= 0.789"))

dat_text <- data.frame(label = c("PC", "PC", "PC", "DC", "DC", "DC"),
  Vessel   = c("P","P","P","D","D","D"),
  TT  = c(8,16,24,13,26,39),
  value     = c(5, 10,12,8,13.5,20))

dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
  df3<- df2; 
plot3 <- papertheme(ggplot(df3, aes(x = TT, y = NH4.)) + 
                     geom_point(aes(color = Donor), size = 5) )
  min(ggplot_build(plot3)$data[[1]]$x); max(ggplot_build(plot3)$data[[1]]$y)
  # facet_grid(rows = vars(Vessel))+ 
plot3 <- plot3 +  geom_smooth(method='lm', se=F, color="black") +
  scale_color_manual(values = sixdonors)+
  # geom_text(x = 8+11, y = 19-2, label = lm_eqn(df3), parse = TRUE, size = 5.5, family='sans', color = "#505359") + 
  geom_text(data= dat_text,  mapping = aes(x = as.numeric(TT), y = as.numeric(value), label = label), 
            family = 'sans', colour = "#474747", size = 6, parse = TRUE, vjust = 0) +
  geom_text(x = 7, y = 20, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)+ 
    xlab("SHIME transit time (h)") + ylab("Ammonium (mM)") + theme(legend.position = c(0.9, 0.25), legend.title = element_text(size =17), 
                                                             legend.text = element_text(size = 17))
print(plot3)
# }
plotlist[[6]] <- plot3





# Isobutyrate
max = max(df$Isobutyrate); min = min(df$Isobutyrate)
max(subset(df, Vessel == "D")$Isobutyrate)
plot <- papertheme(ggplot(subset(df, Isobutyrate >= 0), aes(x = Transit, y = Isobutyrate, fill = Transit)) + geom_boxplot())+ 
    geom_jitter(data = subset(df, Isobutyrate >= 0), aes(x = Transit, y = Isobutyrate, color = Donor, shape = Donor), alpha = alfa, size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0,1.1))+
  ylab(expression(paste("Net isobutyrate prod (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b*", "a*", "a", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.6,0.7,0.6,0.8,0.9,1))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")
colons = T
if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), 
                                    axis.ticks.x=element_blank())}

plotlist[[7]] <- plot



# Isovalerate
max = max(df$Isovalerate); min = min(df$Isovalerate)

max(subset(df, Vessel == "P")$Isovalerate)
plot <- papertheme(ggplot(subset(df, Isovalerate >= 0), aes(x = Transit, y = Isovalerate, fill = Transit)) + geom_boxplot())+ 
    geom_jitter(data = subset(df, Isovalerate >= 0), aes(x = Transit, y = Isovalerate, color = Donor, shape = Donor), alpha = alfa, size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0,1.5))+
  ylab(expression(paste("Net isovalerate prod (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "a*", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1,1.2,1,1,1,1.3))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")
colons = T
if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), 
                                    axis.ticks.x=element_blank())}

plotlist[[8]] <- plot


# valerate
max = max(df$Valerate); min = min(df$Valerate)

max(subset(df, Vessel == "D")$Valerate)
plot <- papertheme(ggplot(subset(df, Valerate >= 0), aes(x = Transit, y = Valerate, fill = Transit)) + geom_boxplot())+ 
    geom_jitter(data = subset(df, Valerate >= 0), aes(x = Transit, y = Valerate, color = Donor, shape = Donor), alpha = alfa, size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0,5))+
  ylab(expression(paste("Net valerate prod (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a*", "a", "b", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(4.8,4.8,4.8,2,2.4,2.4))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")
colons = T
if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), 
                                    axis.ticks.x=element_blank())}

plotlist[[9]] <- plot



# Caproate
max = max(df$Caproate); min = min(df$Caproate)

max(subset(df, Vessel == "P")$Caproate)
plot <- papertheme(ggplot(subset(df, Caproate>= 0), aes(x = Transit, y =Caproate, fill = Transit)) + geom_boxplot())+ 
    geom_jitter(data = subset(df, Caproate >= 0), aes(x = Transit, y = Caproate, color = Donor, shape = Donor), alpha = alfa, size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0,1.5))+
  ylab(expression(paste("Net caproate prod (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a", "a", "a", "a"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.3,1.3,1.3,1.4,1.4,1.4))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")
colons = T
if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), 
                                    axis.ticks.x=element_blank())}

plotlist[[10]] <- plot



# Heptanoate
max = max(df$Heptanoate); min = min(df$Heptanoate)

max(subset(df, Vessel == "D")$Heptanoate)
plot <- papertheme(ggplot(subset(df, Heptanoate>= 0), aes(x = Transit, y =Heptanoate, fill = Transit)) + geom_boxplot())+ 
    geom_jitter(data = subset(df, Heptanoate >= 0), aes(x = Transit, y = Heptanoate, color = Donor, shape = Donor), alpha = alfa, size = size) + 
  scale_color_manual(values = sixdonors) + 
  facet_grid(rows = vars(Vessel), 
             # scales = "free", 
             labeller = labeller(Vessel = PD_Colon.labs)) + theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0,0.8))+
  ylab(expression(paste("Net heptanoate prod (mmol ",day^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a", "a", "a", "b"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.7,0.7,0.7,0.35,0.35,0.4))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 6) + scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")
colons = T
if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), 
                                    axis.ticks.x=element_blank())}

plotlist[[11]] <- plot
```

# Figure S15
```{r Paperplot combination, fig.height=6, fig.width=9}


## Propionate production relative to butyrate prod
df <- subset(functdatanet, Ninetransit == 3& Vessel == "P")
df[c(9, 12)] <- replace(df[c(9, 12)], df[c(9, 12)] < 0, 0)




dat_text <- data.frame(label = c("ρ = 0.47*", "ρ = -0.05", "ρ = -0.47*"),
                       Butyrate = c(5.8,5.8,1.5),
                       Propionate = c(2.5,7,18),
                       Transit =c("ST", "MT", "LT"))
if(BW == T){
dat_text <- data.frame(label = c("rho = 0.47*", "rho = -0.05", "rho = -0.47*"),
                       Butyrate = c(5.8,5.8,1.5),
                       Propionate = c(2.5,7,18),
                       Transit =c("ST", "MT", "LT"))}



plot <- papertheme(ggplot(df, aes(x = Butyrate, y =Propionate, color = Transit))) +
  geom_point(size = 4) +
  geom_smooth(fullrange = T, method = "lm", se = F) +
  # scale_color_manual(values = c(sixdonors, transitcolors))+
     # scale_fill_manual("SHIME transit time", values = sixdonors)+
  scale_color_manual("SHIME transit",values = transitcolors, labels = c("Short", "Medium", "Long")) +
  ylab(expression(paste("Propionate (mmol ",day^{"-1"}, ")")))+
  xlab(expression(paste("Butyrate (mmol ",day^{"-1"}, ")"))) + ylim(0,21)  +
  geom_text(data= dat_text,  mapping = aes(x = as.numeric(Butyrate), y = as.numeric(Propionate), label = label, family = 'sans'), size = 8, color = "black") + 
  theme(legend.position = c(0.80,0.80),
        legend.box = "horizontal",
        legend.title = element_text(size=20), legend.background = element_blank()) 


if(BW == TRUE){
 plot <- plot +  scale_color_grey("SHIME transit", labels = c("Short", "Medium", "Long") )
}

plot 

saveplots();ggsave(plot = plot, width = 9, height = 6, dpi = 300, bg = "white", filename = "FigureS15.pdf")

for(i in c("ST", "MT", "LT")){
  message(paste("results for transit" , i))
summary(lm(formula = Propionate ~ Butyrate, data = subset(df, Transit == i)))
result = cor(subset(df, Transit == i)$Propionate, subset(df, Transit == i)$Butyrate, method = "pearson") 
cat("Pearson correlation coefficient is:", result)
print(cor.test(subset(df, Transit == i)$Propionate, subset(df, Transit == i)$Butyrate, method = "spearman") )
}

```




## Paperplot pt 2 - biomass - no volume correction!!
```{r plot biomass, fig.height=10, fig.width=20}
alfa = 0.5; size =3
df <- production_relative_biomass
max(max(df$Acet_biomass), max(df$Prop_biomass), max(df$But_biomass), max(df$SCFA_biomass), max(df$Branched_biomass)) 
min(min(subset(df,Acet_biomass >=0)$Acet_biomass), min(subset(df,Prop_biomass >=0)$Prop_biomass), min(subset(df,But_biomass >=0)$But_biomass),
    min(subset(df,SCFA_biomass >=0)$SCFA_biomass), min(subset(df,Branched_biomass >=0)$Branched_biomass))
# Acetate
max(subset(df, Vessel == "P")$Acet_biomass)
plot <- papertheme(ggplot(subset(df, Acet_biomass >= 0), aes(x = Transit, y = Acet_biomass, fill = Transit)) + geom_boxplot())+
  geom_jitter(data = subset(df, Acet_biomass >= 0), aes(x = Transit, y = Acet_biomass, color = Donor, alpha = alfa), size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Acetate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a*", "b*", "a", "b*", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.39644e-07,1.59644e-07,1.79644e-07, 7.56484e-07,7.76484e-07,8.06484e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot1 <- plot + 
  ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long"))  
plot1 <- plot1 +  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot1


# Propionate
max(subset(df, Vessel == "D")$Prop_biomass)
plot <- papertheme(ggplot(subset(df, Prop_biomass >= 0), aes(x = Transit, y = Prop_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Prop_biomass >= 0), aes(x = Transit, y = Prop_biomass, color = Donor, alpha = alfa), size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Propionate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "a", "b", "a*", "b", "b"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.657533e-08,1.857533e-08,2.057533e-08, 11.034849e-08,11.234849e-08,11.634849e-08))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot2 <- plot + ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")+scale_y_continuous(trans='log10'); plot2



# Butyrate
max(subset(df, Vessel == "P")$But_biomass)
plot <- papertheme(ggplot(subset(df, But_biomass >= 0), aes(x = Transit, y = But_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, But_biomass >= 0), aes(x = Transit, y = But_biomass, color = Donor, alpha = alfa), size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Butyrate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "a", "b*", "a*", "b", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(6.330629e-08, 6.230629e-08, 6.130629e-08, 2.36894e-07, 2.56894e-07, 2.76894e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot3 <- plot + ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")+scale_y_continuous(trans='log10') ; plot3


# Total SCFA
max(subset(df, Vessel == "D")$SCFA_biomass)
plot <- papertheme(ggplot(subset(df, SCFA_biomass >= 0), aes(x = Transit, y = SCFA_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, SCFA_biomass >= 0), aes(x = Transit, y = SCFA_biomass, color = Donor, alpha = alfa), size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Total SCFA (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "a*", "b*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(2.693408e-07,2.893408e-07, 2.993408e-07,9.907265e-07,10.107265e-07, 10.507265e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot4 <- plot + ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot4


# Branched
max(subset(df, Vessel == "P")$Branched_biomass)
max <- max(subset(df, Branched_biomass >= 0& Vessel == "P")$Branched_biomass)
plot <- papertheme(ggplot(subset(df, Branched_biomass >= 0), aes(x = Transit, y = Branched_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Branched_biomass >= 0), aes(x = Transit, y = Branched_biomass, color = Donor), alpha = alfa)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Branched SCFA (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b", "c*", "a", "b", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.856538e-08, 2.056538e-08, 2.256538e-08, 2.064215e-07, 2.264215e-07, 2.464215e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot5 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot5


plot1 <- plot1 + theme(strip.text.y =  element_blank()) 
plot2 <- plot2 + theme(strip.text.y =  element_blank()) 
plot3 <- plot3 + theme(strip.text.y =  element_blank()) 
# plot4 <- plot4 + theme(strip.text.y =  element_blank())

SCFA_biomass <- list(plot1, plot2, plot3, plot4 , plot5)

#Calculate other SCFAs
# Isobutyrate
max(subset(df, Vessel == "P")$Isobut_biomass)
max <- max(subset(df, Isobut_biomass >= 0& Vessel == "P")$Isobut_biomass)
plot <- papertheme(ggplot(subset(df, Isobut_biomass >= 0), aes(x = Transit, y = Isobut_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Isobut_biomass >= 0), aes(x = Transit, y = Isobut_biomass, color = Donor, shape = Donor), alpha = alfa, size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Isobutyrate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(7.5e-10, 7.5e-10, 6.5e-10, 4.473547e-08, 4.473547e-08, 8.673547e-08))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot6 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot6

# Isovalerate
max(subset(df, Vessel == "P")$Isoval_biomass)
max <- max(subset(df, Isoval_biomass >= 0& Vessel == "P")$Isoval_biomass)
plot <- papertheme(ggplot(subset(df, Isoval_biomass >= 0), aes(x = Transit, y = Isoval_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Isoval_biomass >= 0), aes(x = Transit, y = Isoval_biomass, color = Donor, shape = Donor), alpha = alfa, size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Isovalerate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b", "a*", "a", "b", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(5e-9, 4e-9, 4e-9, 4.03547e-08, 4.03547e-08, 12.23547e-08))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot7 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot7


# Valerate
max(subset(df, Vessel == "D")$Val_biomass)
max <- max(subset(df, Val_biomass >= 0& Vessel == "P")$Val_biomass)
plot <- papertheme(ggplot(subset(df, Val_biomass >= 0), aes(x = Transit, y = Val_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Val_biomass >= 0), aes(x = Transit, y = Val_biomass, color = Donor, shape = Donor), alpha = alfa, size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Valerate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a*", "a*", "a", "b*", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1e-9,5e-9, 10e-9, 11.95549e-09,11.95549e-09,11.95549e-09))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot8 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot8


# Caproate
max(subset(df, Vessel == "P")$Cap_biomass)
max <- max(subset(df, Cap_biomass >= 0& Vessel == "P")$Cap_biomass)
plot <- papertheme(ggplot(subset(df, Cap_biomass >= 0), aes(x = Transit, y = Cap_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Cap_biomass >= 0), aes(x = Transit, y = Cap_biomass, color = Donor, shape = Donor), alpha = alfa, size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Caproate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a*", "a*", "a", "a*", "a*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.5e-9, 0.7e-9, 1e-9, 4.367375e-09, 4.367375e-09, 4.367375e-09))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot9 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot9




# Heptanoate
max(subset(df, Vessel == "P")$Hep_biomass)
max <- max(subset(df, Hep_biomass >= 0& Vessel == "P")$Hep_biomass)
plot <- papertheme(ggplot(subset(df, Hep_biomass >= 0), aes(x = Transit, y = Hep_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Hep_biomass >= 0), aes(x = Transit, y =Hep_biomass, color = Donor, shape = Donor), alpha = alfa, size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Heptanoate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a", "a", "a", "a"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(5e-11, 4e-10, 4e-10, 8e-10, 8e-10, 15e-10))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot10 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot10

SCFA_biomassextra <- list(plot6, plot7, plot8, plot9 , plot10)
ggarrange(plot1, plot2, plot3, plot4, plot5)
# 
# if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
# if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}; plotlist[[1]] <- plot
```


```{r intact, fig.height=10, fig.width=20}
# Intact
df <- production_relative_int_biomass
max(max(df$Acet_biomass), max(df$Prop_biomass), max(df$But_biomass), max(df$SCFA_biomass), max(df$Branched_biomass)) 
min(min(subset(df,Acet_biomass >=0)$Acet_biomass), min(subset(df,Prop_biomass >=0)$Prop_biomass), min(subset(df,But_biomass >=0)$But_biomass),
    min(subset(df,SCFA_biomass >=0)$SCFA_biomass), min(subset(df,Branched_biomass >=0)$Branched_biomass))
# Acetate
max(subset(df, Vessel == "P")$Acet_biomass)
plot <- papertheme(ggplot(subset(df, Acet_biomass >= 0), aes(x = Transit, y = Acet_biomass, fill = Transit)) + geom_boxplot())+
  geom_jitter(data = subset(df, Acet_biomass >= 0), aes(x = Transit, y = Acet_biomass, color = Donor, alpha = alfa))+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Acetate (mmol intact cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a*", "b*", "a", "b*", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(2.39644e-07,2.59644e-07,2.79644e-07, 7.56484e-07,7.76484e-07,7.86484e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot1 <- plot + 
  ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long"))  
plot1 <- plot1 +  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot1


# Propionate
max(subset(df, Vessel == "P")$Prop_biomass)
plot <- papertheme(ggplot(subset(df, Prop_biomass >= 0), aes(x = Transit, y = Prop_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Prop_biomass >= 0), aes(x = Transit, y = Prop_biomass, color = Donor, alpha = alfa))+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Propionate (mmol intact cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "a", "b", "a*", "b", "b"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.657533e-08,1.857533e-08,2.057533e-08, 11.034849e-08,11.234849e-08,11.434849e-08))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot2 <- plot + ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")+scale_y_continuous(trans='log10'); plot2



# Butyrate
max(subset(df, Vessel == "P")$But_biomass)
plot <- papertheme(ggplot(subset(df, But_biomass >= 0), aes(x = Transit, y = But_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, But_biomass >= 0), aes(x = Transit, y = But_biomass, color = Donor, alpha = alfa))+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Butyrate (mmol intact cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "a", "b*", "a*", "b", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(6.730629e-08, 6.930629e-08, 7.130629e-08, 2.36894e-07, 2.56894e-07, 2.76894e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot3 <- plot + ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none")+scale_y_continuous(trans='log10') ; plot3


# Total SCFA
max(subset(df, Vessel == "P")$SCFA_biomass)
plot <- papertheme(ggplot(subset(df, SCFA_biomass >= 0), aes(x = Transit, y = SCFA_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, SCFA_biomass >= 0), aes(x = Transit, y = SCFA_biomass, color = Donor, alpha = alfa))+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Total SCFA (mmol intact cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "a*", "b*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(3.693408e-07,3.893408e-07, 4.093408e-07,9.907265e-07,10.107265e-07, 10.307265e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot4 <- plot + ylim(0, 8.907265e-07)+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot4


# Branched
max(subset(df, Vessel == "P")$Branched_biomass)
max <- max(subset(df, Branched_biomass >= 0& Vessel == "P")$Branched_biomass)
plot <- papertheme(ggplot(subset(df, Branched_biomass >= 0), aes(x = Transit, y = Branched_biomass, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Branched_biomass >= 0), aes(x = Transit, y = Branched_biomass, color = Donor), alpha = alfa)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Branched SCFA (mmol intact cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b", "c*", "a", "b", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.856538e-08, 2.056538e-08, 2.256538e-08, 2.064215e-07, 2.264215e-07, 2.464215e-07))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot5 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot5


plot1 <- plot1 + theme(strip.text.y =  element_blank()) 
plot2 <- plot2 + theme(strip.text.y =  element_blank()) 
plot3 <- plot3 + theme(strip.text.y =  element_blank()) 
plot4 <- plot4 + theme(strip.text.y =  element_blank()) 

SCFA_biomass_int <- list(plot1, plot2, plot3, plot4, plot5)


ggarrange(plotlist = SCFA_biomass)
ggarrange(plotlist = SCFA_biomass_int)

ggarrange(SCFA_biomass[[1]], SCFA_biomass[[2]], SCFA_biomass[[3]],SCFA_biomass[[4]],SCFA_biomass[[5]],
          SCFA_biomass_int[[1]], SCFA_biomass_int[[2]], SCFA_biomass_int[[3]],SCFA_biomass_int[[4]],SCFA_biomass_int[[5]], nrow = 2, ncol = 5
          )
```

## Paperplot pt 3 - load - volume has to be corrected!!
```{r plot load, fig.height=13, fig.width=17}

alfa = 0.5 
df <- metabolites_relative_load
max(max(df$Acet_load), max(df$Prop_load), max(df$Buty_load), max(df$SCFA_load)) 
min(min(subset(df,Acet_load >=0)$Acet_load), min(subset(df,Prop_load >=0)$Prop_load), min(subset(df,Buty_load >=0)$But_load),
    min(subset(df,SCFA_load >=0)$SCFA_load))

# Acetate
max(subset(df, Vessel == "P")$Acet_load)
plot <- papertheme(ggplot(subset(df, Acet_load >= 0), aes(x = Transit, y = Acet_load, fill = Transit)) + geom_boxplot())+
  geom_jitter(data = subset(df, Acet_load >= 0), aes(x = Transit, y = Acet_load, color = Donor, alpha = alfa), size = 4)+
  scale_color_manual(values = sixdonors) +
  # facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Acetate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a"),
  Vessel   = c("P","P","P"),
  Transit  = c("ST", "MT", "LT"),
  value     = c(20,15,10))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot1 <- plot + 
  
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long"))  
plot1 <- plot1  +
  theme(legend.position = "none"); plot1


# Propionate
max(subset(df, Vessel == "P")$Prop_load)
plot <- papertheme(ggplot(subset(df, Prop_load >= 0), aes(x = Transit, y = Prop_load, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Prop_load >= 0), aes(x = Transit, y = Prop_load, color = Donor, alpha = alfa), size = 4)+
  scale_color_manual(values = sixdonors) +
  # facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Propionate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b", "b"),
  Vessel   = c("P","P","P"),
  Transit  = c("ST", "MT", "LT"),
  value     = c(5,4,4))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot2 <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  guides(fill = "none", size = "none", alpha = "none",color=guide_legend(ncol=3, title.position = 'top')) +
  theme(legend.position = c(0.7,0.86), legend.box.just = "center", legend.direction = "vertical", legend.title.align = 0.5); plot2



# Butyrate
max(subset(df, Vessel == "P")$Buty_load)
plot <- papertheme(ggplot(subset(df, Buty_load >= 0), aes(x = Transit, y = Buty_load, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Buty_load >= 0), aes(x = Transit, y = Buty_load, color = Donor, alpha = alfa), size = 4)+
  scale_color_manual(values = sixdonors) +
  # facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Butyrate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "b"),
  Vessel   = c("P","P","P"),
  Transit  = c("ST", "MT", "LT"),
  value     = c(5, 4, 3))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot3 <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none") ; plot3


# Total SCFA
max(subset(df, Vessel == "P")$SCFA_load)
plot <- papertheme(ggplot(subset(df, SCFA_load >= 0), aes(x = Transit, y = SCFA_load, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, SCFA_load >= 0), aes(x = Transit, y = SCFA_load, color = Donor),alpha = alfa, size =4)+
  scale_color_manual(values = sixdonors) +
  # facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Total SCFA relative to nutrient load (mmol ",g^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b", "c"),
  Vessel   = c("P","P","P"),
  Transit  = c("ST", "MT", "LT"),
  value     = c(30,25,20))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot4 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  
  theme(legend.position = "none"); plot4


plot1 <- plot1 + theme(strip.text.y =  element_blank()) 
plot2 <- plot2 + theme(strip.text.y =  element_blank()) 
plot3 <- plot3 + theme(strip.text.y =  element_blank()) 
plot4 <- plot4 + theme(strip.text.y =  element_blank())

SCFA_load <- list(plot1, plot2, plot3, plot4 )
plot1bis <- plot1; plot2bis <- plot2; 
plot3bis <- plot3; plot4bis <- plot4
# SCFA_load <- list(plot1, plot2, plot3, plot4, plot5)
ggarrange(plot1, plot2, plot3, plot4)
# 
# if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
# if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}; plotlist[[1]] <- plot
```


## Paperplot pt 4 - carbohydrates - no volume correction!!
```{r plot CH, fig.height=10, fig.width=20}
alfa = 0.5; size = 3
df <- metabolites_relative_carbohydrate
df <- subset(df, Samplenumber != 288)
# max(max(df$Acet_biomass), max(df$Prop_biomass), max(df$But_biomass), max(df$SCFA_biomass), max(df$Branched_biomass)) 
# min(min(subset(df,Acet_biomass >=0)$Acet_biomass), min(subset(df,Prop_biomass >=0)$Prop_biomass), min(subset(df,But_biomass >=0)$But_biomass),
#     min(subset(df,SCFA_biomass >=0)$SCFA_biomass), min(subset(df,Branched_biomass >=0)$Branched_biomass))

# Acetate
max(subset(df, Vessel == "D")$Acet_CH)
plot <- papertheme(ggplot(df , aes(x = Transit, y = Acet_CH, fill = Transit)) + geom_boxplot())+
  geom_jitter(data = df, aes(x = Transit, y = Acet_CH, color = Donor, alpha = alfa))+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Net acetate production (mmol ",g^{"-1"}, " net carbohydrate consumption)"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("ab*", "a*", "b*", "a*", "a*", "a*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(8.9,8.6,8.6, 125,120,120))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot1 <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  guides(alpha = "none", fill = "none", color = guide_legend(ncol = 6))+
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long"))  
plot1 <- plot1 +  theme(legend.position = "none"); plot1


# Propionate
max(subset(df, Vessel == "D")$Prop_CH)
plot <- papertheme(ggplot(subset(df, Prop_CH >= 0), aes(x = Transit, y = Prop_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Prop_CH >= 0), aes(x = Transit, y = Prop_CH, color = Donor, alpha = alfa), size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Net propionate (mmol ",g^{"-1"}, " net carbohydrates)"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "a*", "a*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(4,5,6, 25,15,15))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot2 <- plot +
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  guides(alpha = "none", fill = "none", color = guide_legend(ncol = 6))+
  theme(legend.position = "none"); plot2



# Butyrate
max(subset(df, Vessel == "D")$Buty_CH)
plot <- papertheme(ggplot(subset(df, Buty_CH >= 0), aes(x = Transit, y = Buty_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Buty_CH >= 0), aes(x = Transit, y = Buty_CH, color = Donor, alpha = alfa), size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Net butyrate (mmol ",g^{"-1"}, " net carbohydrates)"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a*", "b*", "a", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(2.5,2.5,2, 14.5,12,12))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot3 <- plot +
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  guides(alpha = "none", fill = "none", color = guide_legend(ncol = 6))+
  theme(legend.position = "none") ; plot3


# Total SCFA
max(subset(df, Vessel == "D")$SCFA_CH)
plot <- papertheme(ggplot(subset(df, SCFA_CH >= 0), aes(x = Transit, y = SCFA_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, SCFA_CH >= 0), aes(x = Transit, y = SCFA_CH, color = Donor, alpha = alfa), size = size)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Net total SCFA (mmol ",g^{"-1"}, " net carbohydrates)"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("ab*", "a*", "b*", "a*", "a*", "a*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(12.7,12.7,12.7,150,100,100))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot4 <- plot +
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) +
  guides(alpha = "none", fill = "none", color = guide_legend(ncol = 6))+
  theme(legend.position = "none"); plot4


plot1 <- plot1 + theme(strip.text.y =  element_blank()) 
plot2 <- plot2 + theme(strip.text.y =  element_blank()) 
plot3 <- plot3 + theme(strip.text.y =  element_blank()) 
# plot4 <- plot4 + theme(strip.text.y =  element_blank())

SCFA_CH <- list(plot1, plot2, plot3, plot4 , plot5)

#Calculate other SCFAs
# Isobutyrate
max(subset(df, Vessel == "D")$Isobut_CH)
max <- max(subset(df, Isobut_CH >= 0& Vessel == "P")$Isobut_CH)
plot <- papertheme(ggplot(subset(df, Isobut_CH >= 0), aes(x = Transit, y = Isobut_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Isobut_CH >= 0), aes(x = Transit, y = Isobut_CH, color = Donor), alpha = alfa)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Isobutyrate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "b*", "a*", "a", "a*", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.5,0.5,0.5,0.5,0.5,0.5))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot6 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) +
  theme(legend.position = "none"); plot6

# Isovalerate
max(subset(df, Vessel == "D")$Isoval_CH)
max <- max(subset(df, Isoval_CH >= 0& Vessel == "P")$Isoval_CH)
plot <- papertheme(ggplot(subset(df, Isoval_CH >= 0), aes(x = Transit, y = Isoval_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Isoval_CH >= 0), aes(x = Transit, y = Isoval_CH, color = Donor), alpha = alfa)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Isovalerate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "a*", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.4,0.4,0.4, 0.5,0.5,0.5))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot7 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none"); plot7


# Valerate
max(subset(df, Vessel == "P")$Val_CH)
max <- max(subset(df, Val_CH >= 0& Vessel == "P")$Val_CH)
plot <- papertheme(ggplot(subset(df, Val_CH >= 0), aes(x = Transit, y = Val_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Val_CH >= 0), aes(x = Transit, y = Val_CH, color = Donor), alpha = alfa)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Valerate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a*", "a*", "a", "b*", "b*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1.4,1.4,1.4, 0.8,0.8,0.8))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot8 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) +
  theme(legend.position = "none"); plot8


# Caproate
max(subset(df, Vessel == "D")$Cap_CH)
max <- max(subset(df, Cap_CH >= 0& Vessel == "P")$Cap_CH)
plot <- papertheme(ggplot(subset(df, Cap_CH >= 0), aes(x = Transit, y = Cap_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Cap_CH >= 0), aes(x = Transit, y = Cap_CH, color = Donor), alpha = alfa)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Caproate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a", "a", "a", "a"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.4,0.4,0.4, 0.5,0.5,0.5))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot9 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) +
  theme(legend.position = "none"); plot9




# Heptanoate
max(subset(df, Vessel == "D")$Hep_CH)
max <- max(subset(df, Hep_CH >= 0& Vessel == "P")$Hep_CH)
plot <- papertheme(ggplot(subset(df, Hep_CH >= 0), aes(x = Transit, y = Hep_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Hep_CH >= 0), aes(x = Transit, y =Hep_CH, color = Donor), alpha = alfa)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs))  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  ylab(expression(paste("Heptanoate (mmol total cell",s^{"-1"}, ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a", "a", "a", "a"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.16,0.16,0.16,0.15,0.15,0.15))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
plot10 <- plot + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  scale_y_continuous(trans='log10') +
  theme(legend.position = "none"); plot10

SCFA_CHextra <- list(plot6, plot7, plot8, plot9 , plot10)
ggarrange(plot1, plot2, plot3, plot4, plot5)
# 
# if(colons == F){plot <- plot + theme(strip.text.y = element_blank())}
# if(xaxis == F){plot <- plot + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())}; plotlist[[1]] <- plot
```



### Figure tryout
```{r Paperplot combination tryout, fig.height=18, fig.width=20}
for(i in c(1:5)){plotlist[[i]] <- plotlist[[i]] + scale_x_discrete(labels= c("ST", "MT", "LT"))}

# Net production
comboplot <- ggarrange(plotlist = plotlist, labels = "AUTO", ncol = 6, nrow=1, font.label = list(size = 20), 
                       # align = "hv", 
                       widths = c(1,1,1,1,1.2,1.8)); comboplot

plot4 <- ggarrange(comboplot, plot, nrow = 2, labels = c("", "G"), font.label = list(size = 20), heights = c(0.4, 0.6));plot4

# SCFA production on biomass
for(i in c(1:5)){SCFA_biomass[[i]] <- SCFA_biomass[[i]] + scale_x_discrete(labels= c("ST", "MT", "LT"))}
plot5 <- ggarrange(SCFA_biomass[[1]], SCFA_biomass[[2]], SCFA_biomass[[3]], SCFA_biomass[[4]], SCFA_biomass[[5]], NULL, ncol = 6, labels = c("G", "H", "I", "J", "K"), font.label = list(size = 20), widths = c(1,1,1,1,1.1,0) ); plot5

plot6 <- ggarrange(comboplot, plot5, plot, labels = c("","", "L"),font.label = list(size = 20), nrow = 3, heights = c(0.4, 0.4, 0.6)); plot6

# SCFA production on nutrient load
plotload <- ggarrange(NULL,SCFA_load[[1]],NULL, SCFA_load[[2]],NULL, SCFA_load[[3]],NULL,SCFA_load[[4]], 
                     labels = c("L","","M", "","N","", "O","", "P",""),font.label = list(size = 20),
                     ncol = 8, widths = c(0.1,1.2,0.1,1.2,0.1,1.2,0.1,1.2)); plotload


# Combine them all
plot7 <- ggarrange(comboplot, plot5, plotload, labels = c("","", "L"),font.label = list(size = 20), nrow = 3, heights = c(0.4, 0.4, 0.4)); plot7
plot1

saveplots()
# ggsave(plot = plot4, width = 20, height = 15, dpi = 100, filename = "paperplot_vfa_comboplot2.tiff")

```

Combine Paperplot 1, 2, 3 and 4
# Figure 5
```{r Paperplot combination - figure 5, fig.height=15, fig.width=14}
# for(i in c(1:4)){plotlist[[i]] <- plotlist[[i]] + scale_x_discrete(labels= c("ST", "MT", "LT"))}

# Net production
comboplot <- ggarrange(plotlist[[1]] + theme(axis.text.x = element_text(size = 20)) + scale_x_discrete(labels= c("Short", "Med", "Long"))
                       #                       ,
                       # axis.title.y=element_text(hjust=0.1)
                       , 
                       plotlist[[2]] + theme(axis.text.x = element_text(size = 20),
                       axis.title.y=element_text(hjust=0.1)) + scale_x_discrete(labels= c("Short", "Med", "Long")), 
                       plotlist[[3]] + theme(axis.text.x = element_text(size = 20)) + scale_x_discrete(labels= c("Short", "Med", "Long")
                                             # ,
                       # axis.title.y=element_text(hjust=0.1)
                       ), 
                       plotlist[[4]] + theme(strip.background =element_rect(fill="#D6E0F4"),
                                             axis.title.y=element_text(hjust=0.1),
                                             axis.text.x = element_text(size = 20),
                                             strip.text.x = element_text(size = 20),
                                             strip.text.y = element_text(size = 20, angle = 270),
                                             legend.title = element_text(size=20)) + 
                         scale_x_discrete(labels= c("Short", "Med", "Long")), 
                       plotlist[[12]] + guides(colour = guide_legend(ncol = 2)) + theme(legend.title.align = 0.5, legend.position = c(0.8,0.15)),  labels = "AUTO", ncol = 5, nrow=1, font.label = list(size = 20), 
                       # align = "hv", 
                       widths = c(1,1,1,1.2,1.6)); comboplot



# SCFA production on biomass
for(i in c(1:5)){SCFA_biomass[[i]] <- SCFA_biomass[[i]] + 
  # scale_x_discrete(labels= c("ST", "MT", "LT"))
  scale_x_discrete(labels= c("Short", "Med", "Long"))
  
  
  }
plotbiomass <- ggarrange(NULL, SCFA_biomass[[1]] + ylab(bquote(atop("Biomass-normalised acetate production",
                                                                    "(mmol net total cell" ~production^-1~")"))), 
                         NULL, SCFA_biomass[[2]] + ylab(bquote(atop("Biomass-normalised propionate"~  "production", 
                                                              "(mmol net total cell"~ production^-1~")"))), 
                         NULL, SCFA_biomass[[3]] + ylab(bquote(atop("Biomass-normalised butyrate production", 
                                                                    "(mmol net total cell"~ production^-1~")"))), 
                         NULL, SCFA_biomass[[4]] + ylab(bquote(atop("Biomass-normalised total SCFA production", 
                                                                    "(mmol net total cell"~ production^-1~")"))), 
                         ncol = 8, labels = c("F", "", "G","", "H","", "I"), font.label = list(size = 20), widths = c(0.07,1,0.07,1,0.07,1,0.07,1.1) ); plotbiomass


# SCFA production on nutrient load
for(i in c(1:4)){SCFA_load[[i]] <- SCFA_load[[i]] +
  scale_x_discrete(labels= c("Short", "Med", "Long")) }


plotload <- ggarrange(NULL,SCFA_load[[1]],NULL, SCFA_load[[2]],NULL, SCFA_load[[3]],NULL,SCFA_load[[4]], 
                     labels = c( "J","", "K","", "L","","M",""),font.label = list(size = 20),
                     ncol = 8, widths = c(0.1,1.2,0.1,1.2,0.1,1.2,0.1,1.25)); plotload


# SCFA production on CH depletion
siz <- 7
for(i in c(1:4)){SCFA_CH[[i]] <- SCFA_CH[[i]] +
  scale_x_discrete(labels= c("Short", "Med", "Long")) }

plotCH <- ggarrange(NULL,SCFA_CH[[1]] + guides(colour = guide_legend(override.aes = list(size=siz), ncol = 6))+
                      theme(legend.title = element_text(size=22), legend.text = element_text(size=22)) + 
                      # ylab(bquote(atop("Net acetate production", "(mmol " ~ g^-1 ~ " net carbohydrate consumption)"))),
                      ylab(bquote(atop("Net carbohydrate-to-acetate ", "conversion"~ "efficiency "~ "(mmol " ~ g^-1~ ")"))),
                    NULL, SCFA_CH[[2]]+ guides(colour = guide_legend(override.aes = list(size=siz), ncol = 6))+
                      theme(legend.title = element_text(size=22), legend.text = element_text(size=22))+ 
                      # ylab(bquote(atop("Net propionate production", "(mmol " ~ g^-1 ~ " net carbohydrate consumption)"))),
                      ylab(bquote(atop("Net carbohydrate-to-propionate ", "conversion"~ "efficiency "~"(mmol " ~ g^-1~ ")"))),
                    NULL, SCFA_CH[[3]]+ guides(colour = guide_legend(override.aes = list(size=siz), ncol = 6))+
                      theme(legend.title = element_text(size=22), legend.text = element_text(size=22))+ 
                      # ylab(bquote(atop("Net butyrate production", "(mmol " ~ g^-1 ~ " net carbohydrate consumption)"))),
                      ylab(bquote(atop("Net carbohydrate-to-butyrate ", "conversion"~ "efficiency "~"(mmol " ~ g^-1~ ")"))),
                    NULL,SCFA_CH[[4]]+ guides(colour = guide_legend(override.aes = list(size=siz), ncol = 6))+
                      theme(legend.title = element_text(size=22), legend.text = element_text(size=22))+ 
                      # ylab(bquote(atop("Net total SCFA production", "(mmol " ~ g^-1 ~ " net carbohydrate consumption)"))), 
                      ylab(bquote(atop("Net carbohydrate-to-total SCFA ", "conversion"~ "efficiency "~"(mmol " ~ g^-1~ ")"))),
                     labels = c( "J","", "K","", "L","","M",""),font.label = list(size = 20),
                     ncol = 8, widths = c(0.07,1.2,0.07,1.2,0.06,1.2,0.08,1.25), common.legend = T, legend = "bottom")#; plotCH



# Combine them all
plot7 <- ggarrange(comboplot, plotbiomass, plotload,font.label = list(size = 20), nrow = 3, heights = c(0.4, 0.4, 0.4))#; plot7

plot7 <- ggarrange(comboplot, plotbiomass, plotCH,font.label = list(size = 20), nrow = 3, heights = c(0.4, 0.4, 0.4)); plot7


saveplots()
# ggsave(plot = plot4, width = 20, height = 15, dpi = 100, filename = "paperplot_vfa_comboplot2.tiff")
```


# Extra SCFAs for Suppl figure
```{r fig.height=13, fig.width=17}

alfa = 1 
df <- metabolites_relative_carbohydrate
max(max(df$Acet_load), max(df$Prop_load), max(df$Buty_load), max(df$SCFA_load)) 
min(min(subset(df,Acet_CH >=0)$Acet_CH), min(subset(df,Prop_CH >=0)$Prop_CH), min(subset(df,Buty_CH >=0)$But_CH),
    min(subset(df,SCFA_CH >=0)$SCFA_CH))

# Isovalerate
max(subset(df, Vessel == "P")$Isoval_CH)
plot <- papertheme(ggplot(subset(df, Isoval_CH >= 0), aes(x = Transit, y = Isoval_CH, fill = Transit)) + geom_boxplot())+
  geom_jitter(data = subset(df, Isoval_CH >= 0), aes(x = Transit, y = Isoval_CH, color = Donor, alpha = alfa, shape = Donor), size = 4)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  # ylab(expression(paste("Isovalerate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + 
  ylab(bquote(atop("Net carbohydrate-to-isovalerate", "efficiency (mmol " ~ g^-1~ ")"))) + xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b", "c*", "a*", "a", "b*"),
  Vessel   = c("P","P","P", "D", "D", "D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.5,0.5,0.55,2,1.2,3))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
plot2 <- plot + 
  
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long"))  
plot1 <- plot2  +
  theme(legend.position = "none"); plot1


# Isobutyrate
max(subset(df, Vessel == "P")$Isobut_CH)
plot <- papertheme(ggplot(subset(df, Isobut_CH >= 0), aes(x = Transit, y = Isobut_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Isobut_CH >= 0), aes(x = Transit, y = Isobut_CH, color = Donor, alpha = alfa, shape = Donor), size = 4)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  # ylab(expression(paste("Isobutyrate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + 
  ylab(bquote(atop("Net carbohydrate-to-isobutyrate", "efficiency (mmol " ~ g^-1~ ")"))) +xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "b*", "a*", "a*", "a*", "b*"),
  Vessel   = c("P","P","P", "D", "D", "D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.3,0.3,0.28,2,2,2))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))

plot1 <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  guides(fill = "none", size = "none", alpha = "none",color=guide_legend(ncol=3, title.position = 'top')) +
  theme(legend.position = c(0.7,0.86), legend.box.just = "center", legend.direction = "vertical", legend.title.align = 0.5); plot1



# Valerate
max(subset(df, Vessel == "P")$Val_CH)
plot <- papertheme(ggplot(subset(df, Val_CH >= 0), aes(x = Transit, y = Val_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Val_CH >= 0), aes(x = Transit, y = Val_CH, color = Donor, alpha = alfa, shape = Donor), size = 4)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  # ylab(expression(paste("Valerate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + 
  ylab(bquote(atop("Net carbohydrate-to-valerate", "efficiency (mmol " ~ g^-1~ ")"))) +xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a*", "a*", "a", "b*", "b*"),
  Vessel   = c("P","P","P", "D", "D", "D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(1,1.5,1.8,7.5,8,6))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))

plot3 <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none") ; plot3


# Caproate
max(subset(df, Vessel == "P")$Cap_CH)
plot <- papertheme(ggplot(subset(df, Cap_CH >= 0), aes(x = Transit, y = Cap_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Cap_CH >= 0), aes(x = Transit, y = Cap_CH, color = Donor, alpha = alfa, shape = Donor), size = 4)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  # ylab(expression(paste("Caproate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + 
  ylab(bquote(atop("Net carbohydrate-to-caproate", "efficiency (mmol " ~ g^-1~ ")"))) +xlab("SHIME transit time")

dat_text <- data.frame(label = c("a*", "a", "a", "a*", "a", "a"),
  Vessel   = c("P","P","P", "D", "D", "D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.25,0.4,0.5,3,4,4))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))


plot4 <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none") ; plot4


# Heptanoate
max(subset(df, Vessel == "P")$Hep_CH)
plot <- papertheme(ggplot(subset(df, Hep_CH >= 0), aes(x = Transit, y = Hep_CH, fill = Transit)) + geom_boxplot())+ 
  geom_jitter(data = subset(df, Hep_CH >= 0), aes(x = Transit, y = Hep_CH, color = Donor, alpha = alfa, shape = Donor), size = 4)+
  scale_color_manual(values = sixdonors) +
  facet_grid(rows = vars(Vessel), labeller = labeller(Vessel = PD_Colon.labs), scales = "free")  +
  theme(strip.background = element_rect(fill = "#D6E0F4")) + 
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) + 
  # ylab(expression(paste("Heptanoate relative to nutrient load (mmol ",g^{"-1"}, ")"))) + 
  ylab(bquote(atop("Net carbohydrate-to-heptanoate", "efficiency (mmol " ~ g^-1~ ")"))) +xlab("SHIME transit time")

dat_text <- data.frame(label = c("a", "a", "a", "a", "a", "b"),
  Vessel   = c("P","P","P", "D", "D", "D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(0.05,0.1,0.18,0.2,1,1))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))

plot5 <- plot + geom_text(data= dat_text,  mapping = aes(x = factor(Transit),
        y = as.numeric(value), label = label, family = 'sans'), size = 6) +
  scale_x_discrete(labels=c("ST" = "Short", "MT" = "Medium",  "LT" = "Long")) + 
  theme(legend.position = "none") ; plot5

plot1 <- plot1 + theme(strip.text.y =  element_blank()) 
plot2 <- plot2 + theme(strip.text.y =  element_blank()) 
plot3 <- plot3 + theme(strip.text.y =  element_blank()) 
plot4 <- plot4 + theme(strip.text.y =  element_blank())

SCFA_CHextra <- list(plot1, plot2, plot3, plot4, plot5)
plot1bis <- plot1; plot2bis <- plot2; 
plot3bis <- plot3; plot4bis <- plot4

ggarrange(plot1, plot2, plot3, plot4, plot5)
```


# Figure S13
```{r Paperplot combination - supplementary, fig.height=15, fig.width=16}


if(BW == T){
for(i in c(7:11)){plotlist[[i]] <- plotlist[[i]] + scale_color_grey(start = 0, end = 0.5) + scale_fill_grey(start = 0.5, end = 1) +  
  # scale_x_discrete(labels= c("ST", "MT", "LT"))
  scale_x_discrete(labels= c("Short", "Med", "Long"))+
  theme(strip.background = element_rect(fill = "white")) + 
  scale_shape_manual(values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))
}}else{
    for(i in c(7:11)){plotlist[[i]] <- plotlist[[i]] +  
  scale_shape_manual(values=c("1" = 16, "2" = 16, "3" = 16 , "4" = 16, "5" = 16, "6" = 16))}
  }

# Net production
comboplot <- ggarrange(plotlist[[7]] + theme(strip.text.y = element_blank()), 
                       plotlist[[8]] + theme(strip.text.y = element_blank()), 
                       plotlist[[9]] + theme(strip.text.y = element_blank()), 
                       plotlist[[10]] + theme(strip.text.y = element_blank()),
                       plotlist[[11]] +
                         theme(strip.background =element_rect(fill="white"),
                               strip.text.x = element_text(size = 20),
                               strip.text.y = element_text(size = 20, angle = 270),
                               legend.title = element_text(size=20)) , 
                       labels = "AUTO", ncol = 5, nrow=1, font.label = list(size = 20), 
                       # align = "hv", 
                       widths = c(1,1,1,1,1.1)) #; comboplot



# SCFA production on biomass
for(i in c(1:5)){SCFA_biomassextra[[i]] <- SCFA_biomassextra[[i]] + 
  # scale_x_discrete(labels= c("ST", "MT", "LT"))
  scale_x_discrete(labels= c("Short", "Med", "Long"))}

if(BW == T){
for(i in c(1:5)){SCFA_biomassextra[[i]] <- SCFA_biomassextra[[i]] + scale_color_grey(start = 0, end = 0.5) + scale_fill_grey(start = 0.5, end = 1) +  
  theme(strip.background = element_rect(fill = "white")) + 
  scale_shape_manual(values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9))
}}else{
    for(i in c(1:5)){SCFA_biomassextra[[i]] <- SCFA_biomassextra[[i]] +  
  scale_shape_manual(values=c("1" = 16, "2" = 16, "3" = 16 , "4" = 16, "5" = 16, "6" = 16))}
  }


plotbiomass <- ggarrange(SCFA_biomassextra[[1]] + theme(strip.text.y = element_blank()),
                         SCFA_biomassextra[[2]] + theme(strip.text.y = element_blank()),
                         SCFA_biomassextra[[3]] + theme(strip.text.y = element_blank()),
                         SCFA_biomassextra[[4]] + theme(strip.text.y = element_blank()),
                         SCFA_biomassextra[[5]], ncol = 5, labels = c("F", "G", "H", "I", "J"), font.label = list(size = 20), widths = c(1,1,1,1,1.1) ); plotbiomass


# SCFA production on nutrient load
if(BW == T){
for(i in c(1:5)){SCFA_CHextra[[i]] <- SCFA_CHextra[[i]] + scale_color_grey(start = 0, end = 0.5) + scale_fill_grey(start = 0.5, end = 1) +  scale_x_discrete(labels= c("Short", "Med", "Long"))+
  theme(strip.background = element_rect(fill = "white")) + 
  scale_shape_manual(values=c("1" = 15, "2" = 16, "3" = 17 , "4" = 18, "5" = 25, "6" = 9)) + 
  guides(colour = "none",fill = "none", shape = guide_legend(ncol = 6, direction = "horizontal", title.position = "left"))
}}else{
    for(i in c(1:5)){SCFA_CHextra[[i]] <- SCFA_CHextra[[i]] +  
  scale_shape_manual(values=c("1" = 16, "2" = 16, "3" = 16 , "4" = 16, "5" = 16, "6" = 16))}
}

plotload <- ggarrange(NULL,SCFA_CHextra[[1]] + scale_y_continuous(limits = c(0,0.8))+ 
                        theme(legend.position = c(0.5,0.86)), NULL, 
                      SCFA_CHextra[[2]] + theme(legend.position = "none"),NULL,
                     SCFA_CHextra[[3]],NULL,SCFA_CHextra[[4]], NULL,
                      SCFA_CHextra[[5]],
                     labels = c( "K","", "L","","M","", "N","", "O",""),
                     font.label = list(size = 20), ncol = 10, 
                     widths = c(0.1,1.2,0.1,1.2,0.1,1.2,0.1,1.2, 0.1,1.2)); plotload

plotload <- ggarrange(NULL,SCFA_CHextra[[1]] +  
                        # guides(color = guide_legend(ncol = 6, direction = "horizontal",
                        #                             title.position = "left")) +
                        guides(colour = "none",fill = "none", 
                               shape = guide_legend(ncol = 6, 
                                                    direction = "horizontal", title.position = "left")) +
                        theme(legend.position = "none"), NULL, 
                      SCFA_CHextra[[2]] + theme(legend.position = "none"),NULL,
                     SCFA_CHextra[[3]],NULL,SCFA_CHextra[[4]], NULL,
                      SCFA_CHextra[[5]],
                     labels = c( "K","", "L","","M","", "N","", "O",""),
                     font.label = list(size = 20), ncol = 10, 
                     widths = c(0.1,1.2,0.1,1.2,0.1,1.2,0.1,1.2, 0.1,1.2), common.legend = T, legend = "bottom"); plotload


# Combine them all
plot7 <- ggarrange(comboplot, plotbiomass, plotload,font.label = list(size = 20), nrow = 3, heights = c(0.4, 0.4, 0.4)); plot7


saveplots();ggsave(plot = plot7, width = 20, height = 20, dpi = 400, bg = "white", filename = "FigureS13.pdf")
```

# Ordination
## New db-RDA
### Absolute production
```{r fig.height=5, fig.width=5}
functdatanettrt <- subset(functdatanet, Ninetransit == 3)
neon <- c("#2f89fc") ; labelcolour <- c("#fc0202");
labelcolour <- "#fc0202"; plotlabels = T
linecolour <- c("#fc0202"); showR = FALSE
PDcolours <- c("#434e52", "#5b8c85" ) ; ndigits <- 2
legendsize <- 15 ; labelsize <- 6; ygrob <- 0.9; neonsize <- 7; topn <- 15
if(showR == TRUE){xgrob <- 0.85}else{xgrob <- 0.8}; xgrobb <- 0.65; abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62+0.1
lefttitle <- " Absolute metabolite production" ; righttitle <- "Proportional metabolite production "
labelsA <- c("Ac","Pr","Bu","Br"); labels <- c("Ac","Pr","Bu")
legendsize <- 18; pointsize = 9; grobsize <- 15; abbrev <- F; plotobjects <- TRUE; plotobjects2 <- F
pos <- position_jitter(width = 0.0, seed = 2)
saveplots()



# test <- subset(test, select = -c(InTransit))
df.1 <- subset(functdatanettrt, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(functdatanettrt, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(functdatanettrt, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
functdatanettrt <- test



# Define data frames
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate, Branched))
sampleinfo <- subset(functdatanettrt, select = c(Transit, Donor, Vessel, ivTransit))
# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub; df.sub <- df.sub
 # rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")
## Perform PCoA
 # pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points
## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 ordi
 ordi$anova
 
test <- ordi[["anova"]]
test <- rownames_to_column(test) %>%
  mutate_all(funs(gsub("[[:punct:]]", "", .)))
test <- test %>%
  mutate_all(funs(gsub(" ", "", .)))
test <- test[1:nrow(test) - 1,]
variables <- test$rowname; message(crayon::green(paste("Hey, your variables are:"))); variables


# Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
 
 
# SHIME transit time
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo)
rdafunct<-  capscale(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 

## permutation test of the results
 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])

## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Transit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "SHIME transit", labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelsA),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") + ggtitle(lefttitle) 
plotobjrdatop15PDA <- plotobj + xlim(min(points$fa)-0.5, max(rdascorevfa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDA}
 



# Donor
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~Donor + Condition(Vessel) + Condition(Transit), sampleinfo)
rdafunct<-  capscale(df.sub~ Donor + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 

 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Donor"= anova[1,4])

## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Donor" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)

rownames(rdafactor) <- mapvalues(rownames(rdafactor), 
                                 from = c("Donor1","Donor2","Donor3",
                                          "Donor4","Donor5","Donor6"), 
                                 to = seq(1:6))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Donor), alpha = 0.8) +
  scale_colour_manual(values = sixdonors, name = "Donor") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelsA),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 2, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDB <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDB}





# ivTransit
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo)
rdafunct<-  capscale(df.sub~ ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 

 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "ivTransit"= anova[1,4])

## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "ivTransit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)

rownames(rdafactor) <- mapvalues(rownames(rdafactor), 
                                 from = c("ivTransitLTD", "ivTransitMTD", "ivTransitSTD"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = ivTransit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors2, name = paste(lblInvivo, "transit"), 
                      labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelsA),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") # + ggtitle(lefttitle) 
plotobjrdatop15PDC <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDC}



 
 
 #Vessel
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
  anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("VesselP", "VesselD"), 
                                 to = c("Proximal", "Distal"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = P_D), alpha = 0.8) +
  scale_colour_manual(values = c("Proximal" = "#cdb174", "Distal" = "#a48d5c"), name = "Vessel") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = MDS1), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = MDS1),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = MDS1,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = MDS1, label = labelsA),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
}
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDD <- plotobj + xlim(min(rdascorevfa - 0.2), max(points$fa) + 0.5) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDD}




 
# Adjust p-values because of multiple testing
 # Correction for multiple testing (Benjamini–Hochberg procedure, FDR) 
 Panova
 p.adjust(Panova, method = "holm")

```



### Relative production
```{r fig.height=5, fig.width=5}
functdatanettrt <- subset(functdatanet, Ninetransit == 3)
neon <- c("#2f89fc") ; labelcolour <- c("#fc0202");
labelcolour <- "#fc0202"; plotlabels = T
linecolour <- c("#fc0202"); showR = FALSE
PDcolours <- c("#434e52", "#5b8c85" ) ; ndigits <- 2
legendsize <- 15 ; labelsize <- 6; ygrob <- 0.9; neonsize <- 7; topn <- 15
if(showR == TRUE){xgrob <- 0.85}else{xgrob <- 0.8}; abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62+0.1
lefttitle <- " Absolute metabolite production" ; righttitle <- "Proportional metabolite production "
labelsA <- c("Ac","Pr","Bu","Br"); labels <- c("Ac","Pr","Bu")
legendsize <- 18; pointsize = 9; grobsize <- 15; abbrev <- F; plotobjects <- TRUE; plotobjects2 <- F
pos <- position_jitter(width = 0.0, seed = 2); xgrobb <- 0.65
saveplots()



# test <- subset(test, select = -c(InTransit))
df.1 <- subset(functdatanettrt, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(functdatanettrt, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(functdatanettrt, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
functdatanettrt <- test



# Define data frames
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate, Branched))
df.sub <- mutate(df.sub,total_SCFA =Acetate+ Propionate+ Butyrate,   Acetateratio = Acetate/total_SCFA, Propionateratio = Propionate/total_SCFA, 
                 Butyrateratio = Butyrate/total_SCFA, Branchedratio = Branched/total_SCFA)
df.sub<- subset(df.sub, select = c(Acetateratio, Propionateratio ,Butyrateratio))

sampleinfo <- subset(functdatanettrt, select = c(Transit, Donor, Vessel, ivTransit))
# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub; df.sub <- df.sub
 # rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")
## Perform PCoA
 # pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points
## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 ordi
 ordi$anova
 
test <- ordi[["anova"]]
test <- rownames_to_column(test) %>%
  mutate_all(funs(gsub("[[:punct:]]", "", .)))
test <- test %>%
  mutate_all(funs(gsub(" ", "", .)))
test <- test[1:nrow(test) - 1,]
variables <- test$rowname; message(crayon::green(paste("Hey, your variables are:"))); variables


# Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
 
 # SHIME transit time
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo)
rdafunct<-  capscale(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])

## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Transit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "SHIME transit", labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") + ggtitle(righttitle) 
plotobjrdatop15PDE <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDE}
 



# Donor
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~Donor + Condition(Vessel) + Condition(Transit), sampleinfo)
rdafunct<-  capscale(df.sub~ Donor + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Donor"= anova[1,4])

## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Donor" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)

rownames(rdafactor) <- mapvalues(rownames(rdafactor), 
                                 from = c("Donor1","Donor2","Donor3",
                                          "Donor4","Donor5","Donor6"), 
                                 to = seq(1:6))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Donor), alpha = 0.8) +
  scale_colour_manual(values = sixdonors, name = "Donor") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 2, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal")# + ggtitle(lefttitle) 
plotobjrdatop15PDF <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDF}





# ivTransit
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo)
rdafunct<-  capscale(df.sub~ ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "ivTransit"= anova[1,4])


## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "ivTransit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)

rownames(rdafactor) <- mapvalues(rownames(rdafactor), 
                                 from = c("ivTransitLTD", "ivTransitMTD", "ivTransitSTD"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = ivTransit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors2, name = paste(lblInvivo, "transit"), 
                      labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDG <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDG}



 
 
 #Vessel
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
  anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("VesselP", "VesselD"), 
                                 to = c("Proximal", "Distal"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = P_D), alpha = 0.8) +
  scale_colour_manual(values = c("Proximal" = "#cdb174", "Distal" = "#a48d5c"), name = "Vessel") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = MDS1), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = MDS1),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = MDS1,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = MDS1, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
}
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDH <- plotobj + xlim(min(rdascorevfa - 0.2), max(points$fa) + 0.5) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDH}



 
# Adjust p-values because of multiple testing
 # Correction for multiple testing (Benjamini–Hochberg procedure, FDR) 
 Panova
 p.adjust(Panova, method = "holm")

```


### Carbohydrate to SCFA
```{r fig.height=5, fig.width=5}
functdatanettrt <- subset(metabolites_relative_carbohydrate, Ninetransit == 3)
neon <- c("#2f89fc") ; labelcolour <- c("#fc0202");
labelcolour <- "#fc0202"; plotlabels = T
linecolour <- c("#fc0202"); showR = FALSE
PDcolours <- c("#434e52", "#5b8c85" ) ; ndigits <- 2
legendsize <- 15 ; labelsize <- 6; ygrob <- 0.9; neonsize <- 7; topn <- 15
if(showR == TRUE){xgrob <- 0.85}else{xgrob <- 0.8}; abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62+0.1
lefttitle <- " Absolute metabolite production" ; righttitle <- "Carbohydrate-to-SCFA production"
labelsA <- c("Ac","Pr","Bu", "tot"); labels <- c("Ac","Pr","Bu", "tot")
legendsize <- 18; pointsize = 9; grobsize <- 15; abbrev <- F; plotobjects <- TRUE; plotobjects2 <- F
pos <- position_jitter(width = 0.0, seed = 2); xgrobb <- 0.65
saveplots()



# test <- subset(test, select = -c(InTransit))
df.1 <- subset(functdatanettrt, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(functdatanettrt, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(functdatanettrt, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
functdatanettrt <- test



# Define data frames
df.sub <- subset(functdatanettrt, select = c(Acet_CH, Prop_CH, Buty_CH))
df.sub <- mutate(df.sub,total_SCFA =Acet_CH+ Prop_CH+ Buty_CH)

sampleinfo <- subset(functdatanettrt, select = c(Transit, Donor, Vessel, ivTransit))
# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub; df.sub <- df.sub
 # rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")
## Perform PCoA
 # pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points
## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 ordi
 ordi$anova
 
test <- ordi[["anova"]]
test <- rownames_to_column(test) %>%
  mutate_all(funs(gsub("[[:punct:]]", "", .)))
test <- test %>%
  mutate_all(funs(gsub(" ", "", .)))
test <- test[1:nrow(test) - 1,]
variables <- test$rowname; message(crayon::green(paste("Hey, your variables are:"))); variables


# Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
 
 # SHIME transit time
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo)
rdafunct<-  capscale(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])

## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Transit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "SHIME transit", labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
     plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") + ggtitle(righttitle) 
plotobjrdatop15PDE1 <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDE1}
 



# Donor
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~Donor + Condition(Vessel) + Condition(Transit), sampleinfo)
rdafunct<-  capscale(df.sub~ Donor + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Donor"= anova[1,4])

## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Donor" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)

rownames(rdafactor) <- mapvalues(rownames(rdafactor), 
                                 from = c("Donor1","Donor2","Donor3",
                                          "Donor4","Donor5","Donor6"), 
                                 to = seq(1:6))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Donor), alpha = 0.8) +
  scale_colour_manual(values = sixdonors, name = "Donor") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 2, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal")# + ggtitle(lefttitle) 
plotobjrdatop15PDF2 <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDF2}





# ivTransit
## Perform RDA with pcoascores to check if its the same
rdafunctR <- rda(pcoascores~ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo)
rdafunct<-  capscale(df.sub~ ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
 anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "ivTransit"= anova[1,4])


## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "ivTransit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)

rownames(rdafactor) <- mapvalues(rownames(rdafactor), 
                                 from = c("ivTransitLTD", "ivTransitMTD", "ivTransitSTD"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = ivTransit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors2, name = paste(lblInvivo, "transit"), 
                      labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDG3 <- plotobj + xlim(min(points$fa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDG3}



 
 
 #Vessel
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
  anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("VesselP", "VesselD"), 
                                 to = c("Proximal", "Distal"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = P_D), alpha = 0.8) +
  scale_colour_manual(values = c("Proximal" = "#cdb174", "Distal" = "#a48d5c"), name = "Vessel") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = MDS1), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = MDS1),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = MDS1,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = MDS1, label = labels),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
}
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDH4 <- plotobj + xlim(min(rdascorevfa - 0.2), max(points$fa) + 0.5) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDH4}



 
# Adjust p-values because of multiple testing
 # Correction for multiple testing (Benjamini–Hochberg procedure, FDR) 
 Panova
 p.adjust(Panova, method = "holm")

```



### Plot together
```{r fig.height=19, fig.width=15}
plot <- ggarrange(plotobjrdatop15PDA + theme(legend.position = "none"),
          plotobjrdatop15PDE + theme(legend.position = c(0.15,0.2)),
          plotobjrdatop15PDB + theme(legend.position = "none"),
          plotobjrdatop15PDF + theme(legend.position = c(0.86,0.2)),
          plotobjrdatop15PDC + theme(legend.position = "none"),
          plotobjrdatop15PDG + theme(legend.position = c(0.92,0.2))+ theme(legend.background=element_blank()), 
          plotobjrdatop15PDD + theme(legend.position = "none"),
          plotobjrdatop15PDH + theme(legend.position = c(0.15,0.2)),nrow = 4, ncol = 2 ,
          labels = "AUTO", font.label = list(size = 20)); plot
saveplots()
ggsave(plot = plot, width = 15, height = 19, dpi = 200, filename = "Supplementary_figure9_low_res.png")
ggsave(plot = plot, width = 15, height = 19, dpi = 600, filename = "Supplementary_figure9_high_res.tiff")


plot <- ggarrange(plotobjrdatop15PDA + theme(legend.position = "none"),
          plotobjrdatop15PDE, plotobjrdatop15PDE1 + theme(legend.position = c(0.15,0.2)),
          plotobjrdatop15PDB + theme(legend.position = "none"),
          plotobjrdatop15PDF, plotobjrdatop15PDF2 + theme(legend.position = c(0.86,0.2)),
          plotobjrdatop15PDC + theme(legend.position = "none"),
          plotobjrdatop15PDG, plotobjrdatop15PDG3 + theme(legend.position = c(0.92,0.2)) + theme(legend.background=element_blank()), 
          plotobjrdatop15PDD + theme(legend.position = "none"),
          plotobjrdatop15PDH, plotobjrdatop15PDH4 + theme(legend.position = c(0.15,0.2)),nrow = 4, ncol = 3 ,
          labels = "AUTO", font.label = list(size = 20)); plot

```



## db-RDA
```{r paperplot_RDA_Metabolites, eval=, echo=TRUE, fig.height=13.5, fig.width=15}
# General parameters
labelsA <- c("Ac","Pr","Bu","Br");labels <- c("Ac","Pr","Bu")
neon <- c("#2f89fc"); neonsize <- 7 ;labelcolour <- c("#fc0202"); linecolour <- c("#fc0202")
legendsize <- 15 ; labelsize <- 6
xgrob <- 0.85;  ygrob <- 0.93
grobsize <-14; abb_digits = T; dgts = 1
lefttitle <- " Absolute metabolite production" ; righttitle <- "Proportional metabolite production "
plotobjects <- F

functdatanettrt <- subset(functdatanet, Ninetransit == 3)

# Transit time
## PCA with acetate propionate and butyrate
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate, Branched))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
# functdatanettrt$Nutrient_Load <- mapvalues(functdatanettrt$Nutrient_Load, from = c("ST", "MT", "LT"), 
#                                            to = c("Short", "Medium", "Long"))
rdafunct <- rda(df.sub~Transit+Condition(Donor) + Condition(Vessel),functdatanettrt)
#summary(rdafunct)
coef(rdafunct)

## permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000); t <- anova.cca(rdafunct,by="term",step=1000)
if(t[1,4]<0.05){message(crayon::green(t[1,4]))}else{message(crayon::red(t[1,4]))}
df.A <- data.frame("Transit","Time","SCFA", "Absolute")
rownames(df.A) <- df.A$X.Nutrient.
num = anova.cca(rdafunct,step=1000)
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.A) <- colnames(num)
df.A <- rbind(df.A, num)

## explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
if(plotobjects == TRUE) {
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
} 

## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = functdatanettrt$Donor, 
                     P_D = functdatanettrt$Vessel, Transit = functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, color = points$Transit)) +
  scale_colour_manual(values = transitcolors, name = "Transit time") + 
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + ylab(paste("RDA2", Dim2, "%", sep = " ")) +
  annotation_custom(grob) +
  geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2), 
                  color = neon, label = rownames(rdafactor), 
                  segment.color = "grey50",
                  size = neonsize)
plotobj <- plotobj + geom_text_repel(data = rdascorevfa, aes(x = RDA1, y = RDA2, 
                                                             label = labelsA
                                                             # vjust = ifelse(RDA2 >= 0, -0.1, 0.7), 
                                                             # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                                             ), segment.color = "grey50",
                                     color = linecolour, size = 7, parse = TRUE) +
  geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = RDA2), color = labelcolour)
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1)) + theme(legend.position = "right")
mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position = "none")
plotobjrdafunctnetPDA <- plotobj + xlim(min(rdascorevfa) - 1, max(points$fa + 1)) + 
  ggtitle(lefttitle) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE) {plotobjrdafunctnetPDA}


# PCA with acetateratio propionateratio and butyrateratio
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate ,Branched, total_SCFA)) 
df.sub <- mutate(df.sub, Acetateratio = Acetate/total_SCFA, Propionateratio = Propionate/total_SCFA,   
                 Butyrateratio = Butyrate/total_SCFA)
df.sub <- subset(df.sub, select = c(Acetateratio, Propionateratio, Butyrateratio))
# functdatanettrt$Nutrient_Load <- as.factor(functdatanettrt$Nutrient_Load)
rdafunct <- rda(df.sub~Transit+Condition(Donor) + Condition(Vessel),functdatanettrt)
#summary(rdafunct)
coef(rdafunct)
# permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000); t <- anova.cca(rdafunct,by="term",step=1000)
if(t[1,4]<0.05){message(crayon::green(t[1,4]))}else{message(crayon::red(t[1,4]))}
df.B <- data.frame("Transit","time","SCFA", "Ratio")
rownames(df.B) <- df.B$X.Nutrient.
num = anova.cca(rdafunct,step=1000)
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.B) <- colnames(num)
df.B <- rbind(df.B, num)
# explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
# labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

#plot SCALING2
if(plotobjects == TRUE) {
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
} 
# ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints, Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel,Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("TransitST", "TransitMT", "TransitLT"), to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=points$Transit)) + scale_colour_manual(values=transitcolors,name="Transit time") + 
  xlab(paste('RDA1',Dim1,"%",sep=" ")) + ylab(paste('RDA2',Dim2,"%",sep=" "))+
  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=RDA2),color=neon, 
                  label = rownames(rdafactor), 
                  segment.color = "grey50",
                  size = neonsize)
plotobj <- plotobj+ geom_text_repel(data=rdascorevfa,aes(x=RDA1,y=RDA2,label=labels
                                                         # vjust=ifelse(RDA2>= 0,-0.1,0.7),
                                                         # hjust=ifelse(RDA1>=0,0,0.5)
                                                         ),segment.color = "grey50",
                                    color=linecolour,size=7,parse=TRUE) +geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=RDA2),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+guides(color=guide_legend(ncol=1))+
  theme(legend.position = leg.B, legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize))
mylegendNL <- g_legend(plotobj)
# plotobj <- plotobj + theme(legend.position = "none")
plotobjrdafunctnetPDB <- plotobj + xlim(min(rdascorevfa)-0.5,max(points$fa+0.5))+ 
  ggtitle(righttitle) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE) {plotobjrdafunctnetPDB}



# Donor
# PCA with acetate propionate and butyrate
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate, Branched))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
rdafunct <- rda(df.sub~Donor+Condition(Transit) + Condition(Vessel),functdatanettrt)
#summary(rdafunct)
coef(rdafunct)

# permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.C <- data.frame("Donor","","SCFA", "absolute")
rownames(df.C) <- df.B$X.Donor.
num = anova.cca(rdafunct,step=1000); if(num[1,4]<0.05){message(crayon::green(num[1,4]))}else{message(crayon::red(num[1,4]))}
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.C) <- colnames(num)
df.C <- rbind(df.C, num)
# explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
# labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
   }
#plot SCALING2
if(plotobjects == TRUE) {
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
# ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints, sa=secondaxispoints, Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel, Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
 
rdafactor <- data.frame(summary(rdafunct)$centroids)
# rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("Donor1", "Donor2","Donor3", "Donor4", "Donor5", "Donor6"),
#                                  to=c("1","2", "3", "4", "5", "6"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=Donor)) + scale_colour_manual(values=sixdonors,name="Donor") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + ylab(paste('RDA2',Dim2,"%",sep=" ")) +
  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=RDA2),color=neon, label = rownames(rdafactor),segment.color = "grey50",size = neonsize)
plotobj <- plotobj+geom_text_repel(data=rdascorevfa,aes(x=RDA1,y=RDA2,label=labelsA
                                                  # vjust=ifelse(RDA2>= 0,-0.1,0.7),
                                                  # hjust=ifelse(RDA1>=0,0,0.5)
                                                  ),
                             segment.color = "grey50", 
                             color=linecolour,size=7,parse=TRUE) + 
  geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=RDA2),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+guides(color=guide_legend(ncol=1))+theme(legend.position = "right")
mylegendPDfunctnet<-g_legend(plotobj)
plotobj <- plotobj + theme(legend.position = "none")
plotobjrdafunctnetPDC <- plotobj + xlim(min(rdascorevfa)-1,max(points$fa+1))
if(plotobjects == TRUE) { plotobjrdafunctnetPDC}

# PCA with acetateratio propionateratio and butyrateratio
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate ,Branched, total_SCFA)) 
df.sub <- mutate(df.sub, Acetateratio = Acetate/total_SCFA, Propionateratio = Propionate/total_SCFA,  
                 Butyrateratio = Butyrate/total_SCFA, Branchedratio = Branched/total_SCFA)
df.sub<- subset(df.sub, select = c(Acetateratio, Propionateratio ,Butyrateratio))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
rdafunct <- rda(df.sub~Donor+Condition(Transit) + Condition(Vessel),functdatanettrt)
#summary(rdafunct)
coef(rdafunct)
# permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.D <- data.frame("Donor","","SCFA", "Ratio")
rownames(df.D) <- df.B$X.Donor.
num = anova.cca(rdafunct,step=1000); if(num[1,4]<0.05){message(crayon::green(num[1,4]))}else{message(crayon::red(num[1,4]))}
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.D) <- colnames(num)
df.D <- rbind(df.D, num)
# explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

# labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

# Plot SCALING2
if(plotobjects == TRUE) {
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
} 
# ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints,Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel,Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
# rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("Donor1", "Donor2","Donor3", "Donor4", "Donor5", "Donor6"),
#                                  to=c("1","2", "3", "4", "5", "6"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=points$Donor)) + scale_colour_manual(values=sixdonors,name="Donor") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + ylab(paste('RDA2',Dim2,"%",sep=" ")) +
  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=RDA2),color=neon, label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj+geom_text_repel(data=rdascorevfa,aes(x=RDA1,y=RDA2,label=labels
                                                  # vjust=ifelse(RDA2>= 0,-0.1,0.7),
                                                  # hjust=ifelse(RDA1>=0,0,0.5)
                                                  ),segment.color = "grey50",
                             color=linecolour,size=7,parse=TRUE) +geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=RDA2),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+guides(color=guide_legend(ncol=1)) +
  theme(legend.position = leg.D, legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize))
mylegendDo <- g_legend(plotobj)
# plotobj <- plotobj + theme(legend.position = "none")
plotobjrdafunctnetPDD <- plotobj + xlim(min(rdascorevfa)-0.5,max(points$fa+0.5))
if(plotobjects == TRUE) { plotobjrdafunctnetPDD}






# PD_Colon
## PCA with acetate propionate and butyrate
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate, Branched))
rdafunct <- rda(df.sub~Vessel+Condition(Transit) + Condition(Donor),functdatanettrt)
#summary(rdafunct)
coef(rdafunct)
## permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.E <- data.frame("PD_Colon","","SCFA", "Absolute")
rownames(df.E) <- df.B$X.Donor.
num = anova.cca(rdafunct,step=1000); if(num[1,4]<0.05){message(crayon::green(num[1,4]))}else{message(crayon::red(num[1,4]))}
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.E) <- colnames(num)
df.E <- rbind(df.E, num)
## explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
   }
## plot SCALING2
if(plotobjects == TRUE) {
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
## ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints,Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel,Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
 
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("VesselP", "VesselD"), to=c("Proximal","Distal"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=P_D)) + scale_colour_manual(values=vesselcolors,name="Colon") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + ylab(paste('PC1',Dim2,"%",sep=" ")) +
  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=PC1),color=neon,label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj+geom_text_repel(data=rdascorevfa,aes(x=RDA1,y=PC1,label=labelsA
                                                  # vjust=ifelse(PC1>= 0,-0.1,0.7),
                                                  # hjust=ifelse(RDA1>=0,0,0.5)
                                                  ), segment.color = "grey50",
                             color=linecolour,size=7,parse=TRUE) +geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=PC1),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+guides(color=guide_legend(ncol=1))+ 
  theme(legend.position = "right", legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize))
mylegendPD <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position = "none")
plotobjrdafunctnetPDE <- plotobj + xlim(min(rdascorevfa)-1,max(points$fa+1))
if(plotobjects == TRUE) { plotobjrdafunctnetPDE}

# PCA with acetateratio propionateratio and butyrateratio
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate ,Branched, total_SCFA)) 
df.sub <- mutate(df.sub, Acetateratio = Acetate/total_SCFA, Propionateratio = Propionate/total_SCFA, 
                 Butyrateratio = Butyrate/total_SCFA, Branchedratio = Branched/total_SCFA)
df.sub<- subset(df.sub, select = c(Acetateratio, Propionateratio ,Butyrateratio))
functdatanettrt$Vessel <- as.factor(functdatanettrt$Vessel)
rdafunct <- rda(df.sub~Vessel+Condition(Transit) + Condition(Donor),functdatanettrt)
#summary(rdafunct)
coef(rdafunct)
# permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.F <- data.frame("PD_Colon","","SCFA", "Ratio")
rownames(df.F) <- df.B$X.Donor.
num = anova.cca(rdafunct,step=1000); if(num[1,4]<0.05){message(crayon::green(num[1,4]))}else{message(crayon::red(num[1,4]))}
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.F) <- colnames(num)
df.F <- rbind(df.F, num)
# explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
# labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
   }
#plot SCALING2
if(plotobjects == TRUE) {
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}

# ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints,Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel,Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("PD_ColonP", "PD_ColonD"), to=c("Proximal","Distal"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=points$P_D)) + scale_colour_manual(values=vesselcolors,name="Colon") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + ylab(paste('PC1',Dim2,"%",sep=" ")) +
  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=PC1),color=neon,label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj+geom_text_repel(data=rdascorevfa,aes(x=RDA1,y=PC1,label=labels
                                                        # vjust=ifelse(PC1>= 0,-0.1,0.7),
                                                        # hjust=ifelse(RDA1>=0,0,0.5)
                                                        ), segment.color = "grey50",
                                   color=linecolour,size=7,parse=TRUE) +geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=PC1),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+ guides(color=guide_legend(ncol=1)) +
  theme(legend.position = leg.F, legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize), 
        legend.title.align = 0.5)
mylegendPDfunctnet<-g_legend(plotobj)
# plotobj <- plotobj + theme(legend.position = "none")
plotobjrdafunctnetPDF <- plotobj + xlim(min(rdascorevfa),max(points$fa+0.2))
if(plotobjects == TRUE) { plotobjrdafunctnetPDF}
# Combine all plots into 1
comboplot <- ggarrange(ggarrange(plotobjrdafunctnetPDA,  plotobjrdafunctnetPDC, plotobjrdafunctnetPDE, 
                                 nrow = 3, labels = c("A","C","E"), 
                                 heights = c(1,0.95,0.95), font.label = list(size = 20), align = "v"),
                       ggarrange(plotobjrdafunctnetPDB, plotobjrdafunctnetPDD,  plotobjrdafunctnetPDF,
                                 nrow = 3, labels = c("B","D","F"), 
                                 heights = c(1,0.95,0.95), font.label = list(size = 20), align = "v"),
                       # ggarrange(mylegendNL, mylegendDo, mylegendPD,
                       #           nrow = 3, labels = c("", "", "")),
                       ncol = 2 
                       # ncol = 3, labels = c("","",""), widths = c(1.5,1.5,0.3)
                       )
comboplot
# saveplots()
# ggsave(plot = comboplot, width = 13.5, height = 15, dpi = 200, filename = "Supplementary_figure20_low_res.png")
# ggsave(plot = comboplot, width = 13.5, height = 15, dpi = 600, filename = "Supplementary_figure20_high_res.tiff")
df.anova.cca.Met <- rbind(df.A, df.B, df.C, df.D, df.E, df.F)
leg.B <- c(0.876,0.25); leg.D <- c(0.93,0.315); leg.F <- c(0.87,0.15)
# rm(df.sub, labelsA, labels)
# rm(plotobj, rdascores, firstaxispoints, secondaxispoints, Dim1, Dim2, Radj, Radj2, df.A, df.B, df.C, df.D, df.E, df.F)
```

## PCoA
```{r Plot_PCoAs, fig.height=10, fig.width=16, include=TRUE}
# Save location of the plots 
saveplots()
fourcolours = c("#d18fa9","#d1b78f","#8fd1b7","#8fa9d1")
# ON GENUS LEVEL
# Ordination graphs  (PCoA or DCA)
## Absolute abundances with QMP 
### PCoA
ord <- ordinate(phylobj.QMP, "PCoA", "bray") 
extract_eigenvalue <- function(ordination) UseMethod("extract_eigenvalue", ordination)
extract_eigenvalue = function(ordination) ordination$values$Relative_eig # for PCoA
eigvec = extract_eigenvalue(ord)
fracvar = eigvec[1:2]/sum(eigvec)
percvar = round(100*fracvar, 0)
plot <- plot_ordination(phylobj.QMP, ord, 
                        
                        color = "Nutrient_Load")
plot <- papertheme(plot, size = 20)
plot <- plot + geom_point(size = 6, alpha = 0.7) +
  # stat_ellipse(aes(fill=factor(Nutrient_Load)), geom="polygon", level=0.95, alpha=0.2) +
  # scale_color_manual (values = fourcolours, name = "Nutrient load") +
  # scale_fill_manual(values = fourcolours, name = "Load") +
  scale_color_manual (values = fourcolours, name = "Nutrient load") +
  scale_fill_manual(values = fourcolours, name = "Load") +
  theme(strip.background =element_rect(fill="#D6E0F4"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20, angle = 270),
        legend.title = element_text(size=20)) +
  guides (size = FALSE) 
strivar <- as(c("PCoA1", "PCoA2"), "character"); strivar <- paste0(strivar, " ", percvar, "%")
plot <- plot + xlab(strivar[1]) + ylab(strivar[2])
# Reorder PD_Colon
newtab = data.table(plot$data)
newtab$PD_Colon <- factor(newtab$PD_Colon, levels = c("P", "D"))
newtab$abund <- rep("Quantitative microbial community ",nrow(newtab)) # make new column
plot$data <- newtab
plot <- plot + 
  facet_grid(cols = vars(abund), rows = vars(PD_Colon), labeller = labeller(Donor = donor.labs, PD_Colon = PD_Colon.labsPC)) +
  theme(legend.position = xxxx)
plot
ggsave(plot = plot, width = 14, height = 10, dpi = 400, filename = "PCOAQMP.png")
phylobj.QMP.prop = subset_samples(phylobj.prop, Nutrient_Load != "FS")
ord2 <- ordinate(phylobj.QMP.prop, "PCoA", "bray")
extract_eigenvalue <- function(ordination) UseMethod("extract_eigenvalue", ordination)
extract_eigenvalue = function(ordination) ordination$values$Relative_eig # for PCoA
eigvec2 = extract_eigenvalue(ord2)
fracvar2 = eigvec2[1:2]/sum(eigvec2)
percvar2 = round(100*fracvar2, 0)
plot2 <- plot_ordination(phylobj.QMP.prop, ord2, color = "Nutrient_Load") 
plot2 <- papertheme(plot2, size = 20)
plot2 <- plot2 + geom_point(size = 6, alpha = 0.7) +
  scale_color_manual (values = fourcolours, name = "Nutrient_load") +
  scale_fill_manual(values = fourcolours, name = "Load") +
  theme(strip.background =element_rect(fill="#D6E0F4"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20, angle = 270),
        legend.title = element_text(size=20)) +
  guides (size = FALSE) 
strivar2 <- as(c("PCoA1", "PCoA2"), "character"); strivar2 <- paste0(strivar2, " ", percvar2, "%")
plot2 <- plot2 + xlab(strivar2[1]) + ylab(strivar2[2])
# Reorder PD_Colon
newtab2 = data.table(plot2$data)
newtab2$PD_Colon <- factor(newtab2$PD_Colon, levels = c("P", "D"))
newtab2$abund <- rep("Proportional microbial community",nrow(newtab2)) # make new column
plot2$data <- newtab2
plot2 <- plot2 + 
  facet_grid(cols = vars(abund), rows = vars(PD_Colon), labeller = labeller(Donor = donor.labs, PD_Colon = PD_Colon.labsPC)) +
  theme(legend.position = "none")
plot2
comboplot <- ggarrange(plot, plot2, ncol = 2, labels = "AUTO", font.label = list(size = 20))
comboplot
# comboplot2 <- comboplot + labs(title = "Day: {current_frame}") +
#   transition_manual(Nutrient_Load.Day, cumulative = TRUE)
# animate(comboplot2, height = 800, width =800)
# # anim_save("animated_PCoA_QMP.gif")
ggsave(plot = comboplot, width = 16, height = 10, dpi = 400, filename = "Figure2.png")
ggsave(plot = comboplot, width = 16, height = 10, dpi = 300, filename = "Figure2_high_res.tiff")
# Relative proportions
Top25 <- subset_samples(phylobj.FS.PD_Colon, Nutrient_Load != "Faecal sample")
Top25 <- aggregate_top_taxa(Top25, top= 15, "Genus")
plot <- plot_bar(Top25, fill="Genus", x= "Nutrient_Load.Day", title="Relative abundance top 25 genera") 
plot <- papertheme(plot)
plot1 <- plot + scale_shape_manual(values=c(15, 16)) +
  facet_grid(PD_Colon~Donor, labeller = labeller(PD_Colon = PD_Colon.labsPC, Donor= donor.labs), scales = "free") +
  # scale_fill_manual(values = colorRampPalette(brewer.pal(26,"Set3"))(26)) +
  scale_fill_manual(values =  desired) +
  labs(color = "Nutrient_Load", shape = "Phase", x = "Time (days)", y = "Relative abundance (%)") +
  guides(color = FALSE) +
  theme(strip.background =element_rect(fill="#D6E0F4"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20),
        # axis.text.x = element_blank(),
        legend.text=element_text(size=15),
        legend.title = element_text(size = 15, face= "bold"),
        legend.title.align = 0.5, 
        legend.box.background = element_rect())
# print(plot1)
ggsave(plot = plot1, width = 25, height = 13, dpi = 300, filename = "prop.genus.png")
# QMP plots
# PCoA facetted
ord <- ordinate(phylobj.QMP, "PCoA", "bray")
plot <- plot_ordination(phylobj.QMP, ord, color = "Donor" , shape = "PD_Colon") 
plot <- papertheme(plot)
plot <- plot + geom_point(size = 4.5, alpha = 0) +
  geom_path() +
  geom_text(mapping = aes(label = Nutrient_Load.Day), size = 10, vjust = 1.5) +
  # stat_ellipse(type = "norm", linetype = 2) +
  # stat_ellipse(type = "t") +
  # ggtitle("PCoA") +
  # xlab("Dimension 1 (29%)") + ylab("Dimension 2 (16.9%)") +
  scale_shape_discrete("PD_Colon", labels = c("Proximal colon", "Distal colon")) +
  # scale_color_manual(values = colorRampPalette( brewer.pal(4, "Accent"))(14)) +
  scale_color_manual(values = sixdonors) +
  facet_wrap(~Donor, labeller = labeller(Donor = donor.labs, PD_Colon = PD_Colon.labsPC), scales = "free") +
  theme(strip.background =element_rect(fill="#D6E0F4"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20), 
        legend.position = "right") 
# plot
# ggsave(plot = plot, width = 25, height = 13, dpi = 300, filename = "pcoa.qmp.png")
# PCoA in days
ord <- ordinate(phylobj.QMP, "PCoA", "bray")
plot <- plot_ordination(phylobj.QMP, ord, color = "Donor", shape = "PD_Colon") 
plot <- papertheme(plot)
plot <- plot + geom_point(size = 6, alpha = 0.7) + 
  # ggtitle("PCoA") +
  scale_shape_discrete("PD_Colon", labels = c("Proximal colon", "Distal colon")) +
    # geom_path() +
  # geom_text(mapping = aes(label = Nutrient_Load.Day), size = 10) +
  scale_color_manual (values = sixdonors) +
  # facet_wrap(~Donor, labeller = labeller(Donor = donor.labs, PD_Colon = PD_Colon.labsPC), scales = "free") +
  theme(strip.background =element_rect(fill="#D6E0F4"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20), 
        legend.position = "right") 
# plot
# ggsave(plot = plot, width = 25, height = 13, dpi = 300, filename = "pcoa.qmp2.png")
# plot <- plot + labs(title = "Day: {current_frame}") +
#   transition_manual(Nutrient_Load.Day, cumulative = TRUE) 
# animate(plot, height = 800, width =800)
# anim_save("animated_PCoA_QMP.gif")
# ON OTU LEVEL
# Ordination graphs  (PCoA or DCA)
## Absolute abundances with QMP 
### PCoA
ord <- ordinate(phylobj.QMP.otu, "PCoA", "bray")
extract_eigenvalue <- function(ordination) UseMethod("extract_eigenvalue", ordination)
extract_eigenvalue = function(ordination) ordination$values$Relative_eig # for PCoA
eigvec = extract_eigenvalue(ord)
fracvar = eigvec[1:2]/sum(eigvec)
percvar = round(100*fracvar, 0)
plot <- plot_ordination(phylobj.QMP.otu, ord, color = "Nutrient_Load") 
plot <- papertheme(plot, size = 20)
plot <- plot + geom_point(size = 6, alpha = 0.7) +
  # stat_ellipse(aes(fill=factor(Nutrient_Load)), geom="polygon", level=0.95, alpha=0.2) +
  scale_color_manual (values = fourcolours, name = "Nutrient load") +
  scale_fill_manual(values = fourcolours, name = "Load") +
  theme(strip.background =element_rect(fill="#D6E0F4"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20, angle = 270),
        legend.title = element_text(size=20)) +
  guides (size = FALSE) 
strivar <- as(c("PCoA1", "PCoA2"), "character"); strivar <- paste0(strivar, " ", percvar, "%")
plot <- plot + xlab(strivar[1]) + ylab(strivar[2])
# Reorder PD_Colon
newtab = data.table(plot$data)
newtab$PD_Colon <- factor(newtab$PD_Colon, levels = c("P", "D"))
newtab$abund <- rep("Quantitative microbial community ",nrow(newtab)) # make new column
plot$data <- newtab
plot <- plot + 
  facet_grid(cols = vars(abund), rows = vars(PD_Colon), labeller = labeller(Donor = donor.labs, PD_Colon = PD_Colon.labsPC)) +
  theme(legend.position = xxxx)
plot
ggsave(plot = plot, width = 14, height = 10, dpi = 300, filename = "pcoa.QMP.png")
phylobj.QMP.prop = subset_samples(phylobj.prop.otu, Nutrient_Load != "FS")
ord2 <- ordinate(phylobj.QMP.prop, "PCoA", "bray")
extract_eigenvalue <- function(ordination) UseMethod("extract_eigenvalue", ordination)
extract_eigenvalue = function(ordination) ordination$values$Relative_eig # for PCoA
eigvec2 = extract_eigenvalue(ord2)
fracvar2 = eigvec2[1:2]/sum(eigvec2)
percvar2 = round(100*fracvar2, 0)
plot2 <- plot_ordination(phylobj.QMP.prop, ord2, color = "Nutrient_Load") 
plot2 <- papertheme(plot2, size = 20)
plot2 <- plot2 + geom_point(size = 6, alpha = 0.7) +
  scale_color_manual (values = fourcolours, name = "Nutrient load") +
  scale_fill_manual(values = fourcolours, name = "Load") +
  theme(strip.background =element_rect(fill="#D6E0F4"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20, angle = 270),
        legend.title = element_text(size=20)) +
  guides (size = FALSE) 
strivar2 <- as(c("PCoA1", "PCoA2"), "character"); strivar2 <- paste0(strivar2, " ", percvar2, "%")
plot2 <- plot2 + xlab(strivar2[1]) + ylab(strivar2[2])
# Reorder PD_Colon
newtab2 = data.table(plot2$data)
newtab2$PD_Colon <- factor(newtab2$PD_Colon, levels = c("P", "D"))
newtab2$abund <- rep("Proportional microbial community",nrow(newtab2)) # make new column
plot2$data <- newtab2
plot2 <- plot2 + 
  facet_grid(cols = vars(abund), rows = vars(PD_Colon), labeller = labeller(Donor = donor.labs, PD_Colon = PD_Colon.labsPC)) +
  theme(legend.position = "none")
plot2
comboplot <- ggarrange(plot, plot2, ncol = 2, labels = "AUTO", font.label = list(size = 20))
comboplot
ggsave(plot = comboplot, width = 16, height = 10, dpi = 200, filename = "pcoa.QMP.prop.otu.png")
rm(ord, plot, plot1, Top25)
```



```{r fig.height=17, fig.width=15}
neon <- c("#2f89fc") ; labelcolour <- c("#fc0202");
labelcolour <- "#fc0202"; plotlabels = F
linecolour <- c("#fc0202"); showR = FALSE
PDcolours <- c("#434e52", "#5b8c85" ) ; ndigits <- 2
legendsize <- 15 ; labelsize <- 6; ygrob <- 0.9; neonsize <- 7; topn <- 15
if(showR == TRUE){xgrob <- 0.85}else{xgrob <- 0.8}; abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62
lefttitle <- " Absolute metabolite production" ; righttitle <- "Proportional metabolite production "
labelsA <- c("Ac","Pr","Bu","Br"); labels <- c("Ac","Pr","Bu")
legendsize <- 18; pointsize = 9; grobsize <- 15; abbrev <- F; plotobjects <- TRUE; plotobjects2 <- F
pos <- position_jitter(width = 0.0, seed = 2)
saveplots()



# test <- subset(test, select = -c(InTransit))
df.1 <- subset(functdatanettrt, Donor ==1 | Donor == 2); df.1$ivTransit <- "STD"
df.2 <- subset(functdatanettrt, Donor ==3 | Donor == 4); df.2$ivTransit <- "MTD"
df.3 <- subset(functdatanettrt, Donor ==5 | Donor == 6); df.3$ivTransit <- "LTD"
test <- rbind(df.1, df.2, df.3)
test$ivTransit <- factor(test$ivTransit) 
functdatanettrt <- test



# Define data frames
df.sub <- subset(functdatanettrt, select = c(Acetate, Propionate, Butyrate, Branched))
sampleinfo <- subset(functdatanettrt, select = c(Transit, Donor, Vessel, ivTransit))
# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub; df.sub <- df.sub
 # rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")
## Perform PCoA
 # pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points
## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 ordi
 ordi$anova
 
test <- ordi[["anova"]]
test <- rownames_to_column(test) %>%
  mutate_all(funs(gsub("[[:punct:]]", "", .)))
test <- test %>%
  mutate_all(funs(gsub(" ", "", .)))
test <- test[1:nrow(test) - 1,]
variables <- test$rowname; message(crayon::green(paste("Hey, your variables are:"))); variables


# Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
# SHIME transit time
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)
 
## permutation test of the results
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])
 
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)
## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Transit" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Transit + Condition(PD_Colon) + Condition(ivTransit), sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = ndigits)
if(showR == TRUE){grob <- grobTree(textGrob(paste("R\u00B2 =",Radj2, "\nR\u00B2 top", topn, "=", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
}else{
  grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
}
## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$PD_Colon, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, 
                                                          size = pointsize, color = Transit), alpha = 0.8) + scale_color_manual("SHIME transit", values = transitcolors, labels = c("Short", "Medium", "Long"))+
   xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
    ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
    geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = RDA2), 
        color = linecolour) + geom_text(data = rdafactor, aes(x = RDA1, y = RDA2), 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
if(plotlabels == T){
if(abbrev == TRUE){
  plotobj <- plotobj + geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = RDA2, 
                                          label = abbreviate(colnames(a),abbnum),
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7), 
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ), 
                                          fill = "grey", alpha = alphnumb, label.size = NA,
                                          color = labelcolour, size = labelsize,
                                          fontface = "italic",
                                          position = pos)
} else { 
      plotobj <- plotobj + geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = RDA2, 
                                          label = colnames(a),
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7), 
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ), 
                                          fill = "grey", 
                                          alpha = alphnumb, 
                                          label.size = NA,
                                          # color = labelcolour, 
                                          size = labelsize,
                                          fontface = "italic",
                                          position = pos)
      }}
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") 
plotobjrdatop15PDD <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))
if(plotobjects == TRUE){plotobjrdatop15PDA}
 
 
 
 
```
