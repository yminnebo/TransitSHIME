---
title: "Good Cell Counting"
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Setup
```{r Set-up, include=TRUE, echo=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = TRUE, #evaluate code and include results
                      #echo = TRUE, #display code with results
                      cache = TRUE,
                      include = TRUE, #include all 
                      collapse = FALSE,
                      dependson = NULL,
                      warning = FALSE,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.align = "center",
                      cache.lazy = FALSE)


# Working directories
dataframedir <- function() setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data")
savedir <- function() setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data/Results") #save results

# Load packages
# library(devtools)
# library(devtools, lib.loc = "/usr/local/lib/R/site-library")
#install_github("rprops/Phenoflow_package") #already installed here!
library("Phenoflow") # for fingerprinting
library("flowViz") # for plotting
library("ggcyto")
library(plyr)
library(dplyr)
library(tibble)
# devtools::install_github("DillonHammill/CytoExploreR")
# install_github("RGLab/flowCore")
# library("CytoExploreR")
library("ggplot2") # for plotting
library("flowAI") # for denoising
library(flowViz)
library("reshape2")
library("gridExtra")
library("tidyr")
library("dplyr") #for data management
library("cowplot")
library('grid')
library(rstatix)
library(gtable)
library(ggpubr)
source("YM_KDP_papertheme.R")
source('gglocator2.R')
library(officer) # to create ppt
source("YM_extrafunctions.R")
source("YM_fusetoplayer.R")
# library(energy)
# library(rvg) # for officer to add ggplots
biexptrans <- flowjo_biexp(maxValue = 262144, widthBasis = -10,pos = 4.5, neg = 0)
biexptrans_inv <- flowjo_biexp(maxValue = 262144, widthBasis = -10,pos = 4.5, neg = 0,inverse=T)

paths <- list("home" = "/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/TransitSHIME", 
            "samples" = "/media/cmetfcm02/Yorick/TransitSHIME/All", 
             "controls" = "/media/projects2/yorick/Rstudio_projects/Archaea_screening/Data/M.smithii")
saveplots <- function () setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data/Results/Plots") #save plots
ppt = TRUE; low_resolution_plots = TRUE

# packageVersion("energy")
# citation("energy")
lblinvivo <- "\U0001d62a\U0001D62F \U0001D637\U0001d62a\U0001D637\U0001D630"
lblInvivo <- "\U0001D43C\U0001D62F \U0001D637\U0001d62a\U0001D637\U0001D630"
# cat(lblinvivo)


# Make supplementary figures in grey values for cheaper printing. For paper make = false
BW = TRUE
```

## labels
```{r labels and colours, message=FALSE, warning=FALSE}
# Universal colours for the project
source("YM_colours.R")

# Labels
PD_Colon.labs <- c("Faecal sample","Proximal colon", "Distal colon")
names(PD_Colon.labs) <- c("FS","P", "D")
PD_Colon.labsPC <- c("Faecal sample","Proximal colon", "Distal colon")
names(PD_Colon.labsPC) <- c("FS","P", "D")
Vessel.labs <- c("Faecal sample","Proximal colon", "Distal colon")
names(Vessel.labs) <- c("FS","P", "D")
Transit.labs <- c("Short transit", "Medium transit", "Long transit")
names(Transit.labs) <- c("ST", "MT", "LT")
donor.labs <- c("Donor 1", "Donor 2", "Donor 3", "Donor 4", "Donor 5", "Donor 6")
names(donor.labs) <- c("1", "2", "3", "4","5","6")
```

#### Graphical abstract tryout
```{r fig.height=4, fig.width=6}
df <- data.frame(Time = c(8,16,24,13,26,39,21,42,63), Transit = c("Short", "Medium", "Long", "Short", "Medium", "Long","Short", "Medium", "Long"), 
                 Vessel = c("Proximal colon", "Proximal colon","Proximal colon",  
                            "Distal colon", "Distal colon", "Distal colon", 
                            "Total colon", "Total colon", "Total colon"))

df$Transit <- as.ordered(factor(df$Transit,levels=c("Short", "Medium", "Long")))
df$Vessel <- as.ordered(factor(df$Vessel,levels=c("Proximal colon", "Distal colon", "Total colon")))
    
  
papertheme(ggplot(df, aes(x = Vessel, y = Time, color = Transit, fill = Transit))) + geom_bar(stat = "identity", position=position_dodge()) + scale_fill_manual(values =  c("Short" ="#7ACD74" , "Medium"="#757BCD", "Long"="#CD747A"))+
  scale_color_manual(values =  c("Short" ="#7ACD74" , "Medium"="#757BCD", "Long"="#CD747A")) +geom_label(aes(label = Time), position = position_dodge(width = .9), color = "black", size = 8) + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.x = element_blank(), legend.position = c(0.15,0.8),panel.border = element_blank(), legend.title = element_blank()) + ylim(0,66)
```



# Prepare data - Samples split per SHIME
## Load data
The measured samples were analysed with a combined Sybr Green(SG) and Propidium iodide (PI) staining to differentiate the intact and damaged fractions. Split flowsets per SHIME run: 1 = donors 1 and 2, 2 = donors 3 and 4, 3 = donors 5 and 6:
```{r Load data split per SHIME run}
## Load metadata
 setwd(paths$home); getwd()
 FCM_FS_SGPI_metadata <- read.csv2("Sampledata_fcm.csv", sep = ",")
 
 # Create data frames per SHIME run
 df1 <- rbind(subset(FCM_FS_SGPI_metadata, Donor == "1"),subset(FCM_FS_SGPI_metadata, Donor == "2"))
 df1 <- subset(df1, Samplename != "Tube_001_0_20190902_165147.fcs")
 
 df2 <- rbind(subset(FCM_FS_SGPI_metadata, Donor == "3"),subset(FCM_FS_SGPI_metadata, Donor == "4"))
 df2 <- subset(df2, Samplename != "Tube_001_40_20191008_163744.fcs")
 
 df3 <- rbind(subset(FCM_FS_SGPI_metadata, Donor == "5"),subset(FCM_FS_SGPI_metadata, Donor == "6"))
 df3 <- subset(df3, Samplename != "Tube_001_80.-5_20191106_160905.fcs")
 
 
 ## revalue donor 4 to 6 and 6 to 4
 FCM_FS_SGPI_metadata$Donor[FCM_FS_SGPI_metadata$Donor == 4] <- 7; FCM_FS_SGPI_metadata$Donor[FCM_FS_SGPI_metadata$Donor == 6] <- 4
 FCM_FS_SGPI_metadata$Donor[FCM_FS_SGPI_metadata$Donor == 7] <- 6; df2$Donor[df2$Donor == 4] <- 6; df3$Donor[df3$Donor == 6] <- 4
 
 
 set.seed(777)
  setwd(paths$samples); getwd(); x = 1
  FCM_FS1 <- read.flowSet(transformation = FALSE, pattern="Tube_001_0_20190902_165147.fcs",path=getwd())
 for (i in df1$Samplename) {
    FCM_FS <- read.flowSet(transformation = FALSE, pattern=i,path=getwd())
    FCM_FS1 <- rbind2(FCM_FS1, FCM_FS) 
    if(x %% 25 ==0){message(paste0(x, "/", length(df1$Samplename)," fcs files extracted", sep = ""))}; x = x+1
  }
  
  FCM_FS2 <- read.flowSet(transformation = FALSE, pattern="Tube_001_40_20191008_163744.fcs",path=getwd())
  for (i in df2$Samplename) {
    FCM_FS <- read.flowSet(transformation = FALSE, pattern=i,path=getwd())
    FCM_FS2 <- rbind2(FCM_FS2, FCM_FS)
    if(x %% 25 ==0){
      message(paste0(x,"/",(length(df2$Samplename)+length(df1$Samplename))," fcs files extracted", sep = ""))}
    x = x+1
  }
  
  FCM_FS3 <- read.flowSet(transformation = FALSE, pattern="Tube_001_80.-5_20191106_160905.fcs",path=getwd())
  for (i in df3$Samplename) {
    FCM_FS <- read.flowSet(transformation = FALSE, pattern=i,path=getwd())
    FCM_FS3 <- rbind2(FCM_FS3, FCM_FS)
    if(x %% 25 ==0){message(paste0(x,"/", (length(df2$Samplename)+length(df1$Samplename)+length(df3$Samplename)),
                           " fcs files extracted", sep = ""))}; x = x+1
  }
  cat(crayon::yellow(whale3))
  
  
  
  setwd(paths$samples)
  # attributes(FCM_FS1); attributes(FCM_FS2); attributes(FCM_FS3)
  colnames(FCM_FS1) <- mapvalues(colnames(FCM_FS1),
                                 from=c('FITC-A','PerCP-Cy5.5-A'),to=c('SG-A','PropIod-A'))
  colnames(FCM_FS2) <- mapvalues(colnames(FCM_FS2),
                                 from=c('FITC-A','PerCP-Cy5.5-A'),to=c('SG-A','PropIod-A'))
  colnames(FCM_FS3) <- mapvalues(colnames(FCM_FS3),
                                 from=c('FITC-A','PerCP-Cy5.5-A'),to=c('SG-A','PropIod-A'))
  
  ### Extract and adjust sample names 
 test <- rbind(data.frame(Names = flowFP::sampleNames(FCM_FS1), SHIME = "1"), 
               data.frame(Names = flowFP::sampleNames(FCM_FS2), SHIME = "2"),
               data.frame(Names = flowFP::sampleNames(FCM_FS3), SHIME = "3"))
               
 setwd(paths$home); write.csv2(file="FCMnames.csv", test)
 
 sampleNames(FCM_FS1) <- as.character(FCM_FS_SGPI_metadata[match(flowFP::sampleNames(FCM_FS1),
                                        as.character(FCM_FS_SGPI_metadata$Samplename)),]$Name)
 FCM_FS1@phenoData@data[["name"]] <- as.character(FCM_FS_SGPI_metadata[match(FCM_FS1@phenoData@data[["name"]],                                                                      as.character(FCM_FS_SGPI_metadata$Samplename)),]$Name)
 
 sampleNames(FCM_FS2) <- as.character(FCM_FS_SGPI_metadata[match(flowFP::sampleNames(FCM_FS2),
                                        as.character(FCM_FS_SGPI_metadata$Samplename)),]$Name)
 FCM_FS2@phenoData@data[["name"]] <- as.character(FCM_FS_SGPI_metadata[match(FCM_FS2@phenoData@data[["name"]],                                                                      as.character(FCM_FS_SGPI_metadata$Samplename)),]$Name)
 
 sampleNames(FCM_FS3) <- as.character(FCM_FS_SGPI_metadata[match(flowFP::sampleNames(FCM_FS3),
                                        as.character(FCM_FS_SGPI_metadata$Samplename)),]$Name)
 FCM_FS3@phenoData@data[["name"]] <- as.character(FCM_FS_SGPI_metadata[match(FCM_FS3@phenoData@data[["name"]],                                                                      as.character(FCM_FS_SGPI_metadata$Samplename)),]$Name)
 
  
### Extract measured sample volume (and divide by 1000 to convert to µL)
 FCM_FS1_metadata_volume <- data.frame()
 for (i in flowFP::sampleNames(FCM_FS1)){
   Volume <- FCM_FS1@frames[[i]]@description$VOL
   Volumei <- cbind(FCM_FS_SGPI_metadata[FCM_FS_SGPI_metadata$Name==i,],
                    Volume=as.numeric(Volume)/1000)
   FCM_FS1_metadata_volume <- rbind(FCM_FS1_metadata_volume,Volumei)}
 
 FCM_FS1_metadata_volume$Name <- as.character(FCM_FS1_metadata_volume$Name)
 FCM_FS1_metadata_volume$Volume2 <- 
   FCM_FS1_metadata_volume$Volume * 10^FCM_FS1_metadata_volume$Dilution
 FCM_FS2_metadata_volume <- data.frame()
 for (i in flowFP::sampleNames(FCM_FS2)){
   Volume <- FCM_FS2@frames[[i]]@description$VOL
   Volumei <- cbind(FCM_FS_SGPI_metadata[FCM_FS_SGPI_metadata$Name==i,],
                    Volume=as.numeric(Volume)/1000)
   FCM_FS2_metadata_volume <- rbind(FCM_FS2_metadata_volume,Volumei)}
 
 FCM_FS2_metadata_volume$Name <- as.character(FCM_FS2_metadata_volume$Name)
 FCM_FS2_metadata_volume$Volume2 <- 
   FCM_FS2_metadata_volume$Volume * 10^FCM_FS2_metadata_volume$Dilution
 
 
 FCM_FS3_metadata_volume <- data.frame()
 for (i in flowFP::sampleNames(FCM_FS3)){
   Volume <- FCM_FS3@frames[[i]]@description$VOL
   Volumei <- cbind(FCM_FS_SGPI_metadata[FCM_FS_SGPI_metadata$Name==i,],
                    Volume=as.numeric(Volume)/1000)
   FCM_FS3_metadata_volume <- rbind(FCM_FS3_metadata_volume,Volumei)}
 
 FCM_FS3_metadata_volume$Name <- as.character(FCM_FS3_metadata_volume$Name)
 FCM_FS3_metadata_volume$Volume2 <- 
   FCM_FS3_metadata_volume$Volume * 10^FCM_FS3_metadata_volume$Dilution
 
 ## Combine volume metadata
 FCM_FS_SGPI_metadata_volume <- rbind(FCM_FS1_metadata_volume, FCM_FS2_metadata_volume, FCM_FS3_metadata_volume)
 
 
### Select parameters of interest
 param=c("SG-A", "PropIod-A","SSC-A","FSC-A")
 FCM_FS1 = FCM_FS1[,param]; FCM_FS2 = FCM_FS2[,param]; FCM_FS3 = FCM_FS3[,param]
```

## Gate samples
The loaded samples are gated through the interactive ggcyto package citation("ggcyto"):
```{r Gate samples split per SHIME run}
# Used flowset 
FS_SGPI1 <- FCM_FS1; flowFP::sampleNames(FS_SGPI1)
FS_SGPI2 <- FCM_FS2; flowFP::sampleNames(FS_SGPI2)
FS_SGPI3 <- FCM_FS3; flowFP::sampleNames(FS_SGPI3)
# SHIME1
# Create a gating set to add the below generated gates
  gs_FS <- GatingSet(FS_SGPI1)
 
# SG versus PI plot to identify the living and dead subpopulation 
  ## Define x and y-limits
  xmin <- -50; xmax <- 3*10^5; ymin <- -500; ymax <- 3*10^5
  ggcytolimits <- ggcyto_par_set(limits = list(x = c(xmin,xmax), y = c(ymin,ymax)))
  xminbiexp <-  biexptrans(xmin); xmaxbiexp <-  biexptrans(xmax)
  yminbiexp <-  biexptrans(ymin); ymaxbiexp <-  biexptrans(ymax)
      
  ## Plots to manually draw gates
  samplenumber <- "173.2"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPI1[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) +
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + 
          ggcytolimits)) + theme(strip.text = element_blank(),plot.title=element_blank())  
  SGPI
  SGPI_Background_gate <- gglocator(SGPI,15)
  
  samplenumber <- "173.2"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPI1[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) + 
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + ggcytolimits)) +
  theme(strip.text = element_blank(),plot.title=element_blank())  
  # SGPI
  SGPI_DMG_gate <- gglocator(SGPI,15); SGPI_INT_gate <- gglocator(SGPI,15)
  dev.off()
         
  ## Intact, damaged and background
  SGPI_DMG_gate[,1] <- biexptrans_inv(SGPI_DMG_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_DMG_gate[,2] <- biexptrans_inv(SGPI_DMG_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_DMG_gate <- as.matrix(SGPI_DMG_gate)
  colnames(SGPI_DMG_gate) <- c("SG-A","PropIod-A")
  SGPI_DMG_polygate <- polygonGate(.gate=SGPI_DMG_gate, filterId = "DMG")
  SGPI_Background_gate[,1] <- biexptrans_inv(SGPI_Background_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_Background_gate[,2] <- biexptrans_inv(SGPI_Background_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_Background_gate <- as.matrix(SGPI_Background_gate)
  colnames(SGPI_Background_gate) <- c("SG-A","PropIod-A")
  SGPI_Background_polygate <- polygonGate(.gate=SGPI_Background_gate, filterId = "Background")
  SGPI_INT_gate[,1] <- biexptrans_inv(SGPI_INT_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_INT_gate[,2] <- biexptrans_inv(SGPI_INT_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_INT_gate <- as.matrix(SGPI_INT_gate)
  colnames(SGPI_INT_gate) <- c("SG-A","PropIod-A")
  SGPI_INT_polygate <- polygonGate(.gate=SGPI_INT_gate, filterId = "INT")
  
  gs_FS_gate1 <- gs_pop_add(gs_FS,SGPI_INT_polygate)
  gs_FS_gate2 <- gs_pop_add(gs_FS,SGPI_DMG_polygate)
  gs_FS_gate3 <- gs_pop_add(gs_FS,SGPI_Background_polygate)
  recompute(gs_FS)
  
  ## Save the gating
  setwd(paths$home); write.csv(SGPI_INT_gate,paste(paths$home,"/SGPI_INTgate1.csv",sep=""))
  write.csv(SGPI_DMG_gate,paste(paths$home,"/SGPI_DMGgate1.csv",sep=""))
  write.csv(SGPI_Background_gate,paste(paths$home,"/SGPI_Backgroundgate1.csv",sep=""))
  
#SHIME2
# Create a gating set to add the below generated gates
  gs_FS <- GatingSet(FS_SGPI2)
 
# SG versus PI plot to identify the living and dead subpopulation 
  ## Define x and y-limits
  xmin <- -50; xmax <- 3*10^5; ymin <- -500; ymax <- 3*10^5
  ggcytolimits <- ggcyto_par_set(limits = list(x = c(xmin,xmax), y = c(ymin,ymax)))
  xminbiexp <-  biexptrans(xmin); xmaxbiexp <-  biexptrans(xmax)
  yminbiexp <-  biexptrans(ymin); ymaxbiexp <-  biexptrans(ymax)
      
  ## Plots to manually draw gates
  samplenumber <- "326.2"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPI[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) +
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + 
          ggcytolimits)) + theme(strip.text = element_blank(),plot.title=element_blank())  
  SGPI
  SGPI_Background_gate <- gglocator(SGPI,15)
  
  samplenumber <- "326.2"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPI[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) + 
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + ggcytolimits)) +
  theme(strip.text = element_blank(),plot.title=element_blank())  
  # SGPI
  SGPI_DMG_gate <- gglocator(SGPI,15); SGPI_INT_gate <- gglocator(SGPI,15)
  dev.off()
         
  ## Intact, damaged and background
  SGPI_DMG_gate[,1] <- biexptrans_inv(SGPI_DMG_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_DMG_gate[,2] <- biexptrans_inv(SGPI_DMG_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_DMG_gate <- as.matrix(SGPI_DMG_gate)
  colnames(SGPI_DMG_gate) <- c("SG-A","PropIod-A")
  SGPI_DMG_polygate <- polygonGate(.gate=SGPI_DMG_gate, filterId = "DMG")
  SGPI_Background_gate[,1] <- biexptrans_inv(SGPI_Background_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_Background_gate[,2] <- biexptrans_inv(SGPI_Background_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_Background_gate <- as.matrix(SGPI_Background_gate)
  colnames(SGPI_Background_gate) <- c("SG-A","PropIod-A")
  SGPI_Background_polygate <- polygonGate(.gate=SGPI_Background_gate, filterId = "Background")
  SGPI_INT_gate[,1] <- biexptrans_inv(SGPI_INT_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_INT_gate[,2] <- biexptrans_inv(SGPI_INT_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_INT_gate <- as.matrix(SGPI_INT_gate)
  colnames(SGPI_INT_gate) <- c("SG-A","PropIod-A")
  SGPI_INT_polygate <- polygonGate(.gate=SGPI_INT_gate, filterId = "INT")
  
  gs_FS_gate1 <- gs_pop_add(gs_FS,SGPI_INT_polygate)
  gs_FS_gate2 <- gs_pop_add(gs_FS,SGPI_DMG_polygate)
  gs_FS_gate3 <- gs_pop_add(gs_FS,SGPI_Background_polygate)
  recompute(gs_FS)
  
  ## Save the gating
  setwd(paths$home); write.csv(SGPI_INT_gate,paste(paths$home,"/SGPI_INTgate2.csv",sep=""))
  write.csv(SGPI_DMG_gate,paste(paths$home,"/SGPI_DMGgate2.csv",sep=""))
  write.csv(SGPI_Background_gate,paste(paths$home,"/SGPI_Backgroundgate2.csv",sep=""))
  
#SHIME3
# Create a gating set to add the below generated gates
  gs_FS <- GatingSet(FS_SGPI3)
 
# SG versus PI plot to identify the living and dead subpopulation 
  ## Define x and y-limits
  xmin <- -50; xmax <- 3*10^5; ymin <- -500; ymax <- 3*10^5
  ggcytolimits <- ggcyto_par_set(limits = list(x = c(xmin,xmax), y = c(ymin,ymax)))
  xminbiexp <-  biexptrans(xmin); xmaxbiexp <-  biexptrans(xmax)
  yminbiexp <-  biexptrans(ymin); ymaxbiexp <-  biexptrans(ymax)
      
  ## Plots to manually draw gates
  samplenumber <- "503.1"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPI[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) +
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + 
          ggcytolimits)) + theme(strip.text = element_blank(),plot.title=element_blank()) +
    ggtitle(samplenumber)
  SGPI; SGPI_Background_gate <- gglocator(SGPI,15)
  
  samplenumber <- "503.1"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPI[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) + 
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + ggcytolimits)) +
  theme(strip.text = element_blank(),plot.title=element_blank())+ggtitle(samplenumber) 
  # SGPI
  SGPI_DMG_gate <- gglocator(SGPI,15); SGPI_INT_gate <- gglocator(SGPI,15)
  dev.off()
         
  ## Intact, damaged and background
  SGPI_DMG_gate[,1] <- biexptrans_inv(SGPI_DMG_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_DMG_gate[,2] <- biexptrans_inv(SGPI_DMG_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_DMG_gate <- as.matrix(SGPI_DMG_gate)
  colnames(SGPI_DMG_gate) <- c("SG-A","PropIod-A")
  SGPI_DMG_polygate <- polygonGate(.gate=SGPI_DMG_gate, filterId = "DMG")
  SGPI_Background_gate[,1] <- biexptrans_inv(SGPI_Background_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_Background_gate[,2] <- biexptrans_inv(SGPI_Background_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_Background_gate <- as.matrix(SGPI_Background_gate)
  colnames(SGPI_Background_gate) <- c("SG-A","PropIod-A")
  SGPI_Background_polygate <- polygonGate(.gate=SGPI_Background_gate, filterId = "Background")
  SGPI_INT_gate[,1] <- biexptrans_inv(SGPI_INT_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_INT_gate[,2] <- biexptrans_inv(SGPI_INT_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_INT_gate <- as.matrix(SGPI_INT_gate)
  colnames(SGPI_INT_gate) <- c("SG-A","PropIod-A")
  SGPI_INT_polygate <- polygonGate(.gate=SGPI_INT_gate, filterId = "INT")
  
  gs_FS_gate1 <- gs_pop_add(gs_FS,SGPI_INT_polygate)
  gs_FS_gate2 <- gs_pop_add(gs_FS,SGPI_DMG_polygate)
  gs_FS_gate3 <- gs_pop_add(gs_FS,SGPI_Background_polygate)
  recompute(gs_FS)
  
  ## Save the gating
  setwd(paths$home); write.csv(SGPI_INT_gate,paste(paths$home,"/SGPI_INTgate3.csv",sep=""))
  write.csv(SGPI_DMG_gate,paste(paths$home,"/SGPI_DMGgate3.csv",sep=""))
  write.csv(SGPI_Background_gate,paste(paths$home,"/SGPI_Backgroundgate3.csv",sep=""))
```


## Check gating
Check gating and put into powerpoint to manually check
```{r Check gating split per SHIME run}
# Used flowset 
FS_SGPI1 <- FCM_FS1; flowFP::sampleNames(FS_SGPI1)
FS_SGPI2 <- FCM_FS2; flowFP::sampleNames(FS_SGPI2)
FS_SGPI3 <- FCM_FS3; flowFP::sampleNames(FS_SGPI3)
# SG versus PI plot to identify the living and dead subpopulation 
  ## Define x and y-limits
  xmin <- -50; xmax <- 3*10^5; ymin <- -500; ymax <- 3*10^5
  ggcytolimits <- ggcyto_par_set(limits = list(x = c(xmin,xmax), y = c(ymin,ymax)))
  xminbiexp <-  biexptrans(xmin); xmaxbiexp <-  biexptrans(xmax)
  yminbiexp <-  biexptrans(ymin); ymaxbiexp <-  biexptrans(ymax)
  
  
# formatR::tidy_app()
# Load gates defined in the csv file
 ## SHIME1
  SGPI_DMG_gate1 <- as.matrix(read.csv(paste(paths$home,"/SGPI_DMGgate1.csv",sep="")))[,-1]
  colnames(SGPI_DMG_gate1) <- c("SG-A","PropIod-A")
  SGPI_DMG_polygate1 <- polygonGate(.gate=SGPI_DMG_gate1, filterId = "DMG")
  SGPI_Background_gate1 <- as.matrix(read.csv(paste(paths$home,"/SGPI_Backgroundgate1.csv",sep="")))[,-1]
  colnames(SGPI_Background_gate1) <- c("SG-A","PropIod-A")
  SGPI_Background_polygate1 <- polygonGate(.gate=SGPI_Background_gate1, filterId = "Background")
  SGPI_INT_gate1 <- as.matrix(read.csv(paste(paths$home,"/SGPI_INTgate1.csv",sep="")))[,-1]
  colnames(SGPI_INT_gate1) <- c("SG-A","PropIod-A")
  SGPI_INT_polygate1 <- polygonGate(.gate=SGPI_INT_gate1, filterId = "INT")
  
  gs_FS1 <- GatingSet(FS_SGPI1)
  gs_FS_gate3 <- gs_pop_add(gs_FS1,SGPI_INT_polygate1)
  gs_FS_gate5 <- gs_pop_add(gs_FS1,SGPI_DMG_polygate1)
  gs_FS_gate6 <- gs_pop_add(gs_FS1,SGPI_Background_polygate1)
  recompute(gs_FS1); flowWorkspace::plot(gs_FS1); i = "81.1"
  autoplot(gs_FS1[i],x = "SG-A", y = "PropIod-A", 
           gate = c("INT","DMG","Background"), bins = 100, title = i) + 
  scale_x_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") +
  scale_y_flowjo_biexp(expand=c(0,0)) + ggcytolimits
  
 ## SHIME2
  SGPI_DMG_gate2 <- as.matrix(read.csv(paste(paths$home,"/SGPI_DMGgate2.csv",sep="")))[,-1]
  colnames(SGPI_DMG_gate2) <- c("SG-A","PropIod-A")
  SGPI_DMG_polygate2 <- polygonGate(.gate=SGPI_DMG_gate2, filterId = "DMG")
  SGPI_Background_gate2 <- as.matrix(read.csv(paste(paths$home,"/SGPI_Backgroundgate2.csv",sep="")))[,-1]
  colnames(SGPI_Background_gate2) <- c("SG-A","PropIod-A")
  SGPI_Background_polygate2 <- polygonGate(.gate=SGPI_Background_gate2, filterId = "Background")
  SGPI_INT_gate2 <- as.matrix(read.csv(paste(paths$home,"/SGPI_INTgate2.csv",sep="")))[,-1]
  colnames(SGPI_INT_gate2) <- c("SG-A","PropIod-A")
  SGPI_INT_polygate2 <- polygonGate(.gate=SGPI_INT_gate2, filterId = "INT")
  
  gs_FS2 <- GatingSet(FS_SGPI2)
  gs_FS_gate3 <- gs_pop_add(gs_FS2,SGPI_INT_polygate2)
  gs_FS_gate5 <- gs_pop_add(gs_FS2,SGPI_DMG_polygate2)
  gs_FS_gate6 <- gs_pop_add(gs_FS2,SGPI_Background_polygate2)
  recompute(gs_FS2); flowWorkspace::plot(gs_FS2); i = "231.1"
  autoplot(gs_FS2[i],x = "SG-A", y = "PropIod-A", 
           gate = c("INT","DMG","Background"), bins = 100, title = i) + 
  scale_x_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") +
  scale_y_flowjo_biexp(expand=c(0,0)) + ggcytolimits  
  
 ## SHIME3
  SGPI_DMG_gate3 <- as.matrix(read.csv(paste(paths$home,"/SGPI_DMGgate3.csv",sep="")))[,-1]
  colnames(SGPI_DMG_gate3) <- c("SG-A","PropIod-A")
  SGPI_DMG_polygate3 <- polygonGate(.gate=SGPI_DMG_gate3, filterId = "DMG")
  SGPI_Background_gate3 <- as.matrix(read.csv(paste(paths$home,"/SGPI_Backgroundgate3.csv",sep="")))[,-1]
  colnames(SGPI_Background_gate3) <- c("SG-A","PropIod-A")
  SGPI_Background_polygate3 <- polygonGate(.gate=SGPI_Background_gate3, filterId = "Background")
  SGPI_INT_gate3 <- as.matrix(read.csv(paste(paths$home,"/SGPI_INTgate3.csv",sep="")))[,-1]
  colnames(SGPI_INT_gate3) <- c("SG-A","PropIod-A")
  SGPI_INT_polygate3 <- polygonGate(.gate=SGPI_INT_gate3, filterId = "INT")
  
  gs_FS3 <- GatingSet(FS_SGPI3)
  gs_FS_gate3 <- gs_pop_add(gs_FS3,SGPI_INT_polygate3)
  gs_FS_gate5 <- gs_pop_add(gs_FS3,SGPI_DMG_polygate3)
  gs_FS_gate6 <- gs_pop_add(gs_FS3,SGPI_Background_polygate3)
  recompute(gs_FS3); flowWorkspace::plot(gs_FS3); i = "503.2"
  autoplot(gs_FS3[i],x = "SG-A", y = "PropIod-A", 
           gate = c("INT","DMG","Background"), bins = 100, title = i) + 
  scale_x_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") +
  scale_y_flowjo_biexp(expand=c(0,0)) + ggcytolimits  
  
## Check gating
  plotthem = F
  if(plotthem == T){
  
if (low_resolution_plots == TRUE){
  listSGPI_FS <- list()
 total <- length(flowFP::sampleNames(FS_SGPI1)) + length(flowFP::sampleNames(FS_SGPI2)) +
   length(flowFP::sampleNames(FS_SGPI3)); x <- 1
 L1 <- length(flowFP::sampleNames(FS_SGPI1)) 
 L2 <- length(flowFP::sampleNames(FS_SGPI1)) + length(flowFP::sampleNames(FS_SGPI2))
 if(x < (L1 + 1)){
  for (i in as.vector(flowFP::sampleNames(FS_SGPI1))){
   SGPI2 <- papertheme(as.ggplot(ggcyto(gs_FS1[i], aes(x = `SG-A`, y = "PropIod-A")) + 
    geom_hex(bins = 100) + geom_gate("INT", colour = "green") + geom_gate("DMG", colour = "red") +
    geom_gate("Background", colour = "blue") + scale_x_flowjo_biexp(expand = c(0, 0)) +
    scale_y_flowjo_biexp(expand = c(0,0)) + xlab("SG") + ylab("PI") + ggcytolimits)) + 
    ggtitle(paste0("SHIME1, Sample",i, sep = "")) + theme(legend.position = "none")+
     theme(strip.text = element_blank()); listSGPI_FS[[x]] <- SGPI2
   if (x%%50 == 0){message(crayon::green(paste0(x, "/", total, sep = "")))}
   if (total/x == 2){print(paste0("Over halfway: ", x, "/", total, sep = ""))}
   if (x%%801 == 0){print(paste0("Almost there: ", x, "/", total, sep = ""))}
   x <- x + 1
  }
 }
 if(x > L1 & x < (L2+1)){
   for (i in as.vector(flowFP::sampleNames(FS_SGPI2))){
    SGPI2 <- papertheme(as.ggplot(ggcyto(gs_FS2[i], aes(x = `SG-A`, y = "PropIod-A")) + 
      geom_hex(bins = 100) + geom_gate("INT", colour = "green") + geom_gate("DMG", colour = "red") +
      geom_gate("Background", colour = "blue") + scale_x_flowjo_biexp(expand = c(0, 0)) +
      scale_y_flowjo_biexp(expand = c(0,0)) + xlab("SG") + ylab("PI") + ggcytolimits)) + 
      ggtitle(paste0("SHIME2, Sample",i, sep = "")) + theme(legend.position = "none")+
      theme(strip.text = element_blank()); listSGPI_FS[[x]] <- SGPI2
    if (x%%50 == 0){message(crayon::yellow(paste0(x, "/", total, sep = "")))}
    if (total/x == 2){print(paste0("Over halfway: ", x, "/", total, sep = ""))}
    if (x%%801 == 0){print(paste0("Almost there: ", x, "/", total, sep = ""))}
    x <- x + 1
   }
  }
 if(x > L2){
    for (i in as.vector(flowFP::sampleNames(FS_SGPI3))){
    SGPI2 <- papertheme(as.ggplot(ggcyto(gs_FS3[i], aes(x = `SG-A`, y = "PropIod-A")) + 
     geom_hex(bins = 100) + geom_gate("INT", colour = "green") + geom_gate("DMG", colour = "red") +
     geom_gate("Background", colour = "blue") + scale_x_flowjo_biexp(expand = c(0, 0)) +
     scale_y_flowjo_biexp(expand = c(0,0)) + xlab("SG") + ylab("PI") + ggcytolimits)) + 
     ggtitle(paste0("SHIME3, Sample",i, sep = "")) + theme(legend.position = "none")+ 
     theme(strip.text = element_blank()); listSGPI_FS[[x]] <- SGPI2
    if (x%%50 == 0){message(crayon::red(paste0(x, "/", total, sep = "")))}
    if (total/x == 2){print(paste0("Over halfway: ", x, "/", total, sep = ""))}
    if (x%%801 == 0){message(crayon::blue(paste0("Almost there: ", x, "/", total, sep = "")))}
    if (x == total){message(crayon::blue(paste0("Done ", x, "/", total, sep = "")))}
    x <- x + 1
   }
  }
 } else{
 for (i in as.vector(flowFP::sampleNames(FS_SGPI))) {
  SGPI2 <- papertheme(as.ggplot(ggcyto(gs_FS[i], aes(x = `SG-A`, y = "PropIod-A")) + 
   geom_hex(binwidth = c(10,10)) + geom_gate("INT", colour = "green") + 
     geom_gate("DMG", colour = "red") + geom_gate("Background", colour = "blue") +
     scale_x_flowjo_biexp(expand = c(0, 0)) +
   scale_y_flowjo_biexp(expand = c(0,0)) + xlab("SG") + ylab("PI") + ggcytolimits)) + 
   ggtitle(i) + theme(strip.text = element_blank()); listSGPI_FS[[i]] <- SGPI2
  # print(SGPI2)
  if (x%%20 == 0){print(paste0(x, "/", y, sep = ""))}
  x <- x + 1
 }
}
  # Make combinedlist into 4 per figure
  backuplist <- listSGPI_FS
  listSGPIcombined <- list();length(listSGPI_FS) 
  for(i in 1:ceiling((856/4))){
    i = i*4
    x = i - 1
    y = x - 1
    z = y - 1
    if(i < length(listSGPI_FS)) {
    listSGPIcombined[[(i/4)]] <- ggarrange(backuplist[[z]], backuplist[[y]] ,
                                           backuplist[[x]] ,backuplist[[i]] , nrow = 2, ncol = 2)
    if(i%%48==0){message(paste0("Combined ",i,"/",length(listSGPI_FS), " figures", sep = ""))}
    }else{
    listSGPIcombined[[(i/4)]] <- ggarrange(backuplist[[x]], nrow = 2, ncol = 2)
    }
  }
 
 ppt = F
  if(ppt == TRUE){
    setwd(paths$home)
    ppt_presentation <- read_pptx()
    for(i in 1: length(listSGPIcombined)) {
      plot <- ggarrange(list)
      ppt_presentation <- add_slide(ppt_presentation,
                                    layout="Title and Content", master="Office Theme") %>%
        ph_with(res = 50,  value = listSGPIcombined[[i]],
                # location = ph_location_type(type = "body")
                location = ph_location_fullsize()
                )
      if(i%%20==0){message(paste0("Saved ",i,"/",length(listSGPIcombined), sep = ""))}
      # if(i%%24==0){message(paste0("Combined ",i,"/",length(listSGPIcombined), sep = ""))}
      # if(i%%13==0){message(paste0("Combined ",i,"/",length(listSGPIcombined), sep = ""))}
      if(i==length(listSGPIcombined)){message(paste0("Done!", sep = ""))}
      }
    ppt_presentation <- ppt_presentation %>% print(target = "gatingSGPI.pptx")
  }
  }
  rm(plotthem)
```


## TruCount samples - Already run by yours truly!
The volumes of some samples could not be measured in SHIME run 2. TruCount beads were therefore used to measure them. 
```{r TruCount extraction-Already run!}
# Import metadata file
wdir()
TruCount_metadata <- read.csv2("Sampledata_TruCount.csv", sep = ","); TruCount_metadata <- TruCount_metadata[complete.cases(TruCount_metadata), ]
## revalue donor 4 to 6
 TruCount_metadata$Donor[TruCount_metadata$Donor == 4] <- 6
# Import fcs files
FCM_TruCount <- read.flowSet(transformation = FALSE, pattern=".fcs",path="/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data/FCM/TruCount")
  message("Done! TruCount: 23 fcs files extracted"); attributes(FCM_TruCount)
  
# Rename column names
colnames(FCM_TruCount) <- mapvalues(colnames(FCM_TruCount),
                                 from=c('FITC-A','PerCP-Cy5.5-A'),to=c('SG-A','PropIod-A'))
# Extract sample names  
samplenames <- data.frame(Names = flowFP::sampleNames(FCM_TruCount), SHIME = "2")
  
  
# Add sample names to the data
sampleNames(FCM_TruCount) <- as.character(TruCount_metadata[match(flowFP::sampleNames(FCM_TruCount),
                                        as.character(TruCount_metadata$Samplename)),]$Name)
FCM_TruCount@phenoData@data[["name"]] <-
   as.character(TruCount_metadata[match(FCM_TruCount@phenoData@data[["name"]],                                                                      as.character(TruCount_metadata$Samplename)),]$Name)
 
param=c("SG-A", "PropIod-A","SSC-A","FSC-A")
FCM_TruCount = FCM_TruCount[,param]
# Used flowset 
FS_SGPITrue <- FCM_TruCount; flowFP::sampleNames(FS_SGPITrue)
# Create a gating set to add the below generated gates
 gs_FS <- GatingSet(FS_SGPITrue)
 
# SG versus PI plot to identify the living and dead subpopulation 
  ## Define x and y-limits
  xmin <- -50; xmax <- 3*10^5; ymin <- -500; ymax <- 3*10^5
  ggcytolimits <- ggcyto_par_set(limits = list(x = c(xmin,xmax), y = c(ymin,ymax)))
  xminbiexp <-  biexptrans(xmin); xmaxbiexp <-  biexptrans(xmax)
  yminbiexp <-  biexptrans(ymin); ymaxbiexp <-  biexptrans(ymax)
      
  ## Plots to manually draw gates
  samplenumber <- "300.2"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPITrue[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) +
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + 
          ggcytolimits)) + theme(strip.text = element_blank(),plot.title=element_blank())  
  SGPI
  TruCount_gate <- gglocator(SGPI,15)
  dev.off()
  ## TruCount
  TruCount_gate[,1] <- biexptrans_inv(TruCount_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  TruCount_gate[,2] <- biexptrans_inv(TruCount_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  TruCount_gate <- as.matrix(TruCount_gate)
  colnames(TruCount_gate) <- c("SG-A","PropIod-A")
  SGPI_TruCount_polygate <- polygonGate(.gate=TruCount_gate, filterId = "TC")
  
  gs_FS_gate1 <- gs_pop_add(gs_FS,SGPI_TruCount_polygate); recompute(gs_FS)
  TCvolumes <- data.frame(gs_pop_get_count_fast(gs_FS,statistic="count"))
# Extract measured sample volume (and divide by 1000 to convert to µL)
TruCount_metadata_volume <- data.frame()
for (i in flowFP::sampleNames(FCM_TruCount)){
  test <- subset(TCvolumes, name == i)
 Volume <- test$Count*(300/47800)
 Volumei <- cbind(TruCount_metadata[TruCount_metadata$Name==i,],
                    Volume=as.numeric(Volume))
 TruCount_metadata_volume <- rbind(TruCount_metadata_volume,Volumei)}
 
TruCount_metadata_volume$Name <- as.character(TruCount_metadata_volume$Name)
TruCount_metadata_volume$Volume2 <- TruCount_metadata_volume$Volume * 10^TruCount_metadata_volume$Dilution
# Select parameters of interest
param=c("SG-A", "PropIod-A","SSC-A","FSC-A")
FCM_TruCount = FCM_TruCount[,param]
# Gate samples no truly
# Create a gating set to add the below generated gates
  gs_FS <- GatingSet(FS_SGPITrue)
 
# SG versus PI plot to identify the living and dead subpopulation 
  ## Define x and y-limits
  xmin <- -50; xmax <- 3*10^5; ymin <- -500; ymax <- 3*10^5
  ggcytolimits <- ggcyto_par_set(limits = list(x = c(xmin,xmax), y = c(ymin,ymax)))
  xminbiexp <-  biexptrans(xmin); xmaxbiexp <-  biexptrans(xmax)
  yminbiexp <-  biexptrans(ymin); ymaxbiexp <-  biexptrans(ymax)
    
  samplenumber <- "300.2"
  SGPI <- papertheme(as.ggplot(ggcyto(FS_SGPITrue[samplenumber],aes(x = `SG-A`, y = `PropIod-A`)) +
          geom_hex(binwidth=c(10,10)) + scale_x_flowjo_biexp(expand=c(0,0)) +
          scale_y_flowjo_biexp(expand=c(0,0)) + xlab("SG") + ylab("PI") + 
          ggcytolimits)) + theme(strip.text = element_blank(),plot.title=element_blank())  
  SGPI
  SGPI_Background_gate <- gglocator(SGPI,15)
  SGPI_DMG_gate <- gglocator(SGPI,15)
  SGPI_INT_gate <- gglocator(SGPI,15)
  dev.off()
  
         
  ## Intact, damaged and background
  SGPI_DMG_gate[,1] <- biexptrans_inv(SGPI_DMG_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_DMG_gate[,2] <- biexptrans_inv(SGPI_DMG_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_DMG_gate <- as.matrix(SGPI_DMG_gate)
  colnames(SGPI_DMG_gate) <- c("SG-A","PropIod-A")
  SGPI_DMG_polygate <- polygonGate(.gate=SGPI_DMG_gate, filterId = "DMG")
  SGPI_Background_gate[,1] <- biexptrans_inv(SGPI_Background_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_Background_gate[,2] <- biexptrans_inv(SGPI_Background_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_Background_gate <- as.matrix(SGPI_Background_gate)
  colnames(SGPI_Background_gate) <- c("SG-A","PropIod-A")
  SGPI_Background_polygate <- polygonGate(.gate=SGPI_Background_gate, filterId = "Background")
  SGPI_INT_gate[,1] <- biexptrans_inv(SGPI_INT_gate[,1]*(xmaxbiexp-xminbiexp)+xminbiexp)
  SGPI_INT_gate[,2] <- biexptrans_inv(SGPI_INT_gate[,2]*(ymaxbiexp-yminbiexp)+yminbiexp)
  SGPI_INT_gate <- as.matrix(SGPI_INT_gate)
  colnames(SGPI_INT_gate) <- c("SG-A","PropIod-A")
  SGPI_INT_polygate <- polygonGate(.gate=SGPI_INT_gate, filterId = "INT")
  
  gs_FS_gate1 <- gs_pop_add(gs_FS,SGPI_INT_polygate)
  gs_FS_gate2 <- gs_pop_add(gs_FS,SGPI_DMG_polygate)
  gs_FS_gate3 <- gs_pop_add(gs_FS,SGPI_Background_polygate)
  recompute(gs_FS)
  trucounts <- data.frame(gs_pop_get_count_fast(gs_FS,statistic="count"))
trucounts <- reshape2::dcast(trucounts[,-c(3,5)],id.vars=name,value.var="Count",name~Population)
rownames(trucounts) <- trucounts[,1]
colnames(trucounts) <- c("name","Background", "Damaged", "Intact")
trucounts <- merge(TruCount_metadata_volume,trucounts,by.x="Name",by.y="name")
FILT <- trucounts %>%  subset(Filtered=="Yes")
trucounts <- mutate(trucounts,
                 BackgroundpermL = (Background/Volume)*10^(3+Dilution), 
                 DamagedpermL = (Damaged/Volume)*10^(3+Dilution), 
                 IntactpermL = (Intact/Volume)*10^(3+Dilution))
setwd(paths$home)
write.csv2(file="trucounts.csv", trucounts)
```

## Extract cell counts
Extract counts
```{r Extract cell counts split per SHIME run}
# Extract cell counts and take into account the dilution factor and conversion from cells/µL to cells/mL 
counts <- rbind(data.frame(gs_pop_get_count_fast(gs_FS1,statistic="count")),
                data.frame(gs_pop_get_count_fast(gs_FS2,statistic="count")),
                data.frame(gs_pop_get_count_fast(gs_FS3,statistic="count")))
counts <- reshape2::dcast(counts[,-c(3,5)],id.vars=name,value.var="Count",name~Population)
rownames(counts) <- counts[,1]
colnames(counts) <- c("name","Background", "Damaged", "Intact")
counts <- merge(FCM_FS_SGPI_metadata_volume,counts,by.x="Name",by.y="name")
FILT <- counts %>%  subset(Filtered=="Yes")
counts <- mutate(counts,
                 BackgroundpermL = (Background/Volume)*10^(3+Dilution), 
                 DamagedpermL = (Damaged/Volume)*10^(3+Dilution), 
                 IntactpermL = (Intact/Volume)*10^(3+Dilution))
trucounts <- read.csv2("trucounts.csv") # Load TruCount samples
trucounts <- subset(trucounts, select = -c(X))
counts <- rbind(counts, trucounts)
                   
countsbu <- counts %>% subset(select=-c(Volume, Volume2))
countsbu <-countsbu[!(countsbu$Vessel=="#N/A"),]
  ## Calculations
  counts <- mutate(countsbu, TotalpermL = DamagedpermL + IntactpermL,
                   Ratio.intact.dead=IntactpermL/DamagedpermL,
                   Perc_intact = 100*IntactpermL/TotalpermL)
  
## Remove filtered and heatkilled samples
  counts <- subset(counts, Filtered == "No"); counts <- subset(counts, Heat_killed == "No")
  counts <- subset(counts, Blank == "No")
  
## Take average and stdev of the replicates and melt dataframe for visualizations
  counts <- ungroup(counts)
  by_nr <- counts %>% group_by(Nr) %>% 
    summarise(SDtot = sd(TotalpermL), meantot = mean(TotalpermL),
      SDINT = sd(IntactpermL), meanINT = mean(IntactpermL),
      SDDMG = sd(DamagedpermL), meanDMG = mean(DamagedpermL),
      SDPerc = sd(Perc_intact), meanPER = mean(Perc_intact), 
      Donor = Donor, Dilution = Dilution, Transit = Transit, 
      Vessel = Vessel, Day = Day, Ninetransit = Ninetransit) 
  
  by_nr <- by_nr[!duplicated(by_nr), ]
      # by_nr$tot <- by_nr$meanINT + by_nr$meanDMG 
      setwd(paths$home)
write.csv2(file="results.FCM.counts.merged.csv", by_nr)
## Reorder and work with the data frame
by_nr$Transit <- as.ordered(factor(by_nr$Transit,levels=c("ST","MT","LT")))
by_nr$Vessel <- as.ordered(factor(by_nr$Vessel,levels=c("P", "D")))
by_nr$Donor <- as.ordered(factor(by_nr$Donor,levels=c(1,2,3,4,5,6)))
by_nr$Day <- as.ordered(factor(by_nr$Day,levels=seq(from = 0, to = 20, by = 1)))
df <- data.frame()
for (i in unique(by_nr$Donor)) {
  df1 <- subset(by_nr, Donor == i)
  if(i == 1 | i == 2){df1$intTransit <- "Short transit donor"}
  if(i == 3 | i == 4){df1$intTransit <- "Medium transit donor"}
  if(i == 5 | i == 6){df1$intTransit <- "Long transit donor"}
  df<- rbind(df, df1)
}
by_nr <- df
by_nr$intTransit <- as.ordered(factor(by_nr$intTransit,
                      levels=c("Short transit donor","Medium transit donor","Long transit donor")))
# Save the table
write.csv(by_nr,paste(paths$home,"/cellcounts.csv",sep=""))
counts$Transit <- as.ordered(factor(counts$Transit,levels=c("ST","MT","LT")))
counts$Vessel <- as.ordered(factor(counts$Vessel,levels=c("P", "D")))
counts$Donor <- as.ordered(factor(counts$Donor,levels=c(1,2,3,4,5,6)))
# counts$Donor <- as.ordered(factor(counts$Donor,levels=c(1,2,3,6,5,4)))
counts$Day <- as.ordered(factor(counts$Day,levels=seq(from = 0, to = 20, by = 1)))
df.counts <- data.frame()

for (i in unique(counts$Donor)) {
  df1 <- subset(counts, Donor == i)
  if(i == 1 | i == 2){df1$intTransit <- "Short transit donor"}
  if(i == 3 | i == 4){df1$intTransit <- "Medium transit donor"}
  if(i == 5 | i == 6){df1$intTransit <- "Long transit donor"}
  df.counts<- rbind(df.counts, df1)
}
df.counts$intTransit <- as.ordered(factor(df.counts$intTransit,
                      levels=c("Short transit donor","Medium transit donor","Long transit donor")))
rm(df, df1)


test <- subset(by_nr, Donor == 1 | Donor ==4 | Donor == 6)
test <- subset(test, select = c(Donor, Nr,  meantot, SDtot,                meanINT,  SDINT,    SDDMG,       meanDMG, Dilution, Transit,  Vessel ,Day        , intTransit ))
colnames(test) <- c("Donor",     "Samplenumber"  ,       "Avg_total_cells"   , "SD_total_cells"    ,  "Avg_intact_cells"   , "SD_intact_cells"  ,   "Avg_damaged_cells"   , "SD_damaged_cells" ,  "Dilution" ,  "Transit" ,   "Vessel"   ,  "Day"     ,   "intTransit")


```


# Growth efficiency per volumetric nutrient loading rate
totaal aantal cellen in de elke reactor tov totale hoeveelheid nutrienten in die reactor: efficientie waarmee ze groeien 
## With averages
```{r Biomass growth efficiency, fig.height=14, fig.width=14}
# Start with bruto production
netproduction <- subset(df.counts, Ninetransit == 3)
netproduction$comb <- paste0(netproduction$Date, netproduction$Donor, netproduction$Transit, netproduction$Vessel)

netproduction <- netproduction %>% group_by(comb) %>% 
    summarise(Donor = Donor, Nr = Nr, Transit = Transit, Vessel = Vessel, Day = Day, Date = Date, 
              SDtot = sd(TotalpermL), meantot = mean(TotalpermL), SDint = sd(IntactpermL), meanint = mean(IntactpermL ),
              SDPer = sd(Perc_intact), meanperc = mean(Perc_intact)) 
netproduction <- netproduction[!duplicated(netproduction), ]


# Carbohydrates
netproduction$comb2 <- paste0(netproduction$Donor, "_", netproduction$Transit,"_",netproduction$Vessel)
df.carbohydrates <- read.csv2("Filtered_carbohydrateanalyses.csv", sep=";")
df.carbohydrates$Carbohydrate <- as.numeric(df.carbohydrates$Carbohydrate)
df.carbohydrates$Carbohydrate_differences <- as.numeric(df.carbohydrates$Carbohydrate_differences)
df.carbohydrates$Medium <- as.numeric(df.carbohydrates$Medium)
df.carbohydrates$CH <- df.carbohydrates$Carbohydrate

netproduction <-  merge(netproduction, df.carbohydrates, by.x = "comb2",by.y="Combination")
netproduction <- subset(netproduction, select = -c(comb2))

# Add reactor volumes, dosage rate and influent substrate concentration
test1 <- subset(netproduction, Vessel == "P" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test1$volume <- 0.200; test1$infldosage <- 0.600; test1$inflsubstrate <- (23.4*0.04666666666667)/0.2
test2 <- subset(netproduction, Vessel == "P" & Transit == "MT") # 94 mL of 23.4g/L medium per 200 mL influent
test2$volume <- 0.400; test2$infldosage <- 0.600; test2$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test3 <- subset(netproduction, Vessel == "P" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test3$volume <- 0.600; test3$infldosage <- 0.600; test3$inflsubstrate <- (23.4*0.14)/0.2
test4 <- subset(netproduction, Vessel == "D" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test4$volume <- 0.325; test4$infldosage <- 0.600; test4$inflsubstrate <- (23.4*0.0466666666666667)/0.2
test5 <- subset(netproduction, Vessel == "D" & Transit == "MT") # 93 mL of 23.4g/L medium per 200 mL influent
test5$volume <- 0.650; test5$infldosage <- 0.600; test5$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test6 <- subset(netproduction, Vessel == "D" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test6$volume <- 0.975; test6$infldosage <- 0.600; test6$inflsubstrate <- (23.4*0.14)/0.2
netprodP <- rbind(test1, test2, test3); netprodP<- netprodP[order(netprodP$comb), ]  
netprodD <- rbind(test4, test5, test6); netprodD<- netprodD[order(netprodD$comb), ] 

# Net production
volcorr = T # Volume correction when per reactor volume 
if(volcorr == T){
  netprodP1  <- subset(netprodP,select=c(SDtot:meanperc))*(600/1000)*(1/netprodP$volume)
netprodD_CH  <- (netprodP$Medium - subset(netprodP,select=c(Carbohydrate)))*(600/1000)*(1/netprodP$volume)
# netprodD_CH2  <- subset(netprodP,select=c(Carbohydrate_differences))*(600/1000)*(1/netprodP$volume)
netprodP1 <- cbind(netprodP1, netprodD_CH)
}else{netprodP1  <- subset(netprodP,select=c(SDtot:meanperc))*(600/1000)
 netprodD_CH  <- (netprodP$Medium - subset(netprodP,select=c(Carbohydrate)))*(600/1000)
 netprodP1 <- cbind(netprodP1, netprodD_CH)}

 netprodPnet <- cbind(subset(netprodP,select=c(comb:Date)),
                       netprodP1, subset(netprodP,select=c(volume:inflsubstrate)))
 
 
 ## distal net production
 if(volcorr == T){
   netprodD1  <- (subset(netprodD,select=c(SDtot:meanperc))-
                                   subset(netprodP, select=c(SDtot:meanperc)))*(600/1000)*(1/netprodD$volume)
 netprodD_CH  <- (subset(netprodD,select=c(Carbohydrate)) - subset(netprodP, 
                                      select=c(Carbohydrate)))*(-600/1000)*(1/netprodD$volume)
 netprodD_CH2  <- (subset(netprodP,select=c(Carbohydrate_differences)) - subset(netprodD, 
                                      select=c(Carbohydrate_differences)))*(600/1000)*(1/netprodD$volume)
 netprodD1 <- cbind(netprodD1, netprodD_CH)
 }else{netprodD1 <- (subset(netprodD,select=c(SDtot:meanperc))-subset(netprodP, 
                                                            select=c(SDtot:meanperc)))*(600/1000)
 netprodD_CH  <- (subset(netprodD,select=c(Carbohydrate)) - subset(netprodP, 
                                      select=c(Carbohydrate)))*(-600/1000)
 netprodD1 <- cbind(netprodD1, netprodD_CH)}
 
   netprodDnet <- cbind(subset(netprodD,select=c(comb:Date)),
                       netprodD1, subset(netprodD,select=c(volume:inflsubstrate)))
 
  netproduction <- rbind(netprodPnet, netprodDnet)
  
write.csv(netproduction,"netcellrate.csv")  

# Calculate load (g/d) = influent substrate conc * influent dosage
netproduction$load <- netproduction$inflsubstrate*netproduction$infldosage
unique(subset(netproduction, Vessel == "P")$load)

# Calculate volumetric loading rate (g/Lr/d) = load (g/d) / reactor volume (Lr)
netproduction$volloadrate <- netproduction$load/netproduction$volume
unique(subset(netproduction, Vessel == "P")$volloadrate)


# Net biomass estimate relative to nutrient load (cells/g) = load (g/d) / reactor volume (Lr)
biomass_relative_load <- mutate(netproduction, Biomass = meantot/load,
                                Int_Biomass = meanint/load)
# biomass_relative_load <- mutate(netproduction, Biomass = meantot/volloadrate,
#                                 Int_Biomass = meanint/volloadrate)
biomass_relative_load <- subset(biomass_relative_load, Vessel == "P")


papertheme(ggplot(netproduction, aes(x = Transit, y = Carbohydrate)) + geom_bar(stat = "identity")+facet_grid(Vessel ~ Donor, scales = "free", labeller = labeller(Vessel = Vessel.labs, Donor = donor.labs)))
```

## Without averages
```{r Biomass growth efficiency, fig.height=14, fig.width=14}
# Start with bruto production
netproduction <- subset(df.counts, Ninetransit == 3)
netproduction$comb <- paste0(netproduction$Date, netproduction$Donor, netproduction$Transit, netproduction$Vessel)

# Carbohydrates
netproduction$comb2 <- paste0(netproduction$Donor, "_", netproduction$Transit,"_",netproduction$Vessel)
df.carbohydrates <- read.csv2("Filtered_carbohydrateanalyses.csv", sep=";")
df.carbohydrates$Carbohydrate <- as.numeric(df.carbohydrates$Carbohydrate)
df.carbohydrates$Carbohydrate_differences <- as.numeric(df.carbohydrates$Carbohydrate_differences)
df.carbohydrates$Medium <- as.numeric(df.carbohydrates$Medium)
df.carbohydrates$CH <- df.carbohydrates$Carbohydrate

netproduction <-  merge(netproduction, df.carbohydrates, by.x = "comb2",by.y="Combination")
netproduction <- subset(netproduction, select = -c(comb2))

# Add reactor volumes, dosage rate and influent substrate concentration
test1 <- subset(netproduction, Vessel == "P" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test1$volume <- 0.200; test1$infldosage <- 0.600; test1$inflsubstrate <- (23.4*0.04666666666667)/0.2
test2 <- subset(netproduction, Vessel == "P" & Transit == "MT") # 94 mL of 23.4g/L medium per 200 mL influent
test2$volume <- 0.400; test2$infldosage <- 0.600; test2$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test3 <- subset(netproduction, Vessel == "P" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test3$volume <- 0.600; test3$infldosage <- 0.600; test3$inflsubstrate <- (23.4*0.14)/0.2
test4 <- subset(netproduction, Vessel == "D" & Transit == "ST") # 47 mL of 23.4g/L medium per 200 mL influent
test4$volume <- 0.325; test4$infldosage <- 0.600; test4$inflsubstrate <- (23.4*0.0466666666666667)/0.2
test5 <- subset(netproduction, Vessel == "D" & Transit == "MT") # 93 mL of 23.4g/L medium per 200 mL influent
test5$volume <- 0.650; test5$infldosage <- 0.600; test5$inflsubstrate <- (23.4*0.0933333333333333)/0.2
test6 <- subset(netproduction, Vessel == "D" & Transit == "LT") # 140 mL of 23.4g/L medium per 200 mL influent
test6$volume <- 0.975; test6$infldosage <- 0.600; test6$inflsubstrate <- (23.4*0.14)/0.2
netprodP <- rbind(test1, test2, test3); netprodP<- netprodP[order(netprodP$comb), ]  
netprodD <- rbind(test4, test5, test6); netprodD<- netprodD[order(netprodD$comb), ] 


# Match the proximal with distal colon orders
netprodP$comb2 <- paste0(netprodP$Date, netprodP$Donor, netprodP$Transit, netprodP$Replicate)
netprodD$comb2 <- paste0(netprodD$Date, netprodD$Donor, netprodD$Transit, netprodD$Replicate)
test <-  merge(netprodP, netprodD, by.x = "comb2",by.y="comb2")
netprodP <- netprodP[(netprodP$comb2 %in% test$comb2), ]
netprodD <- netprodD[(netprodD$comb2 %in% test$comb2), ]
netprodP<- netprodP[order(netprodP$comb2), ]; netprodD<- netprodD[order(netprodD$comb2), ] 
 
 # Net production
volcorr = T # Volume correction when per reactor volume 
if(volcorr == T){
  netprodP1  <- subset(netprodP,select=c(BackgroundpermL:TotalpermL))*(600/1000)*(1/netprodP$volume)
netprodD_CH  <- (netprodP$Medium - subset(netprodP,select=c(Carbohydrate)))*(600/1000)*(1/netprodP$volume)
# netprodD_CH2  <- subset(netprodP,select=c(Carbohydrate_differences))*(600/1000)*(1/netprodP$volume)
netprodP1 <- cbind(netprodP1, netprodD_CH)
}else{netprodP1  <- subset(netprodP,select=c(BackgroundpermL:TotalpermL))*(600/1000)
 netprodD_CH  <- (netprodP$Medium - subset(netprodP,select=c(Carbohydrate)))
 netprodP1 <- cbind(netprodP1, netprodD_CH)}

 netprodPnet <- cbind(subset(netprodP,select=c(comb, Donor,Nr,Transit, Vessel, Day, Date, intTransit, Ninetransit)),
                       netprodP1, subset(netprodP,select=c(Medium:inflsubstrate)))
 
 
 ## distal net production
 if(volcorr == T){
   netprodD1  <- (subset(netprodD,select=c(BackgroundpermL:TotalpermL))-
                                   subset(netprodP, select=c(BackgroundpermL:TotalpermL)))*(600/1000)*(1/netprodD$volume)
 netprodD_CH  <- (subset(netprodD,select=c(Carbohydrate)) - subset(netprodP, 
                                      select=c(Carbohydrate)))*(-600/1000)*(1/netprodD$volume)
 netprodD_CH2  <- (subset(netprodP,select=c(Carbohydrate_differences)) - subset(netprodD, 
                                      select=c(Carbohydrate_differences)))*(600/1000)*(1/netprodD$volume)
 netprodD1 <- cbind(netprodD1, netprodD_CH)
 }else{netprodD1 <- (subset(netprodD,select=c(BackgroundpermL:TotalpermL))-subset(netprodP, 
                                                            select=c(BackgroundpermL:TotalpermL)))*(600/1000)
 netprodD_CH  <- (subset(netprodD,select=c(Carbohydrate)) - subset(netprodP, 
                                      select=c(Carbohydrate)))*(-600/1000)
 netprodD1 <- cbind(netprodD1, netprodD_CH)}
 
   netprodDnet <- cbind(subset(netprodD,select=c(comb, Donor,Nr,Transit, Vessel, Day, Date, intTransit, Ninetransit)),
                       netprodD1, subset(netprodD,select=c(Medium:inflsubstrate)))
 
  netproduction2 <- rbind(netprodPnet, netprodDnet)
 
 
 
 
# Calculate load (g/d) = influent substrate conc * influent dosage
netproduction2$load <- netproduction2$inflsubstrate*netproduction2$infldosage
unique(subset(netproduction2, Vessel == "P")$load)

# Calculate volumetric loading rate (g/Lr/d) = load (g/d) / reactor volume (Lr)
netproduction2$volloadrate <- netproduction2$load/netproduction2$volume
unique(subset(netproduction2, Vessel == "P")$volloadrate)


# Net biomass estimate relative to nutrient load (cells/g) = load (g/d) / reactor volume (Lr)
biomass_relative_load2 <- mutate(netproduction2, Biomass = TotalpermL/load,
                                Int_Biomass = IntactpermL/load)
# biomass_relative_load <- mutate(netproduction, Biomass = meantot/volloadrate,
#                                 Int_Biomass = meanint/volloadrate)
biomass_relative_load2 <- subset(biomass_relative_load2, Vessel == "P")


biomass_relative_load_avg <- biomass_relative_load2 %>% group_by(Transit) %>% 
    summarise(Transit = Transit, 
              SDbiomass = sd(Biomass), meanbiomass = mean(Biomass), SDint = sd(Int_Biomass), meanint = mean(Int_Biomass)      ) 
biomass_relative_load_avg <- biomass_relative_load_avg[!duplicated(biomass_relative_load_avg), ]





biomass_relative_load2 <- biomass_relative_load2 %>% group_by(comb) %>% 
    summarise(Donor = Donor, Nr = Nr, Transit = Transit, Vessel = Vessel, Day = Day, Date = Date, intTransit = intTransit,
              SDbiomass = sd(Biomass), meanbiomass = mean(Biomass), SDint = sd(Int_Biomass), meanint = mean(Int_Biomass)      ) 
biomass_relative_load2 <- biomass_relative_load2[!duplicated(biomass_relative_load2), ]



df2 <- subset(biomass_relative_load2, Transit != "FS")
df <- df2
max <- max(df2$meanbiomass); min <- min(df2$meanbiomass)
df1 <- subset(df, Transit == "ST") 
df1$Day[df1$Day == 6] <-1;df1$Day[df1$Day == 7] <-2;df1$Day[df1$Day == 8] <-3;df1$Day[df1$Day == 9] <-4;df1$Day[df1$Day == 10] <-5
df2 <- subset(df, Transit == "MT")
df2$Day[df2$Day == 11] <-1;df2$Day[df2$Day == 12] <-2;df2$Day[df2$Day == 13] <-3;df2$Day[df2$Day == 14] <-4;df2$Day[df2$Day == 15] <-5
df3 <- subset(df, Transit == "LT"); df4 <- subset(df3, Donor == 1|Donor ==2)
df4$Day[df4$Day == 15] <-1;df4$Day[df4$Day == 16] <-2;df4$Day[df4$Day == 17] <-3;df4$Day[df4$Day == 18] <-4;df4$Day[df4$Day == 19] <-5
df3 <- subset(df3, Donor == 3|Donor ==4|Donor == 5|Donor ==6)
df3$Day[df3$Day == 16] <-1;df3$Day[df3$Day == 17] <-2;df3$Day[df3$Day == 18] <-3;df3$Day[df3$Day == 19] <-4;df3$Day[df3$Day == 20] <-5
df <- rbind(df1, df2, df4, df3)

biomass_relative_load2 <- df






biomass_relative_CH <- mutate(netproduction2, Biomass = TotalpermL/Carbohydrate,
                                Int_Biomass = IntactpermL/Carbohydrate)


biomass_relative_CH_avg <- biomass_relative_CH %>% group_by(Transit) %>% 
  summarise(Transit = Transit, 
            SDbiomass = sd(Biomass), 
            meanbiomass = mean(Biomass), 
            SDint = sd(Int_Biomass),
            meanint = mean(Int_Biomass)) 
biomass_relative_CH_avg <- biomass_relative_CH_avg[!duplicated(biomass_relative_CH_avg), ]
```


DONT RUN
```{r}
# To export
biomass_relative_CH2 <- biomass_relative_CH; biomass_relative_CH2$invivotransit <- biomass_relative_CH2$intTransit
biomass_relative_CH2$Biomass_conversion <- biomass_relative_CH2$Biomass
biomass_relative_CH2 <- subset(biomass_relative_CH2, select = c(Donor, Nr, Transit, Vessel, Day, invivotransit, Biomass_conversion))


biomass_relative_CH2 <- biomass_relative_CH2 %>% group_by(Nr) %>% 
  summarise(Donor = Donor, Nr = Nr, Transit = Transit, Vessel = Vessel, Day = Day, invivotransit = invivotransit, Biomass_conversion = mean(Biomass_conversion))

biomass_relative_CH2 <- biomass_relative_CH2[!duplicated(biomass_relative_CH2), ]

export <- merge(biomass_relative_CH2,subset(metabolites_relative_carbohydrate, select = c(Samplenumber, Acet_CH, Prop_CH, Buty_CH, SCFA_CH)),by.x="Nr",by.y="Samplenumber")

 setwd(paths$home); write.csv2(file="Conversion_efficiencies.csv", export)

```



## Statistics
```{r}
correction <- "holm"
biomass_relative_load$comb <- paste0(biomass_relative_load$Transit, biomass_relative_load$Vessel)
averages <- subset(biomass_relative_load, Donor !=1); averages <- subset(averages, Donor !=2)
# averages <- subset(biomass_relative_load, Donor ==1| Donor ==2)
averages <- averages %>% group_by(comb) %>% 
    summarise(Donor = Donor, Transit = Transit, Vessel = Vessel,  
              SDBiomass = sd(Biomass), meanbio = mean(Biomass), 
              intSDBiomass = sd(Int_Biomass), intmeanbio = mean(Int_Biomass)) 
averages <- averages[!duplicated(averages), ]

# Non parametric to 1-way ANOVA without donor separation, alternative - Kruskal-Wallis
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between transit times"))

  my_data <- biomass_relative_load
  colnames(my_data)
  
  
  my_data <- ungroup(my_data) #ungroup the data or you'll have problems
  rstatix::kruskal_test(my_data, Transit ~ Biomass)
  res.kruskal <- my_data %>% rstatix::kruskal_test(Biomass ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data %>% kruskal_effsize(Biomass ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data %>%  wilcox_test(Biomass ~ Transit, p.adjust.method = correction, paired = F)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: ",i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data, x = "Transit", y = "Biomass") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    ggarrange(plotlist = gglist, nrow = 1, ncol = 3)


df.pwc.total <- df.pwc; View(df.pwc.total) 


df <- biomass_relative_load %>% group_by(Transit) %>% 
    summarise(SDtot = sd(TotalpermL), meantot = mean(TotalpermL), SDPer = sd(Perc_intact), meanperc = mean(Perc_intact),
      Transit = Transit, Vessel = Vessel) ; df <- df[!duplicated(df), ]
```

## Plot load
```{r Biomass growth efficiency, fig.height=7, fig.width=16}

Transit.labs <- c("Short SHIME transit", "Medium SHIME transit", "Long SHIME transit")
names(Transit.labs) <- c("ST", "MT", "LT")

max = max(biomass_relative_load$Biomass); min = min(biomass_relative_load$Biomass)
plotA <- papertheme(ggplot(biomass_relative_load, aes(x= Donor, y = Biomass, fill = Donor))) + 
  geom_boxplot() + facet_grid(Vessel~Transit, scales = "free_y", 
                              labeller = labeller(Transit= Transit.labs, Vessel = PD_Colon.labs))  + 
  scale_fill_manual(values = sixdonors) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270))+
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank(), strip.text.y = element_blank()) +
  # ylab("Total cells relative to absolute nutrient load (cells )") + 
  ylab(expression(paste("Total cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+ xlab("Donor") + 
  scale_y_continuous(limits = c(0, max + min))




plotAbis <- papertheme(ggplot(biomass_relative_load, aes(x= Donor, y = Biomass, fill = Donor))) + 
  geom_dotplot() + facet_grid(Vessel~Transit, scales = "free_y", 
                              labeller = labeller(Transit= Transit.labs, Vessel = PD_Colon.labs))  + 
  scale_fill_manual(values = sixdonors) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270))+
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank(), strip.text.y = element_blank()) +
  # ylab("Total cells relative to absolute nutrient load (cells )") + 
  ylab(expression(paste("Total cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+ xlab("Donor") + 
  scale_y_continuous(limits = c(0, max + min))
# plotA
  
dat_text <- data.frame(label = c("a", "b", "c"),
  Transit  = c("ST", "MT", "LT"),
  value     = c(max + min, max + (min/2) , max))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))


plotB <- papertheme(ggplot(biomass_relative_load, aes(x= Transit, y = Biomass, fill = Transit))) + 
  geom_boxplot() +  
  scale_fill_manual(values = transitcolors, labels = c( "Short", "Medium", "Long")) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270)) +
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank(), 
            axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank()) +
  ylab(expression(paste("Total cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+
  xlab("Transit time")+ scale_x_discrete(labels= c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0, max + min)) +
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 7) 
  # plotB

  
# ggarrange(plotA, plotB, ncol = 2, widths = c(1,0.5))


max = max(biomass_relative_load$Int_Biomass); min = min(biomass_relative_load$Int_Biomass)
plotC <- papertheme(ggplot(biomass_relative_load, aes(x= Donor, y = Int_Biomass, fill = Donor))) + 
  geom_boxplot() + facet_grid(Vessel~Transit, scales = "free_y", 
                              labeller = labeller(Transit= Transit.labs, Vessel = PD_Colon.labs))  + 
  scale_fill_manual(values = sixdonors) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270))+
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank(), strip.text.y = element_blank()) +
  # ylab("Total cells relative to absolute nutrient load (cells )") + 
  # ylab(expression(paste("Intact cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+
  ylab(expression(paste("Intact cells relative to nutrient load (cells ",g^{"-1"}, ")")))+ 
  xlab("Donor") + 
  scale_y_continuous(limits = c(0, max + min))
# plotC
  

dat_text <- data.frame(label = c("a", "b", "c"),
  Transit  = c("ST", "MT", "LT"),
  value     = c(max + min, max + (min/2) , max))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))


plotD <- papertheme(ggplot(biomass_relative_load, aes(x= Transit, y = Int_Biomass, fill = Transit))) + 
  geom_boxplot() +  
  scale_fill_manual(values = transitcolors, labels = c( "Short", "Medium", "Long")) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270)) +
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank(), 
            axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank()) +
  # ylab(expression(paste("Intact cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+
  ylab(expression(paste("Intact cells relative to nutrient load (cells ",g^{"-1"}, ")")))+
  xlab("Transit time")+ scale_x_discrete(labels= c("Short", "Medium", "Long")) + 
  scale_y_continuous(limits = c(0, max + min)) +
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 7)
  plotD
  # axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank()
  # plotD <- plotD +stat_compare_means(comparisons = my_comparisons, label = "p.signif", hide.ns = T, hide.NS = T,
  #                    label.y = c(max-min, max-min, max))  # Add significance levels

ggarrange(plotC, ggarrange(NULL,plotD, nrow = 2, heights = c(0.06,1)), 
            ncol = 2, widths = c(1,0.5), labels = c("A", "B"), font.label = list(size =20))

comboplot <- ggarrange(
  ggarrange(plotA, ggarrange(NULL,plotB, nrow = 2, heights = c(0.06,1)), 
            ncol = 2, widths = c(1,0.5), labels = c("A", "B"), font.label = list(size =20)),
  ggarrange(plotC, ggarrange(NULL,plotD, nrow = 2, heights = c(0.06,1)), 
            ncol = 2, widths = c(1,0.5), labels = c("C", "D"), font.label = list(size =20)),
  nrow = 2)

comboplot

saveplots()
ggsave(plot = comboplot, width = 14, height = 14, dpi = 300, filename = "FigureS6.tiff")

plot_Biomass_effA <- plotA
plot_Biomass_effB <- plotB

df <- biomass_relative_load2
plot <- papertheme(ggplot(df, aes(x = Day, y = meanbiomass, color = Transit))) + geom_point(size = 4)+ geom_line(aes(group = Transit))+ 
  geom_errorbar(aes(ymin=meanbiomass-SDbiomass, ymax=meanbiomass+SDbiomass), width = 0.5, alpha = 0.7) + 
  scale_color_manual(values = transitcolors,labels=c("Short", "Medium", "Long")) +
  facet_grid(Vessel ~ intTransit + Donor , labeller = labeller(Vessel = Vessel.labs, Donor = donor.labs)) +
  ylab(expression(paste("Total cell concentration (cells m",L^{"-1"}, ")"))) + xlab("Stabilised time (Days)")+ 
  theme(strip.background = element_rect(fill = "#D6E0F4"), legend.position = c(0.075,0.92), legend.text = element_text(size = 18), 
        legend.title = element_text(size = 18), strip.text.y = element_blank())+labs(color='SHIME transit')+
  scale_y_continuous(limits = c(0, max+ min))
ggarrange(plot, NULL, ncol = 2, widths = c(1,0.3))

```



## Statistics - CH
```{r}
correction <- "holm"
biomass_relative_CH$comb <- paste0(biomass_relative_CH$Transit, biomass_relative_CH$Vessel)

averages <- biomass_relative_CH
# averages <- subset(biomass_relative_CH, Donor !=1); averages <- subset(averages, Donor !=2)
averages <- subset(biomass_relative_CH, Donor ==1| Donor ==2)
averages <- averages %>% group_by(comb) %>% 
    summarise(Donor = Donor, Transit = Transit, Vessel = Vessel,  
              SDBiomass = sd(Biomass), meanbio = mean(Biomass), 
              intSDBiomass = sd(Int_Biomass), intmeanbio = mean(Int_Biomass)) 
averages <- subset(averages, select = c(comb, Transit, Vessel, meanbio,SDBiomass, intmeanbio, intSDBiomass))
averages <- averages[!duplicated(averages['comb']), ]



# Non parametric to 1-way ANOVA without donor separation, alternative - Kruskal-Wallis
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between transit times"))
for(j in c("P", "D")){
  my_data <- subset(biomass_relative_CH, Vessel == j)
   my_data <- subset(my_data, Ninetransit == 3)
  colnames(my_data)
  
  
  my_data <- ungroup(my_data) #ungroup the data or you'll have problems
  rstatix::kruskal_test(my_data, Transit ~ Biomass)
  res.kruskal <- my_data %>% rstatix::kruskal_test(Biomass ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data %>% kruskal_effsize(Biomass ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data %>%  wilcox_test(Biomass ~ Transit, p.adjust.method = correction, paired = F)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: ",j, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: ",j, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data, x = "Transit", y = "Biomass") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    ggarrange(plotlist = gglist, nrow = 1, ncol = 3)


df.pwc.total <- df.pwc; View(df.pwc.total) 
}



# Between vessels
gglist <- list(); x = 1; df.pwc1 <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between vessels"))
  for (j in c("ST", "MT", "LT")) {
    my_data2 <-  subset(biomass_relative_CH, Transit == j)
                       my_data2 <- subset(my_data2, Ninetransit == 3)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(Biomass ~ Vessel)
    test1<- subset(my_data2, Vessel == "P"); test<- subset(my_data2, Vessel == "D")
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(Biomass ~ Vessel)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){ 
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(Biomass ~ Vessel, p.adjust.method = "bonferroni", paired = F)
    pwc <- subset(pwc, p != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Vessel")
    gglist[[x]]<- ggboxplot(my_data2, x = "Vessel", y = "Biomass") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Transit ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}; ggarrange(plotlist = gglist, nrow = 2, ncol = 3)
df.pwc.total <- df.pwc; df.pwc1.total <- df.pwc1
View(df.pwc.total); View(df.pwc1.total)
```

### intact cells
```{r}
correction <- "holm"
biomass_relative_CH$comb <- paste0(biomass_relative_CH$Transit, biomass_relative_CH$Vessel)

averages <- biomass_relative_CH
averages <- subset(biomass_relative_CH, Donor !=1); averages <- subset(averages, Donor !=2)
# averages <- subset(biomass_relative_CH, Donor ==1| Donor ==2)
averages <- averages %>% group_by(comb) %>% 
    summarise(Donor = Donor, Transit = Transit, Vessel = Vessel,  
              SDBiomass = sd(Biomass), meanbio = mean(Biomass), 
              intSDBiomass = sd(Int_Biomass), intmeanbio = mean(Int_Biomass)) 
averages <- subset(averages, select = c(comb, Transit, Vessel, meanbio,SDBiomass, intmeanbio, intSDBiomass))
averages <- averages[!duplicated(averages['comb']), ]



# Non parametric to 1-way ANOVA without donor separation, alternative - Kruskal-Wallis
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between transit times"))
for(j in c("P", "D")){
  my_data <- subset(biomass_relative_CH, Vessel == j)
   my_data <- subset(my_data, Ninetransit == 3)
  colnames(my_data)
  
  
  my_data <- ungroup(my_data) #ungroup the data or you'll have problems
  rstatix::kruskal_test(my_data, Transit ~ Int_Biomass)
  res.kruskal <- my_data %>% rstatix::kruskal_test(Int_Biomass ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data %>% kruskal_effsize(Int_Biomass ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data %>%  wilcox_test(Int_Biomass ~ Transit, p.adjust.method = correction, paired = F)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: ",j, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: ",j, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data, x = "Transit", y = "Int_Biomass") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    ggarrange(plotlist = gglist, nrow = 1, ncol = 3)


df.pwc.total <- df.pwc; View(df.pwc.total) 
}



# Between vessels
gglist <- list(); x = 1; df.pwc1 <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between vessels"))
  for (j in c("ST", "MT", "LT")) {
    my_data2 <-  subset(biomass_relative_CH, Transit == j)
                       my_data2 <- subset(my_data2, Ninetransit == 3)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(Int_Biomass ~ Vessel)
    test1<- subset(my_data2, Vessel == "P"); test<- subset(my_data2, Vessel == "D")
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(Int_Biomass ~ Vessel)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){ 
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(Int_Biomass ~ Vessel, p.adjust.method = "bonferroni", paired = F)
    pwc <- subset(pwc, p != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Vessel")
    gglist[[x]]<- ggboxplot(my_data2, x = "Vessel", y = "Int_Biomass") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Transit ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}; ggarrange(plotlist = gglist, nrow = 2, ncol = 3)
df.pwc.total <- df.pwc; df.pwc1.total <- df.pwc1
View(df.pwc.total); View(df.pwc1.total)
```



## Paperplot biomass-carbohydrates
```{r Biomass growth efficiency, fig.height=7, fig.width=16}
Transit.labs <- c("Short SHIME transit", "Med SHIME transit", "Long SHIME transit")
names(Transit.labs) <- c("ST", "MT", "LT")

max2 = max(biomass_relative_CH$Biomass) + 1000000000
min = -min(biomass_relative_CH$Biomass)
maxP2 = max(subset(biomass_relative_CH, Vessel == "P")$Biomass) + 100000000

maxP <- maxP2 + 100000000
maxD <- max2 + 1000000000

test <- subset(biomass_relative_CH, Vessel == "P"); test$ymax <- maxP
test1 <- subset(biomass_relative_CH, Vessel == "D"); test1$ymax <- maxD
biomass_relative_CH2 <- rbind(test, test1)


plotA <- papertheme(ggplot(subset(biomass_relative_CH2, Biomass >0), aes(x= Donor, y = Biomass, fill = Donor))) + 
  geom_boxplot() + facet_grid(Vessel~Transit, scales = "free_y", 
                              labeller = labeller(Transit= Transit.labs, Vessel = PD_Colon.labs))  + 
  scale_fill_manual(values = sixdonors) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270))+
  geom_blank(aes(y = ymax)) +
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank()#, strip.text.y = element_blank()
            ) +
  # ylab(expression(paste("Total cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+ 
  # ylab(bquote(atop("Net total cell production", "(cells " ~ g^-1 ~ " net carbohydrate consumption)"))) +
  # ylab(bquote(atop("Net total cell production"~ "(cells " ~ g["carbohydrate consumption"]^-1~")"))) +
  # ylab(bquote(atop("Net carbohydrate-to-total cell conversion ", "(cells " ~ g^-1 ~ day^-1~")"))) +
  ylab(expression(paste("Net carbohydrate-to-total cell conversion (cells ",g^{"-1"}, ")")))+ 
  xlab("Donor") 

plotA


dat_text <- data.frame(label = c("ab*", "a*", "b","a*", "b*", "c"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  Vessel = c("P", "P", "P", "D" , "D" , "D" ),
  value     = c(maxP2, 9E+08, 7E+08, max2, 7.5E+09, 7.5E+09))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))


plotB <- papertheme(ggplot(subset(biomass_relative_CH2, Biomass >0), aes(x= Transit, y = Biomass, fill = Transit))) + 
  geom_boxplot() +   facet_grid(Vessel~., scales = "free_y", 
                              labeller = labeller(Vessel = PD_Colon.labs)) +
  scale_fill_manual(values = transitcolors, labels = c( "Short", "Medium", "Long")) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270)) +
  geom_blank(aes(y = ymax)) +
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank()#, 
            # axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank()
            ) +
  # ylab(expression(paste("Net total cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+
  # ylab(bquote(atop("Net total cell production", "(cells " ~ g^-1 ~ " carbohydrate consumption)"))) +
  # ylab(bquote(atop("Net carbohydrate-to-total cell conversion ", "(cells " ~ g^-1 ~ day^-1~")"))) +
  ylab(expression(paste("Net carbohydrate-to-total cell conversion (cells ",g^{"-1"}, ")")))+ 
  xlab("SHIME transit time")+ scale_x_discrete(labels= c("Short", "Medium", "Long")) + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 7) 
  plotB

  
ggarrange(plotA, ggarrange(NULL, plotB, nrow = 2, heights = c(0.065,1)), ncol = 2, widths = c(1,0.5))

paperplot_carbohydratesA <- plotA
paperplot_carbohydratesB <- plotB

ggarrange(paperplot_carbohydratesA, paperplot_carbohydratesB)
```

# Figure S8 - Intact cells
```{r Biomass growth efficiency, fig.height=5, fig.width=18}
max2 = max(biomass_relative_CH$Int_Biomass) + 1000000000
min = -min(biomass_relative_CH$Int_Biomass)
maxP2 = max(subset(biomass_relative_CH, Vessel == "P")$Int_Biomass) + 100000000

maxP <- maxP2 + 100000000
maxD <- max2 + 1000000000

test <- subset(biomass_relative_CH, Vessel == "P"); test$ymax <- maxP
test1 <- subset(biomass_relative_CH, Vessel == "D"); test1$ymax <- maxD
biomass_relative_CH2 <- rbind(test, test1)


plotA <- papertheme(ggplot(subset(biomass_relative_CH2, Int_Biomass >0), aes(x= Donor, y = Int_Biomass, fill = Donor))) + 
  geom_boxplot() + facet_grid(Vessel~Transit, scales = "free_y", 
                              labeller = labeller(Transit= Transit.labs, Vessel = PD_Colon.labs))  + 
  scale_fill_manual(values = sixdonors) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270))+
  geom_blank(aes(y = ymax)) +
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank()#, strip.text.y = element_blank()
            ) +
  # ylab(expression(paste("Total cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+ 
  # ylab(bquote(atop("Net intact cell production", "(cells " ~ g^-1 ~ " net carbohydrate consumption)"))) +
  # ylab(bquote(atop("Net carbohydrate-to-intact cell efficiency ", "(cells " ~ g^-1 ~ day^-1~")"))) +
  # ylab(bquote(atop("Net carbohydrate-to-intact cell conversion ", "(cells " ~ g^-1 ~ day^-1~")"))) +
  ylab(bquote(atop("Net carbohydrate-to-intact cell", " conversion (cells " ~ g^-1 ~ ")"))) +
   # ylab(expression(paste("Net carbohydrate-to-intact cell conversion (cells ",g^{"-1"}, ")")))+
  # ylab(bquote(atop("Net total cell production"~ "(cells " ~ g["carbohydrate consumption"]^-1~")"))) +
  xlab("Donor") 
# plotA


dat_text <- data.frame(label = c("a*", "b*", "a*","a*", "b*", "c*"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  Vessel = c("P", "P", "P", "D" , "D" , "D" ),
  value     = c(maxP2, 9E+08, 7E+08, max2, 7.5E+09, 7.5E+09))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))


plotB <- papertheme(ggplot(subset(biomass_relative_CH2, Biomass >0), aes(x= Transit, y = Int_Biomass, fill = Transit))) + 
  geom_boxplot() +   facet_grid(Vessel~., scales = "free_y", 
                              labeller = labeller(Vessel = PD_Colon.labs)) +
  scale_fill_manual(values = transitcolors, labels = c( "Short", "Medium", "Long")) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270)) +
  geom_blank(aes(y = ymax)) +
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), 
            legend.text = element_text(size = 16), legend.background = element_blank()#, 
            # axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.y = element_blank()
            ) +
  # ylab(expression(paste("Net total cells relative to nutrient load (cells ",g^{"-1"}, d^{"-1"}, ")")))+
  # ylab(bquote(atop("Net intact cell production", "(cells " ~ g^-1 ~ " net carbohydrate consumption)"))) +
  # ylab(bquote(atop("Net carbohydrate-to-intact cell efficiency ", "(cells " ~ g^-1 ~ day^-1~")")))
  ylab(bquote(atop("Net carbohydrate-to-intact cell", "conversion (cells " ~ g^-1~")")))+
  # ylab(expression(paste("Net carbohydrate-to-intact cell conversion (cells ",g^{"-1"}, ")")))+
  # ylab(bquote(atop("Net carbohydrate-to-intact cell conversion "~ "(cells " ~ g^-1 ~ ")"))) +
  xlab("SHIME transit time")+ scale_x_discrete(labels= c("Short", "Medium", "Long")) + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 7) 
  # plotB
  
  
  ggarrange(plotA, ggarrange(NULL, plotB, nrow = 2, heights = c(0.065,1)), ncol = 2, widths = c(1,0.5), labels = "AUTO", font.label = list(size = 20))
```

# Figure S6 - Paperplot Carbohydrate consumption
```{r Biomass growth efficiency, fig.height=5.5, fig.width=17}
correction <- "holm"
df.carbs <- read.csv2("Carbs_reps.csv", sep = ";")

df.carbs$comb <- paste0(df.carbs$Transit, df.carbs$Donor, df.carbs$Colon)
# df.carbs$comb <- paste0(df.carbs$Transit, df.carbs$Colon)

df.carbs$Conc_g_L <- as.numeric(df.carbs$Conc_g_L)
df.carbs$Conc_net <- as.numeric(df.carbs$Conc_net)
df.carbs$Conc_netvol <- as.numeric(df.carbs$Conc_netvol)

df.carbs$Colon <- as.ordered(factor(df.carbs$Colon,levels=c("P", "D")))
df.carbs$Donor <- as.ordered(factor(df.carbs$Donor,levels=c(1,2,3,4,5,6)))
df.carbs$Transit <- as.ordered(factor(df.carbs$Transit,levels=c("ST", "MT", "LT")))
df.carbsraw <- df.carbs

df.carbs <- df.carbs %>% group_by(comb) %>% 
  summarise(Conc_g_LSD = sd(Conc_g_L), Conc_g_L = mean(Conc_g_L),
            Conc_netSD = sd(Conc_net), Conc_net = mean(Conc_net),
            Conc_netvolSD = sd(Conc_netvol), Conc_netvol = mean(Conc_netvol),
            Donor = Donor, Colon = Colon, Transit = Transit) 

df.carbs <- df.carbs[!duplicated(df.carbs$Conc_net), ]; df.carbs <- subset(df.carbs, select = c(Transit:Conc_g_LSD))
df.carbs$Colon <- as.ordered(factor(df.carbs$Colon,levels=c("P", "D")))
df.carbs$Donor <- as.ordered(factor(df.carbs$Donor,levels=c(1,2,3,4,5,6)))
df.carbs$Transit <- as.ordered(factor(df.carbs$Transit,levels=c("ST", "MT", "LT")))

plot <- papertheme(ggplot(df.carbs, aes(x = Donor, y = Conc_net, color = Donor, fill = Donor))+ 
             geom_bar(stat="identity") + 
  facet_grid(Colon~Transit, labeller = labeller(Transit = Transit.labs, Colon = PD_Colon.labs), scales = "free")) +
  geom_errorbar(aes(ymin=Conc_net-Conc_netSD, ymax=Conc_net+Conc_netSD), color = "black") +
  scale_color_manual(values = sixdonors)+scale_fill_manual(values = sixdonors) +
  ylab(expression(paste("Net carbohydrate utilisation (g ",day^{"-1"}, ")"))) +
  guides(color=guide_legend(ncol = 6, title.position = "left")) + 
  xlab("Donor")


if(BW == TRUE){
  plot <- plot + scale_fill_grey() + scale_color_grey() + theme(strip.background = element_rect(fill = "lightgrey"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), legend.position = "none") 
}else{
  plot <- plot + theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), axis.text.x = element_blank(), 
  axis.ticks.x = element_blank(), axis.title.x = element_blank())
}; plot
paperplot_carbohydrateconsumptionA <- plot

# Non parametric to 1-way ANOVA without donor separation, alternative - Kruskal-Wallis
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between transit times"))
for(j in c("P", "D")){
  my_data <- subset(df.carbsraw, Colon == j)

  
  my_data <- ungroup(my_data) #ungroup the data or you'll have problems
  rstatix::kruskal_test(my_data, Transit ~ Conc_net)
  res.kruskal <- my_data %>% rstatix::kruskal_test(Conc_net ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data %>% kruskal_effsize(Conc_net ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data %>%  wilcox_test(Conc_net ~ Transit, p.adjust.method = correction, paired = F)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: ",j, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: ",j, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data, x = "Transit", y = "Conc_net") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    print(ggarrange(plotlist = gglist, nrow = 1, ncol = 1))


df.pwc.total <- df.pwc
# View(df.pwc.total)
}

View(df.pwc.total)



# max(subset(df.carbsraw, Colon == "P")$Conc_net)
# max(subset(df.carbsraw, Colon == "D")$Conc_net)
dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Colon   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(2.5,3.5,4.5,0.6,0.9,1.2))
  
dat_text$Colon <- factor(dat_text$Colon, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))


df.carbsraw1 <- subset(df.carbs, Colon == "P"); df.carbsraw1$ymax <- 4.7
df.carbsraw2 <- subset(df.carbs, Colon == "D"); df.carbsraw2$ymax <- 1.4
df.carbsraw <- rbind(df.carbsraw1, df.carbsraw2)


plot <- papertheme(ggplot(df.carbsraw, aes(x = Transit, y = Conc_net, fill = Transit))+ 
             geom_boxplot() +
  facet_grid(Colon~., labeller = labeller(Transit = Transit.labs, Colon = PD_Colon.labs), scales = "free")) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
        legend.position = "none",
  strip.text.y = element_text(size = 20, angle = 270) #, 
  # axis.text.x = element_blank(), 
  # axis.ticks.x = element_blank(), axis.title.x = element_blank()
  ) +
  scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) +
  ylab(expression(paste("Net carbohydrate utilisation (g ",day^{"-1"}, ")"))) +
  geom_blank(aes(y=ymax))+
  scale_x_discrete(labels= c("Short", "Medium", "Long")) + 
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 7) +
  xlab("SHIME transit time")

if(BW == TRUE){
  plot <- plot + scale_fill_grey() + scale_color_grey() + theme(strip.background = element_rect(fill = "lightgrey"))
}
plot

paperplot_carbohydrateconsumptionB <- plot
ggarrange(paperplot_carbohydrateconsumptionA, ggarrange(NULL,paperplot_carbohydrateconsumptionB, nrow = 2, heights = c(0.06,1)), ncol = 2, widths = c(1,0.5))




```






# Statistics
## Statistical data analysis - parametric
```{r two-way ANOVA, fig.height=18, fig.width=18}
my_data <- subset(df.counts, Vessel == "P"); my_data <- subset(my_data, Ninetransit == 3)
my_data$Donor <- as.ordered(factor(my_data$Donor,levels=c(1,2,3,4,5,6)))
# Show a random sample
set.seed(1234)
dplyr::sample_n(my_data, 10)
# Check the structure
str(my_data)
# Generate frequency tables
table(my_data$Donor, my_data$Transit)
# Visualization
ggboxplot(my_data, x = "Donor", y = "TotalpermL", color = "Transit",
          palette = transitcolors)
ggline(my_data, x = "Donor", y = "TotalpermL", color = "Transit",
       add = c("mean_se", "dotplot"),
       palette = transitcolors)
# Two-way interaction plot
interaction.plot(x.factor = my_data$Donor, trace.factor = my_data$Transit, 
                 response = my_data$TotalpermL, fun = mean, 
                 type = "b", legend = TRUE, 
                 xlab = "Donor", ylab="TotalpermL",
                 pch=c(1,19), col = transitcolors)
# Compute 2 way ANOVA
res.aov2 <- aov(TotalpermL ~ Transit + Donor, data = my_data)
summary(res.aov2)
# Two-way ANOVA with interaction effect
# These two calls are equivalent
res.aov3 <- aov(TotalpermL ~ Transit * Donor, data = my_data)
summary(res.aov3)
# Post-hoc: Tukey multiple pairwise-comparisons
TukeyHSD(res.aov3, which = "Donor")
TukeyHSD(res.aov3, which = "Transit")
# Assumptions
# 1. Homogeneity of variances
plot(res.aov3, 1)
## Levene's test, p has to be LARGER than 0.05!
car::leveneTest(TotalpermL ~ Transit * Donor, data = my_data)
# 2. Normality, all the points have to fall approximately along this reference line to assume normality
plot(res.aov3, 2)
## Extract the residuals
aov_residuals <- residuals(object = res.aov3)
## Run Shapiro-Wilk test, H0: a variable is normally distributed in some population. Reject the null hypothesis if p < 0.05
t <- shapiro.test(x = aov_residuals); if(t[["p.value"]]<0.05){
  message(crayon::red(paste0("p=", t[["p.value"]],", Data is not normally distributed!")))} else{
    message(crayon::green("Data is normally distributed"))}
```

## Statistical data analysis - non parametric
```{r Kruskal-Wallis, fig.height=18, fig.width=18}
# Non parametric to 1-way ANOVA, alternative - Kruskal-Wallis
correction <- "holm"
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between transit times"))
for (i in c("P", "D")) {
  my_data <- subset(df.counts, Vessel == i); my_data <- subset(my_data, Ninetransit == 3)
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
  for (j in c(1,2,3,4,5,6)) {
    my_data2 <- subset(my_data, Donor == j)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(TotalpermL ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(TotalpermL ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(TotalpermL ~ Transit, p.adjust.method = correction)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Donor ",j,", ",i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Donor ",j,", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = "TotalpermL") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}
}; ggarrange(plotlist = gglist, nrow = 4, ncol = 3)

# Between donors
gglist <- list(); x = 1; df.pwc1 <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between donors"))
for (i in c("P", "D")) {
  my_data <- subset(df.counts, Vessel == i); my_data <- subset(my_data, Ninetransit == 3);
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
  for (j in c("ST", "MT", "LT")) {
    my_data2 <- subset(my_data, Transit == j)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(TotalpermL ~ Donor)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(TotalpermL ~ Donor)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){ 
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(TotalpermL ~ Donor, p.adjust.method = correction)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Transit ",j,", ",i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Transit ",j,", ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Donor")
    gglist[[x]]<- ggboxplot(my_data2, x = "Donor", y = "TotalpermL") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Transit ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}
};  ggarrange(plotlist = gglist, nrow = 2, ncol = 3)





# Non parametric to 1-way ANOVA without donor separation, alternative - Kruskal-Wallis
# Between transits
gglist <- list(); x = 1; df.pwc <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between transit times"))
for (i in c("P", "D")) {
  my_data <- subset(df.counts, Vessel == i); my_data <- subset(my_data, Ninetransit == 3)
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
  
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(TotalpermL ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(TotalpermL ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(TotalpermL ~ Transit, p.adjust.method = correction, paired = F)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: ",i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = "TotalpermL") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}; ggarrange(plotlist = gglist, nrow = 4, ncol = 3)

# Between vessels
gglist <- list(); x = 1; df.pwc1 <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between vessels"))
  for (j in c("ST", "MT", "LT")) {
    my_data2 <- subset(df.counts, Transit == j); my_data2 <- subset(my_data2, Ninetransit == 3)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(TotalpermL ~ Vessel)
    test1<- subset(my_data2, Vessel == "P"); test<- subset(my_data2, Vessel == "D")
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(TotalpermL ~ Vessel)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){ 
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(TotalpermL ~ Vessel, p.adjust.method = "bonferroni", paired = F)
    pwc <- subset(pwc, p != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Vessel")
    gglist[[x]]<- ggboxplot(my_data2, x = "Vessel", y = "TotalpermL") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Transit ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}; ggarrange(plotlist = gglist, nrow = 2, ncol = 3)
df.pwc.total <- df.pwc; df.pwc1.total <- df.pwc1
View(df.pwc.total); View(df.pwc1.total)


message(crayon::blue("Percentage intact cells"))

# PERCENTAGE INTACT CELLS
# Non parametric to 1-way ANOVA without donor separation, alternative - Kruskal-Wallis
# Between transits
message(crayon::blue("Between transits"))
gglist <- list(); x = 1; df.pwc <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between transit times"))
for (i in c("P", "D")) {
  my_data <- subset(df.counts, Vessel == i); my_data <- subset(my_data, Ninetransit == 3)
  if(i == "P"){i = "Proximal colon"}; if(i == "D"){i = "Distal colon"}
  
    my_data2 <- my_data
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(Perc_intact ~ Transit)
    
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(Perc_intact ~ Transit)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(Perc_intact ~ Transit, p.adjust.method = correction, paired = F)
    pwc <- subset(pwc, p.adj.signif != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc <- rbind(df.pwc, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: ",i, ", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: ",i, ", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Transit")
    gglist[[x]]<- ggboxplot(my_data2, x = "Transit", y = "Perc_intact") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Donor ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}; ggarrange(plotlist = gglist, nrow = 4, ncol = 3)

# Between vessels
message(crayon::blue("Between vessels"))
gglist <- list(); x = 1; df.pwc1 <- data.frame()
message(paste("Kruskal-Wallis tests with ",correction," correction between vessels"))
  for (j in c("ST", "MT", "LT")) {
    my_data2 <- subset(df.counts, Transit == j); my_data2 <- subset(my_data2, Ninetransit == 3)
    res.kruskal <- my_data2 %>% rstatix::kruskal_test(Perc_intact ~ Vessel)
    test1<- subset(my_data2, Vessel == "P"); test<- subset(my_data2, Vessel == "D")
    # Effect size The interpretation values commonly in published literature are: 
    # 0.01- < 0.06 (small effect), 0.06 - < 0.14 (moderate    effect) and >= 0.14 (large effect).
    effsize <- my_data2 %>% kruskal_effsize(Perc_intact ~ Vessel)
    if(effsize$effsize>0.13){
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (large effect size is detected)")
    }else{if(effsize$effsize>0.06){ 
      effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (moderate effect size is detected)")
    }else{effsize <- paste0(", effsize= ", signif(effsize$effsize, digits = 5)," (WARNING: low effect size is detected)")}}
    
    # Pairwise comparisons using Wilcoxon’s test:
    pwc <- my_data2 %>%  wilcox_test(Perc_intact ~ Vessel, p.adjust.method = "bonferroni", paired = F)
    pwc <- subset(pwc, p != "ns")
    pwc$Vessel <- i; pwc$Transit <- j; df.pwc1 <- rbind(df.pwc1, pwc)
    # print(pwc) # print pairwise comparisons
    
       
    if(res.kruskal$p < 0.05){
      message(crayon::green(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))
      }else{
      message(crayon::red(paste0("Kruskal-Wallis: Transit ",j,", p = ",res.kruskal$p, effsize)))}
    
    # Visualization: box plots with p-values
    pwc <- pwc %>% add_xy_position(x = "Vessel")
    gglist[[x]]<- ggboxplot(my_data2, x = "Vessel", y = "Perc_intact") +
    stat_pvalue_manual(pwc, hide.ns = TRUE) +
    labs(title = paste0("Transit ",j,", Vessel ",i),
    subtitle = get_test_label(res.kruskal, detailed = TRUE),
    caption = get_pwc_label(pwc))
    x = x +1}; ggarrange(plotlist = gglist, nrow = 2, ncol = 3)
View(df.pwc); View(df.pwc1)






rm(pwc, effsize, gglist,res.kruskal,my_data2)
```

## Average numbers
```{r Average numbers}
  df <- subset(df.counts, Ninetransit == 3); df$comb <- paste0(df$Transit, df$Vessel)
# df<-subset(df, Donor == 2| Donor ==1)
# df<-subset(df, Donor != 1);  df<-subset(df, Donor != 2)
df5 <- df
df <- df %>% group_by(comb) %>% 
    summarise(SDtot = sd(TotalpermL), meantot = mean(TotalpermL), SDPer = sd(Perc_intact), meanperc = mean(Perc_intact),
      Transit = Transit, Vessel = Vessel) ; df <- df[!duplicated(df), ]
for(i in c(1:nrow(df))){
  df2 <- df[i,]
  message(paste0("Transit: ",df2$Transit,", Vessel: ", df2$Vessel, " ",
                 format(df2$meantot,scientific = T), " +- ",format(df2$SDtot, scientific = T)))
}

# Calculate covariance for error propagation
df3 <- data.frame(); df2 <- df5
PST = subset(subset(df2, Vessel == "P" & Transit == "ST"), select = TotalpermL)
PMT = subset(subset(df2, Vessel == "P" & Transit == "MT"), select = TotalpermL)
PLT = subset(subset(df2, Vessel == "P" & Transit == "LT"), select = TotalpermL)
DST = subset(subset(df2, Vessel == "D" & Transit == "ST"), select = TotalpermL)
DMT = subset(subset(df2, Vessel == "D" & Transit == "MT"), select = TotalpermL)
DLT = subset(subset(df2, Vessel == "D" & Transit == "LT"), select = TotalpermL)
min <- min(nrow(PST), nrow(PMT), nrow(PLT))
PST <- PST[1:min,]; PMT <- PMT[1:min,]; PLT <- PLT[1:min,]
COVPSL <- abs(cov(PST,PLT)); COVPSM <- abs(cov(PST,PMT)); COVPML <- abs(cov(PLT,PMT))  
dfP <- data.frame(t(subset(df, Vessel == "P"))); dfP <- janitor::row_to_names(dfP, row_number = 1)
dfP <- dfP[2,]; dfPSD <- dfP[1,]
colnames(dfPSD) <- c("SDLT", "SDMT", "SDST")
dfP$LTP <- as.numeric(dfP$LTP); dfP$MTP <- as.numeric(dfP$MTP); dfP$STP <- as.numeric(dfP$STP) # make df numeric
dfP$COVPSL <- COVPSL; dfP$COVPSM <- COVPSM; dfP$COVPML <- COVPML # Add covariates to df
dfP$LTST <- dfP$LTP/dfP$STP; dfP$MTST <- dfP$MTP/dfP$STP; dfP$LTMT <- dfP$LTP/dfP$MTP # Ratio
dfP$LT.ST <- dfP$LTP*dfP$STP; dfP$MT.ST <- dfP$MTP*dfP$STP; dfP$LT.MT <- dfP$LTP*dfP$MTP # Multiplication
dfP <- cbind(dfP, dfPSD)
dfP[] <- lapply(dfP, as.numeric)
dfP <- mutate(dfP, SDpropSTLT = (abs(LTST)*sqrt((SDST/STP)^2 + (SDLT/LTP)^2 - 2*(COVPSL/LT.ST))),
              SDpropMTLT = (abs(LTMT)*sqrt((SDMT/MTP)^2 + (SDLT/LTP)^2 - 2*(COVPML/LT.MT))),
              SDpropMTST = (abs(MTST)*sqrt((SDST/STP)^2 + (SDMT/MTP)^2 - 2*(COVPSM/MT.ST))))



min <- min(nrow(DST), nrow(DMT), nrow(DLT))
DST <- DST[1:min,]; DMT <- DMT[1:min,]; DLT <- DLT[1:min,]
COVDSL <- abs(cov(DST,DLT)); COVDSM <- abs(cov(DMT,DST)); COVDML <- abs(cov(DLT,DMT))
dfD <- data.frame(t(subset(df, Vessel == "D"))) ; dfD <- janitor::row_to_names(dfD, row_number = 1)
dfDSD <- dfD[1,]; dfD <- dfD[2,]
colnames(dfDSD) <- c("SDLT", "SDMT", "SDST")
dfD$LTD <- as.numeric(dfD$LTD); dfD$MTD <- as.numeric(dfD$MTD); dfD$STD <- as.numeric(dfD$STD) # make df numeric
dfD$COVDSL <- COVDSL; dfD$COVDSM <- COVDSM; dfD$COVDML <- COVDML # Add covariates to df
dfD$LTST <- dfD$LTD/dfD$STD; dfD$MTST <- dfD$MTD/dfD$STD;dfD$LTMT <- dfD$LTD/dfD$MTD
dfD$LT.ST <- dfD$LTD*dfD$STD; dfD$MT.ST <- dfD$MTD*dfD$STD; dfD$LT.MT <- dfD$LTD*dfD$MTD # Multiplication
dfD <- cbind(dfD, dfDSD)
dfD[] <- lapply(dfD, as.numeric)
dfD <- mutate(dfD, SDpropSTLT = (abs(LTST)*sqrt((SDST/STD)^2 + (SDLT/LTD)^2 - 2*(COVDSL/LT.ST))),
              SDpropMTLT = (abs(LTMT)*sqrt((SDMT/MTD)^2 + (SDLT/LTD)^2 - 2*(COVDML/LT.MT))),
              SDpropMTST = (abs(MTST)*sqrt((SDST/STD)^2 + (SDMT/MTD)^2 - 2*(COVDSM/MT.ST))))


dfP <- subset(dfP, select = c(LTST, SDpropSTLT, MTST, SDpropMTST, LTMT, SDpropMTLT)) 
dfD <- subset(dfD, select = c(LTST, SDpropSTLT, MTST, SDpropMTST, LTMT, SDpropMTLT))
row.names(dfP)[row.names(dfP) == "meantot"] <- "meanP"
row.names(dfD)[row.names(dfD) == "meantot"] <- "meanD"

df <- rbind(dfP, dfD)
message("Ratio in counts")
df



df <- df %>% group_by(Vessel) %>% 
    summarise(SDtot = sd(TotalpermL), meantot = mean(TotalpermL),
      Vessel = Vessel) ; df <- df[!duplicated(df), ]
for(i in c(1:nrow(df))){
  df2 <- df[i,]
  message(paste0("Transit: ",df2$Transit,", Vessel: ", df2$Vessel, " ",
                 format(df2$meantot,scientific = T), " +- ",format(df2$SDtot, scientific = T)))
}
```

# Visualisation in plots
## Stabilised communities
```{r Boxplots stabilised communities, fig.height=16, fig.width=14}
saveplots()
# Inidividual samples
my_comparisons <- list(c("ST", "MT"), c("MT", "LT"), c("ST", "LT"))
df <- subset(df.counts, Transit != "FS"); df <- subset(df, Ninetransit == 3)
max <- max(df$TotalpermL); min <- min(df$TotalpermL)
plot <- papertheme(ggplot(df, aes(x = Transit, y = TotalpermL, fill = Transit))+ 
             geom_boxplot(color = "black") + geom_jitter(color = "grey", alpha = 0.7) +
             scale_y_continuous(limits = c(min-1, max + min)) +
             # geom_point()+
             scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) +
  facet_grid(Vessel~intTransit+Donor, labeller = labeller(Donor = donor.labs, Vessel = PD_Colon.labs))) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), axis.text.x = element_blank(), 
  axis.ticks.x = element_blank(), axis.title.x = element_blank()) +
  stat_compare_means(comparisons = my_comparisons, label = "p.signif", hide.ns = T, hide.NS = T, 
                     label.y = c(max-min, max-min, max)) + # Add significance levels
  ylab(expression(paste("Microbial load (cells m",L^{"-1"}, ")"))) + xlab("Transit time")
plot
plot <- plot + theme(legend.position = "none")
## Combine top label rows
plot2 <- Fusetoplayer(plot)
plot2
ggsave(plot = plot2, width = 16, height = 10, dpi = 400, filename = "microbialload_hires.tiff")
ggsave(plot = plot2, width = 16, height = 10, dpi = 100, filename = "microbialload_lores.tiff")
# tiff(file="microbialload_hires.tiff", width=16, height=10, units="in",res=400)
# grid.newpage();grid.draw(pgNew)
# dev.off()
# Percentage plot
max <- max(df$Perc_intact); min <- min(df$Perc_intact)
plot1 <- papertheme(ggplot(df, aes(x = Transit, y = Perc_intact, fill = Transit))+ 
             geom_boxplot(color = "black") + geom_jitter(color = "grey", alpha = 0.7) +
             scale_y_continuous(limits = c(min-1, max + 7)) +
             # geom_point()+
             scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) +
  facet_grid(Vessel~intTransit+Donor, labeller = labeller(Donor = donor.labs, Vessel = PD_Colon.labs))) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), axis.text.x = element_blank(), 
  axis.ticks.x = element_blank(), axis.title.x = element_blank()) +
  stat_compare_means(comparisons = my_comparisons, label = "p.signif", hide.ns = T, hide.NS = T, na.rm = T, 
                     label.y = c(max, max, max+4)) + # Add significance levels
  ylab("Percentage intact cells (%)") + xlab("Transit time")
plot1
plot1<- plot1 + theme(legend.position = c(0.92,0.11), legend.text = element_text(size = 17),
                      legend.title = element_text(size=18)); plot1
## Combine top label rows
### Get the ggplot grob
pg = ggplotGrob(plot1)
index = which(pg$layout$name == "strip-t-1"); strip1 = pg$grobs[[index]] # Get the left most strip
grid.newpage(); grid.draw(strip1) # Draw the strip
strip1$layout; gtable_show_layout(strip1) # Examine its layout
# Get a list of strips from the original plot
strip = lapply(grep("strip-t", pg$layout$name), function(x) {pg$grobs[[x]]})
# Construct gtable to contain the new strip
newStrip  = gtable(widths = unit(rep(1, 6), "null"), heights = strip[[1]]$heights) # rep(1,#panels below)
## Populate the gtable    
cols <- seq(1, by = 2, length.out = 3) # seq(start, by = panels under this row, length.out = panel amount)
newStrip <- gtable_add_grob(newStrip, 
         lapply(strip[cols], `[`, 1), t = 1, l = cols, r = cols + 1) #r = cols + panels under row
# Put the strip into the plot
pgNew1 <- gtable_add_grob(pg, newStrip, t = 7, l = 5, r = 15)
class(pgNew1)
# Draw the plot
# p<- grid.newpage();
plot3 <- ggdraw() + draw_grob(pgNew1); plot3
ggsave(plot = plot3, width = 16, height = 10, dpi = 400, filename = "perintact_hires.tiff")
ggsave(plot = plot3, width = 16, height = 10, dpi = 100, filename = "perintact_lores.tiff")
comboplot <- ggarrange(plot2, plot3, labels = "AUTO", nrow = 2, 
                       font.label = list(size = 20, color = "black"), align = "hv"); comboplot
rm(plot2, plot3)
# tiff(file="perintact_hires.tiff", width=16, height=10, units="in",res=400)
# grid.newpage();grid.draw(pgNew1)
# dev.off()
# grid
# Combine in one plot
comboplot <- ggdraw() + draw_grob(pgNew, height = 0.5, y = 0.5) + 
  draw_grob(pgNew1, height = 0.5, width = (1-0.035), x = 0.035, y = 0); comboplot
comboplot1 <- ggdraw() + draw_grob(pgNew) 
comboplot2 <- ggdraw() + draw_grob(pgNew1, width = (1-0.035), x = 0.035)
comboplot <- ggarrange(comboplot1, comboplot2, labels = "AUTO", nrow = 2, 
                       font.label = list(size = 20, color = "black")); comboplot
rm(comboplot1, comboplot2)
ggsave(plot = comboplot, width = 16, height = 20, dpi = 300, filename = "paperplot_fcm_comboplot.tiff")
```

# Figure S7 - Stabilised community
```{r Paperplot dotplot, fig.height=6, fig.width=16}
# Create means for dotplot
df <- subset(by_nr, Transit != "FS"); df <- subset(df, Ninetransit == 3)
df2 <- subset(df.counts, Transit != "FS"); df2 <- subset(df2, Ninetransit == 3)
max <- max(df2$TotalpermL); min <- min(df2$TotalpermL)
df1 <- subset(df, Transit == "ST") 
df1$Day[df1$Day == 6] <-1;df1$Day[df1$Day == 7] <-2;df1$Day[df1$Day == 8] <-3;df1$Day[df1$Day == 9] <-4;df1$Day[df1$Day == 10] <-5
df2 <- subset(df, Transit == "MT")
df2$Day[df2$Day == 11] <-1;df2$Day[df2$Day == 12] <-2;df2$Day[df2$Day == 13] <-3;df2$Day[df2$Day == 14] <-4;df2$Day[df2$Day == 15] <-5
df3 <- subset(df, Transit == "LT"); df4 <- subset(df3, Donor == 1|Donor ==2)
df4$Day[df4$Day == 15] <-1;df4$Day[df4$Day == 16] <-2;df4$Day[df4$Day == 17] <-3;df4$Day[df4$Day == 18] <-4;df4$Day[df4$Day == 19] <-5
df3 <- subset(df3, Donor == 3|Donor ==4|Donor == 5|Donor ==6)
df3$Day[df3$Day == 16] <-1;df3$Day[df3$Day == 17] <-2;df3$Day[df3$Day == 18] <-3;df3$Day[df3$Day == 19] <-4;df3$Day[df3$Day == 20] <-5
df <- rbind(df1, df2, df4, df3)


plot <- papertheme(ggplot(df, aes(x = Day, y = meantot, color = Transit, shape = Transit))) + geom_point(size = 4)+ geom_line(aes(group = Transit))+ 
  geom_errorbar(aes(ymin=meantot-SDtot, ymax=meantot+SDtot), width = 0.5, alpha = 0.7) + 
  scale_color_manual(values = transitcolors,labels=c("Short", "Medium", "Long")) +
  facet_grid(Vessel ~ intTransit + Donor , labeller = labeller(Vessel = Vessel.labs, Donor = donor.labs)) +
  ylab(expression(paste("Total cell concentration (cells m",L^{"-1"}, ")"))) + xlab("Stabilised time (Days)")+ 
  theme(strip.background = element_rect(fill = "#D6E0F4"), legend.position = c(0.075,0.92), legend.text = element_text(size = 18), 
        legend.title = element_text(size = 18) 
        # strip.text.y = element_blank()
        ) + labs(color='SHIME transit')+
  scale_y_continuous(limits = c(0, max+ min))
ggarrange(plot, NULL, ncol = 2, widths = c(1,0.3))

if(BW == TRUE){
  plot <- plot + scale_color_grey(start = 0, end = 0.2) + scale_fill_grey() +scale_shape_manual(name = "SHIME transit", values = c("ST" = 15, "MT" = 17, "LT" = 19),labels=c("Short", "Medium", "Long")) + theme(legend.position = "bottom", strip.background = element_rect(fill = "lightgrey")) + guides(alpha = "none", fill = "none", color = "none") 
}else{
  plot <- plot + scale_shape_manual(values = c("ST" = 19, "MT" = 19, "LT" = 19))
}
# plot
plot <- Fusetoplayer(plot)


my_comparisons <- list(c("ST", "MT"), c("MT", "LT"), c("ST", "LT"))
df2 <- subset(df.counts, Transit != "FS"); df2 <- subset(df2, Ninetransit == 3)
dat_text <- data.frame(label = c("a*", "b*", "c*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(max - (min*2), max - min, max, max - (min), max, max + (min)))
  # value     = c(max - (min*2),max- min,max,max- (min*2),max-min,max))
  
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
c(max-(min),max, max+(min))
plot2 <- papertheme(ggplot(df2, aes(x = Transit, y = TotalpermL, fill = Transit))+ 
             geom_boxplot(color = "black") + 
               # geom_jitter(colour = "grey", alpha = 0.7, size = 1) +
             scale_y_continuous(limits = c(0, max+ min)) +
             # geom_point()+
             scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) +
             # scale_colour_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) +
  facet_grid(Vessel~., labeller = labeller(Donor = donor.labs, Vessel = PD_Colon.labs))) +
  scale_x_discrete(labels= c("Short", "Medium", "Long")) + 
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), legend.position = "none", 
  axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 7) +
  # axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.title.x = element_blank()
  # stat_compare_means(comparisons = my_comparisons, label = "p.signif", hide.ns = T, hide.NS = T, 
  #                    label.y = c(max-min, max-min, max)) + # Add significance levels
  ylab(expression(paste("Total cell concentration (cells m",L^{"-1"}, ")"))) + xlab("SHIME transit time")
plot2

plotA <- plot; plotB <- plot2
paperplot_dotplot <- plotB
comb <- ggarrange(plot, ggarrange(NULL, plot2, nrow = 2, heights = c(0.1,1.15)), 
                  ncol = 2, widths = c(1,0.3), labels = "AUTO", font.label = list(size =20));comb
plotA + ylab(expression(paste("Cell concentration (cells m",L^{"-1"}, ")")))
setwd("/Projects2/Yorick/Rstudio_projects/Task1.2TransitSHIME/Data/Results/Plots")
ggsave(plot = comb, width = 16, height = 11, dpi = 400, filename = "microbialload_stabilised_hires.tiff")
ggsave(plot = comb, width = 16, height = 11, dpi = 100, filename = "microbialload_stabilised_lores.tiff")
rm(dat_text, plot, plot2, df1, df2, df3, df4, df, comb)
```


## Paperplot percentages
```{r Paperplot dotplot, fig.height=17.5, fig.width=20}
# Create means for dotplot
df <- subset(by_nr, Transit != "FS"); df <- subset(df, Ninetransit == 3)
df2 <- subset(df.counts, Transit != "FS"); df2 <- subset(df2, Ninetransit == 3)
max <- max(df2$Perc_intact); min <- min(df2$Perc_intact)
df1 <- subset(df, Transit == "ST") 
df1$Day[df1$Day == 6] <-1;df1$Day[df1$Day == 7] <-2;df1$Day[df1$Day == 8] <-3;df1$Day[df1$Day == 9] <-4;df1$Day[df1$Day == 10] <-5
df2 <- subset(df, Transit == "MT")
df2$Day[df2$Day == 11] <-1;df2$Day[df2$Day == 12] <-2;df2$Day[df2$Day == 13] <-3;df2$Day[df2$Day == 14] <-4;df2$Day[df2$Day == 15] <-5
df3 <- subset(df, Transit == "LT"); df4 <- subset(df3, Donor == 1|Donor ==2)
df4$Day[df4$Day == 15] <-1;df4$Day[df4$Day == 16] <-2;df4$Day[df4$Day == 17] <-3;df4$Day[df4$Day == 18] <-4;df4$Day[df4$Day == 19] <-5
df3 <- subset(df3, Donor == 3|Donor ==4|Donor == 5|Donor ==6)
df3$Day[df3$Day == 16] <-1;df3$Day[df3$Day == 17] <-2;df3$Day[df3$Day == 18] <-3;df3$Day[df3$Day == 19] <-4;df3$Day[df3$Day == 20] <-5
df <- rbind(df1, df2, df4, df3)

max = 90

my_comparisons <- list(c("ST", "MT"), c("MT", "LT"), c("ST", "LT"))
df2 <- subset(df.counts, Transit != "FS"); df2 <- subset(df2, Ninetransit == 3)
dat_text <- data.frame(label = c("ab*", "a*", "b*", "a*", "b*", "c*"),
  Vessel   = c("P","P","P","D","D","D"),
  Transit  = c("ST", "MT", "LT", "ST", "MT", "LT"),
  value     = c(max + 5, max + 2.5, max , max + 5, max+2.5, max ))
 
  
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))
dat_text$Transit <- factor(dat_text$Transit, levels = c("ST", "MT", "LT"))
c(max-(min),max, max+(min))


## Boxplot
  plot2 <- papertheme(ggplot(df2, aes(x = Transit, y = Perc_intact, fill = Transit))+ 
                     
                      geom_jitter(aes(color = Donor),  size = 3, alpha = 0.8) +
                      geom_boxplot(color = "black", alpha = 0.3) + 
              
             scale_y_continuous(limits = c(37, 100)) +
             # geom_point()+
             scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) +
             scale_colour_manual(values = sixdonors) +
  facet_grid(Vessel~., labeller = labeller(Donor = donor.labs, Vessel = PD_Colon.labs))) +
  scale_x_discrete(labels= c("Short", "Medium", "Long")) + 
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270) 
  # legend.position = "none", 
  # axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank()
  )+
  guides(alpha = "none", fill = "none", size = "none", 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
      theme(legend.position = c(0.5, 0.09), legend.box = "horizontal", legend.title = element_text(size = 17), legend.text = element_text(size = 16), legend.background = element_blank())+
  geom_text(data= dat_text,  mapping = aes(x = factor(Transit), y = as.numeric(value), label = label, family = 'sans'), size = 7) +
  # axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.title.x = element_blank()
  # stat_compare_means(comparisons = my_comparisons, label = "p.signif", hide.ns = T, hide.NS = T, 
  #                    label.y = c(max-min, max-min, max)) + # Add significance levels
  ylab("Intact microbial cells (%)") + xlab("SHIME transit time")
plot2
plotE <- plot2
paperplot_percentages <- plotE


ggarrange(
          ggarrange(NULL, NULL, plot2, 
                    labels = c("A", "B", "C"), font.label = list(size =20), ncol = 3, widths = c(1.3,1.3,0.9)),
          ggarrange(NULL, ggarrange(NULL, NULL, nrow = 2, heights = c(0.1,1.25)), 
                  ncol = 2, widths = c(1,0.3), labels = c("D", "E"), font.label = list(size =20)), nrow=2, heights = c(0.6,1))
# rm(dat_text, plot, plot2, df1, df2, df3, df4, df, comb)
```




## Supp stabilisation period
```{r Stabilisation period, fig.height=10, fig.width=14}
saveplots()
# Individual samples
df <- subset(by_nr, Transit != "FS"); df$Day <- as.numeric(df$Day)
max <- max(df$meantot); min <- min(df$meantot)
plot <- papertheme(ggplot(df, aes(x = Day, y = meantot, color = Transit))+ 
             geom_point(size = 4)+ geom_line()+
             # scale_y_continuous(limits = c(min-1, max + min)) +
             # geom_point()+
             # scale_fill_manual(values = transitcolors, labels = c("Short", "Medium", "Long")) +
  facet_grid(Vessel~intTransit+Donor, labeller = labeller(Donor = donor.labs, Vessel = PD_Colon.labs))) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), axis.text.x = element_blank(), 
  axis.ticks.x = element_blank(), axis.title.x = element_blank()) +
  scale_color_manual(values = transitcolors, labels = c("Short", "Medium", "Long"))+
  geom_errorbar(aes(ymin=meantot-SDtot, ymax=meantot+SDtot)) +
  ylab(expression(paste("Microbial load (cells m",L^{"-1"}, ")"))) + xlab("Time (Days)")+
  scale_x_continuous(breaks=c(5,10,15,20))
plot <- plot + theme(legend.position = c(0.07,0.91))
plot
## Combine top label rows
### Get the ggplot grob
pg = ggplotGrob(plot)
index = which(pg$layout$name == "strip-t-1"); strip1 = pg$grobs[[index]] # Get the left most strip
grid.newpage(); grid.draw(strip1) # Draw the strip
strip1$layout; gtable_show_layout(strip1) # Examine its layout
# Get a list of strips from the original plot
strip = lapply(grep("strip-t", pg$layout$name), function(x) {pg$grobs[[x]]})
# Construct gtable to contain the new strip
newStrip  = gtable(widths = unit(rep(1, 6), "null"), heights = strip[[1]]$heights) # rep(1,#panels below)
## Populate the gtable    
cols <- seq(1, by = 2, length.out = 3) # seq(start, by = panels under this row, length.out = panel amount)
newStrip <- gtable_add_grob(newStrip, 
         lapply(strip[cols], `[`, 1), t = 1, l = cols, r = cols + 1) #r = cols + panels under row
# Put the strip into the plot
pgNew <- gtable_add_grob(pg, newStrip, t = 7, l = 5, r = 15)
# Draw the plot
# p<- grid.newpage();
plot <- ggdraw() + draw_grob(pgNew); plot
ggsave(plot = plot, width = 16, height = 10, dpi = 400, filename = "microbialload_stabilisation_hires.tiff")
ggsave(plot = plot, width = 16, height = 10, dpi = 100, filename = "microbialload_stabilisation_lores.tiff")
```

## Paperplot Faecal
```{r Paperplot faecal samples, fig.height=8, fig.width=12}
# Create means for dotplot
df <- subset(by_nr, Day == 0)
df2 <- subset(df.counts, Day == 0)
df2 <- subset(df2, Name != "200.3")
df2 <- subset(df2, Name != "300.1")
df5 <- subset(df2, Donor == 5)
df5$TotalpermL <- df5$TotalpermL*2
df2 <- rbind(df5, subset(df2, Donor == 1 | Donor ==2| Donor ==3| Donor ==4| Donor ==6))
df2$TotalpermL <- df2$TotalpermL*5
max <- max(df2$TotalpermL); min <- min(df2$TotalpermL)

unique(df2$intTransit)
df2.1 <- subset(df2, intTransit == "Long transit donor"); df2.1$xtratransit <- "Long transit \n donor"
df2.2 <- subset(df2, intTransit == "Medium transit donor"); df2.2$xtratransit <- "Med transit \n donor"
df2.3 <- subset(df2, intTransit == "Short transit donor"); df2.3$xtratransit <- "Short transit \n donor"
df2 <- rbind(df2.1, df2.2, df2.3); unique(df2$xtratransit)
df2$xtratransit <- as.ordered(factor(df2$xtratransit,
              levels=c("Short transit \n donor", "Med transit \n donor", "Long transit \n donor")))


# df2.1 <- subset(df2, intTransit == "Long transit donor")
# df2.1$xtratransit <- paste("Long",lblinvivo,"\n transit")
# df2.2 <- subset(df2, intTransit == "Medium transit donor"); 
# df2.2$xtratransit <- paste("Medium",lblinvivo,"\n transit")
# df2.3 <- subset(df2, intTransit == "Short transit donor"); 
# df2.3$xtratransit <- paste("Short",lblinvivo,"\n transit")
# 
# df2 <- rbind(df2.1, df2.2, df2.3); unique(df2$xtratransit)
# df2$xtratransit <- as.ordered(factor(df2$xtratransit,
#               levels=c(paste("Short",lblinvivo,"\n transit"), 
#                        paste("Medium",lblinvivo,"\n transit"), 
#                        paste("Long",lblinvivo,"\n transit"))))


plot <- papertheme(ggplot(df2, aes(x = Donor, y = TotalpermL, fill = Donor))+ 
             geom_boxplot(color = "black"))  +
             scale_fill_manual(values = sixdonors) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), legend.position = "none")+
  facet_grid(.~xtratransit, scales = "free_x"
             ) +
  ylab(expression(paste("Faecal cell concentration (cells ",g^{"-1"}, ")"))) + xlab("Donor")
plot
plotC <- plot
paperplot_faecal <- plot
# 
# saveplots()
# ggsave(plot = comb, width = 16, height = 11, dpi = 400, filename = "microbialload_stabilised_hires.tiff")
# ggsave(plot = comb, width = 16, height = 11, dpi = 100, filename = "microbialload_stabilised_lores.tiff")


## Check for correlations
df <- subset(df2, Donor == 1); df$Corntransit <- 21; df$cornmean <- 20; df$BSS <- 4
df3 <- subset(df2, Donor == 2); df3$Corntransit <- 19; df3$cornmean <- 20; df3$BSS <- 4
df4 <- subset(df2, Donor == 3); df4$Corntransit <- 43; df4$cornmean <- 39; df4$BSS <- 3
df5 <- subset(df2, Donor == 4); df5$Corntransit <- 34; df5$cornmean <- 39; df5$BSS <- 2
df6 <- subset(df2, Donor == 5); df6$Corntransit <- 75; df6$cornmean <- 68; df6$BSS <- 1
df7 <- subset(df2, Donor == 6); df7$Corntransit <- 61; df7$cornmean <- 68; df7$BSS <- 2
df<- rbind(df,df3,df4,df5,df6,df7); df$Corntransit <- as.numeric(df$Corntransit); df$cornmean <- as.numeric(df$cornmean)


rhot <- cor.test(df$Corntransit, df$TotalpermL, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, "= 0.674"))
summary(lm(df$Corntransit ~ df$TotalpermL))


plot <- papertheme(ggplot(df, aes(x = as.numeric(Corntransit), y = as.numeric(TotalpermL), fill = Donor))+ 
             geom_boxplot(color = "black", alpha = 0.8))  +
  geom_jitter(aes(color = intTransit, size = 5)) + 
             scale_fill_manual(values = sixdonors) +
  scale_color_manual(values = inttransitcolours, name = "In vivo transit")+
  guides(alpha = "none", size = "none", fill=guide_legend(ncol=3, title.position = "top", title.hjust = 0.5), 
            color=guide_legend(ncol = 1, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
    strip.text.y = element_text(size = 20, angle = 270), legend.position = c(0.70,0.12), legend.box = "horizontal") +
  ylab(expression(paste("Cell concentration (cells ",g^{"-1"}, ")"))) + xlab("Corn transit time (h)")+geom_smooth(method="lm", col="black")+
stat_smooth()  ;plot
plot+
  geom_text(x = 18, y = 4.7e+11, size = 7, colour = "#666666", family="sans", label = eq(log(df$Corntransit),df$TotalpermL, type = "log"), 
            parse = TRUE, hjust = 0) +
  geom_text(x = 18, y = 4.5e+11, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)  

?cca()
rm(rhot) 
rhot <- cor.test(log(df$cornmean), df$TotalpermL, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, "= 0.725"))
summary(lm(df$cornmean ~ df$TotalpermL))


plot <- papertheme(ggplot(df, aes(x = as.numeric(cornmean), y = as.numeric(TotalpermL), fill = intTransit))+ 
                     geom_boxplot(color = "black", alpha = 0.8) +
                     geom_jitter(aes(color = Donor, size = 5))) +
             scale_fill_manual(values = inttransitcolours, name = "In vivo transit") +
  scale_color_manual(values = sixdonors) +
  guides(size = "none", fill=guide_legend(ncol=1, title.hjust = 0.5, title.position = "top"), 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), legend.position = c(0.70,0.12), legend.box = "horizontal") +
  ylab(expression(paste("Cell concentration (cells ",g^{"-1"}, ")"))) + xlab("Corn transit time per category (h)")+
  geom_smooth(method="lm")
plot 
plot+
  geom_text(x = 11, y = 4.7e+11, size = 7, colour = "#666666", family="sans", label = eq(log(df$cornmean),df$TotalpermL, type = "log"), 
            parse = TRUE, hjust = 0) +
  geom_text(x = 11, y = 4.5e+11, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)  




rhot <- cor.test(df$BSS, df$Corntransit, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, " = -0.90; ","p = 1.77E-06"))
summary(lm(df$BSS ~ df$Corntransit))





papertheme(ggplot(df, aes(x = as.numeric(BSS), y = as.numeric(Corntransit), color = Donor
                          , shape = intTransit #, fill = intTransit
                          ))+ 
             geom_point(size = 5,alpha = 0.8)) + ylab("Corn transit time (h)") + 
  geom_smooth(color = "black", 
              # fill = "#ffd9cc",
              method=lm, inherit.aes = F, mapping = aes(x = as.numeric(BSS), y = as.numeric(Corntransit)))+
  xlab("Bristol stool score") +
  scale_color_manual(values = sixdonors, name = "Donor") +
  scale_shape_manual(name = expression(paste(italic("In vivo"), " transit")), 
              values = c("Short transit donor" = 16, "Medium transit donor" = 17, "Long transit donor" = 15), labels = c("Short", "Medium", "Long"))+ guides(color = guide_legend(ncol = 2))+
  theme(legend.position = c(0.1,0.25), legend.direction = "vertical")+
  geom_text(x = 2.7, y = 75, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0) 


# rm(df, df2, df5)
```

## Conversion of BSS
```{r, fig.height=8, fig.width=12}
df <- subset(by_nr, Day == 0)
df2 <- subset(df.counts, Day == 0)
df2 <- subset(df2, Name != "200.3")
df2 <- subset(df2, Name != "300.1")
df5 <- subset(df2, Donor == 5)
df5$TotalpermL <- df5$TotalpermL*2
df2 <- rbind(df5, subset(df2, Donor == 1 | Donor ==2| Donor ==3| Donor ==4| Donor ==6))
df2$TotalpermL <- df2$TotalpermL*5
max <- max(df2$TotalpermL); min <- min(df2$TotalpermL)


plot <- papertheme(ggplot(df2, aes(x = Donor, y = TotalpermL, fill = Donor))+ 
             geom_boxplot(color = "black"))  +
             scale_fill_manual(values = sixdonors) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
  strip.text.y = element_text(size = 20, angle = 270), legend.position = "none")+
  facet_grid(.~intTransit, scales = "free_x") +
  ylab(expression(paste("Cell concentration (cells ",g^{"-1"}, ")"))) + xlab("Donor")
plot
plotC <- plot
# 
# saveplots()
# ggsave(plot = comb, width = 16, height = 11, dpi = 400, filename = "microbialload_stabilised_hires.tiff")
# ggsave(plot = comb, width = 16, height = 11, dpi = 100, filename = "microbialload_stabilised_lores.tiff")


## Check for correlations
df <- subset(df2, Donor == 1); df$Corntransit <- 21; df$cornmean <- 20; df$TotalpermL <- df$TotalpermL*0.261
df3 <- subset(df2, Donor == 2); df3$Corntransit <- 19; df3$cornmean <- 20; df3$TotalpermL <- df3$TotalpermL*0.261
df4 <- subset(df2, Donor == 3); df4$Corntransit <- 43; df4$cornmean <- 39; df4$TotalpermL <- df4$TotalpermL*0.303
df5 <- subset(df2, Donor == 4); df5$Corntransit <- 34; df5$cornmean <- 39; df5$TotalpermL <- df5$TotalpermL*0.309
df6 <- subset(df2, Donor == 5); df6$Corntransit <- 75; df6$cornmean <- 68; df6$TotalpermL <- df6$TotalpermL*0.341
df7 <- subset(df2, Donor == 6); df7$Corntransit <- 61; df7$cornmean <- 68; df7$TotalpermL <- df7$TotalpermL*0.309
df<- rbind(df,df3,df4,df5,df6,df7); df$Corntransit <- as.numeric(df$Corntransit); df$cornmean <- as.numeric(df$cornmean)



rhot <- cor.test(df$Corntransit, df$TotalpermL, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, "= 0.629"))
summary(lm(df$Corntransit ~ df$TotalpermL))


plot <- papertheme(ggplot(df, aes(x = as.numeric(Corntransit), y = as.numeric(TotalpermL), fill = Donor))+ 
             geom_boxplot(color = "black", alpha = 0.8))  +
  geom_jitter(aes(color = intTransit, size = 5)) + 
             scale_fill_manual(values = sixdonors) +
  scale_color_manual(values = inttransitcolours, name = "In vivo transit")+
  guides(alpha = "none", size = "none", fill=guide_legend(ncol=3, title.position = "top", title.hjust = 0.5), 
            color=guide_legend(ncol = 1, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
  theme(strip.background = element_rect(fill = "#D6E0F4"), strip.text.x = element_text(size = 20),
    strip.text.y = element_text(size = 20, angle = 270), legend.position = c(0.70,0.12), legend.box = "horizontal") +
  ylab(expression(paste("Cell concentration (cells ",g^{"-1"}, ")"))) + xlab("Corn transit time (h)")+geom_smooth(method="lm", col="black")+
stat_smooth()  ;plot
plot+
  geom_text(x = 18, y = 1.47e+11, size = 7, colour = "#666666", family="sans", label = eq(log(df$Corntransit),df$TotalpermL, type = "log"), 
            parse = TRUE, hjust = 0) +
  geom_text(x = 18, y = 1.4e+11, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)  

```

# Paperplot Correlation
```{r fig.height=7.5, fig.width=10}
library(caret)
df <- subset(counts, Ninetransit == 3)
df.1 <- subset(df, Vessel == "P" & Transit == "ST"); df.1$TT <- 8; df.1$TransitT <- "PST"
df.2 <- subset(df, Vessel == "P" & Transit == "MT"); df.2$TT <- 16; df.2$TransitT <- "PMT"
df.3 <- subset(df, Vessel == "P" & Transit == "LT"); df.3$TT <- 24; df.3$TransitT <- "PLT"
df.4 <- subset(df, Vessel == "D" & Transit == "ST"); df.4$TT <- 13; df.4$TransitT <- "DST"
df.5 <- subset(df, Vessel == "D" & Transit == "MT"); df.5$TT <- 26; df.5$TransitT <- "DMT"
df.6 <- subset(df, Vessel == "D" & Transit == "LT"); df.6$TT <- 39; df.6$TransitT <- "DLT"




df <- rbind(df.1, df.2, df.3, df.4, df.5, df.6); rm(df.1, df.2, df.3, df.4, df.5, df.6)

transitcolours2 = c("PST" = "#7ACD74","DST" = "#7ACD74", "PMT" = "#757BCD", "DMT" = "#757BCD", "PLT" = "#CD747A", "DLT" = "#CD747A")

eq <- function(x,y, type = "linear") {
  if(type == "linear"){
  m <- lm(y ~ x)
  as.character(
    as.expression(
      substitute(italic(y) == a + b %.% italic(x)*"  "~~italic(r)^2~"="~r2,
                list(a = format(coef(m)[[1]], scientific = T, digits = 2),
                b = format(coef(m)[[2]], scientific = T, digits = 2),
                r2 = format(summary(m)$r.squared, digits = 3)))
    )
  )
  }else{
    if(type == "poly"){
      # x = df$TT; y = df$TotalpermL
      m <- lm(y~ x + I(x^2), data = df)
      as.character(
        as.expression(
          substitute(italic(y) == a + b %.% italic(x) - c %.% italic(x^2)*"  "~~italic(r)^2~"="~r2,
                     list(a = format(coef(m)[[1]], scientific = T, digits = 2),
                          b = format(coef(m)[[2]], scientific = T, digits = 2),
                          c = format(abs(coef(m)[[3]]), scientific = T, digits = 2),
                          r2 = format(summary(m)$r.squared, digits = 3)))
          )
        )
    }
  else{
    if(type == "log"){
      m <- lm(y ~ x)
  as.character(
    as.expression(
      substitute(italic(y) == a + b %.% italic(log(x))*"  "~~italic(r)^2~"="~r2,
                list(a = format(coef(m)[[1]], scientific = T, digits = 2),
                b = format(coef(m)[[2]], scientific = T, digits = 2),
                r2 = format(summary(m)$r.squared, digits = 3))))
  )
    }
  }}
}

rhot <- cor.test(df$TT, df$TotalpermL, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, "= 0.833"))
summary(lm(df$TT ~ df$TotalpermL))


dat_text <- data.frame(label = c("PC", "PC", "PC", "DC", "DC", "DC"),
  Vessel   = c("P","P","P","D","D","D"),
  TT  = c(8,16,24,13,26,39),
  value     = c(2097659574+200000000, 3762183908+200000000, 4233882353+200000000, 
                2961170213+200000000, 4233882353+200000000, 5161333333-200000000))
  # value     = c(max - (min*2),max- min,max,max- (min*2),max-min,max))
  
dat_text$Vessel <- factor(dat_text$Vessel, levels = c("P", "D"))

max(subset(df, Vessel == "D" & Transit == "LT")$TotalpermL)


plotD <-  papertheme(ggplot(df, aes(x = as.numeric(TT), y = as.numeric(TotalpermL))) + geom_boxplot(aes(fill = TransitT)) + 
               geom_jitter(aes(color = Donor, alpha = 0.8))) + 
  scale_color_manual(values = sixdonors) + ylab(expression(paste("Cell concentration (cells m",L^{"-1"}, ")"))) + 
  xlab("SHIME transit time (h)") +
  scale_fill_manual(values = transitcolours2, breaks = c("PST", "PMT", "PLT"), 
                      labels = c("Short", "Medium", "Long"), name = "SHIME transit") +
     guides(alpha = "none", fill=guide_legend(ncol=1, title.position = "top"), 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
    theme(legend.position = c(0.65, 0.13), legend.box = "horizontal", legend.title = element_text(size = 19), 
          legend.text = element_text(size = 19))+
  stat_smooth(method='lm', se=F, color = "black") + 
  # geom_text(x = 7, y = 5e+09, size = 7, colour = "#666666", family="sans", label = eq(df$TT,df$TotalpermL), parse = TRUE, hjust = 0) +
  geom_text(data= dat_text,  mapping = aes(x = as.numeric(TT), y = as.numeric(value), label = label), family = 'sans', colour = "#474747", size = 6, parse = TRUE, vjust = 0) +
  geom_text(x = 7, y = 5e+09, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)  
plotD
paperplot_correlation <- plotD
```

## Dont run - polynomial
```{r fig.height=7.5, fig.width=10}
# Polynomial
lm(TotalpermL ~ TT + I(TT^2), data = df) %>% summary()
lm(TT ~ TotalpermL + I(TotalpermL^2), data = df) %>% summary()
lm(TotalpermL ~ poly(TT, 2, raw = TRUE), data = df) %>%  summary()

# Check how many iterations are significant. After that make number lower
lm(TotalpermL ~ poly(TT, 4, raw = TRUE), data = df) %>%  summary()


# Build the model
model <- lm(TotalpermL ~ poly(TT, 5, raw = TRUE), data = df)
# Make predictions
predictions <- model %>% predict(df)
# Model performance
data.frame(
  RMSE = RMSE(predictions, df$TotalpermL),
  R2 = R2(predictions, df$TotalpermL)
)


papertheme(ggplot(df, aes(x = as.numeric(TT), y = as.numeric(TotalpermL))) + geom_boxplot(aes(fill = TransitT)) + 
               geom_jitter(aes(color = Donor, alpha = 0.8))) + 
  scale_color_manual(values = sixdonors) + ylab(expression(paste("Microbial load (cells m",L^{"-1"}, ")"))) + xlab("Transit time (h)") +
  scale_fill_manual(values = transitcolours2, breaks = c("PST", "PMT", "PLT"), 
                      labels = c("Short", "Medium", "Long"), name = "SHIME transit") +
     guides(alpha = "none", fill=guide_legend(ncol=1, title.position = "top"), 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
    theme(legend.position = c(0.7, 0.2), legend.box = "horizontal", 
          legend.title = element_text(size = 18), legend.text = element_text(size = 18)) +
  # stat_smooth(method='lm') +
  geom_text(x = 20, y = 5e+09, size = 5, label = eq(df$TT,df$TotalpermL, type = "poly"), parse = TRUE) +
  stat_smooth(method = lm, formula = y ~ poly(x, 3, raw = TRUE))
  # stat_smooth(method = lm, formula = y ~ poly(x, 3, raw = TRUE))

  
  
# Log transformation
# Build the model
model <- lm(TotalpermL ~ log(TT), data = train.data)
# Make predictions
predictions <- model %>% predict(test.data)
# Model performance
dfA <- data.frame(
  RMSE = RMSE(predictions, test.data$TotalpermL),
  R2 = R2(predictions, test.data$TotalpermL)
)

ggplot(train.data, aes(TT, TotalpermL) ) +
  geom_point() +
  stat_smooth(method = lm, formula = y ~ log(x))

# Build the model
model <- lm(TotalpermL ~ log(TT), data = df)
summary(model)
# Make predictions
predictions <- model %>% predict(df)
# Model performance
dflog <- data.frame(
  RMSE = RMSE(predictions, df$TotalpermL),
  R2 = R2(predictions, df$TotalpermL)
)


rm(rhot)
rhot <- cor.test(log(df$TT), df$TotalpermL, method = 'spearman')
rhot <- format(as.numeric(rhot$estimate[[1]]), digits = 3)
rho_text <- expression(paste("Spearman's ", rho, "= 0.833"))
summary(lm(log(df$TT) ~ df$TotalpermL))

papertheme(ggplot(df, aes(x = as.numeric(TT), y = as.numeric(TotalpermL))) + geom_boxplot(aes(fill = TransitT)) + 
               geom_jitter(aes(color = Donor, alpha = 0.8))) + 
  stat_smooth(method = lm, formula = y ~ log(x))
  

papertheme(ggplot(df, aes(x = as.numeric(TT), y = as.numeric(log(TotalpermL)))) + geom_boxplot(aes(fill = TransitT)) + 
               geom_jitter(aes(color = Donor, alpha = 0.8))) + 
  scale_color_manual(values = sixdonors) + ylab(expression(paste("Microbial load (cells m",L^{"-1"}, ")"))) + xlab("Transit time (log(h))") +
  scale_fill_manual(values = transitcolours2, breaks = c("PST", "PMT", "PLT"), 
                      labels = c("Short", "Medium", "Long"), name = "SHIME transit") +
     guides(alpha = "none", fill=guide_legend(ncol=1, title.position = "top"), 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
    theme(legend.position = c(0.76, 0.15), legend.box = "horizontal", legend.title = element_text(size = 18), legend.text = element_text(size = 18))+
  stat_smooth(method='lm', se=F, color = "black") + 
  geom_text(x = 2, y = 5e+09, size = 7, colour = "#666666", family="sans", 
            label = eq(log(df$TT),df$TotalpermL, type = "log"), parse = TRUE, hjust = 0) +
  geom_text(x = 6, y = 4.6e+09, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)


papertheme(ggplot(df, aes(x = as.numeric(TT), y = as.numeric(log(TotalpermL)))) + geom_boxplot(aes(fill = TransitT)) + 
               geom_jitter(aes(color = Donor, alpha = 0.8))) + 
  scale_color_manual(values = sixdonors) + ylab(expression(paste("Microbial load (cells m",L^{"-1"}, ")"))) + xlab("Transit time (h)") +
  scale_fill_manual(values = transitcolours2, breaks = c("PST", "PMT", "PLT"), 
                      labels = c("Short", "Medium", "Long"), name = "SHIME transit") +
     guides(alpha = "none", fill=guide_legend(ncol=1, title.position = "top"), 
            color=guide_legend(ncol = 3, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
    theme(legend.position = c(0.76, 0.15), legend.box = "horizontal", legend.title = element_text(size = 18), legend.text = element_text(size = 18))+
  stat_smooth(method='lm', formula = y ~ log(x), se=T, color = "black") + 
  geom_text(x = 6, y = 5e+09, size = 7, colour = "#666666", family="sans", label = eq(df$TT,log(df$TotalpermL), type = "log"), parse = TRUE, hjust = 0)+
  geom_text(x = 6, y = 4.6e+09, size = 7, colour = "#666666", family='sans', label = rho_text, parse = TRUE, hjust = 0)
```

# Figure 1 - Paperplot combination faecal, correlation and dotplot
```{r fig.height=14, fig.width=17}

# ggarrange(ggarrange(plotA, ggarrange(NULL, paperplot_dotplot, nrow = 2, heights = c(0.1,1.15)), 
#                   ncol = 2, widths = c(1,0.3), labels = c("A", "B"), font.label = list(size =20)),
#           ggarrange(paperplot_faecal, paperplot_correlation, labels = c("C", "D"), font.label = list(size =20)), nrow=2, heights = c(1,0.5))
# 
# ggarrange(
#           ggarrange(paperplot_faecal, paperplot_correlation, labels = c("A", "B"), font.label = list(size =20)),
#           ggarrange(plotA, ggarrange(NULL, paperplot_dotplot, nrow = 2, heights = c(0.1,1.15)), 
#                   ncol = 2, widths = c(1,0.3), labels = c("C", "D"), font.label = list(size =20)), nrow=2, heights = c(0.5,1))
# 
# ggarrange(
#           ggarrange(paperplot_faecal, paperplot_correlation, paperplot_percentages, 
#                     labels = c("A", "B", "C"), font.label = list(size =20), ncol = 3, widths = c(1.3,1.3,0.9)),
#           ggarrange(plotA, ggarrange(NULL, paperplot_dotplot, nrow = 2, heights = c(0.1,1.25)), 
#                   ncol = 2, widths = c(1,0.3), labels = c("D", "E"), font.label = list(size =20)), nrow=2, heights = c(0.6,1))
# 
# ggarrange(
#           ggarrange(paperplot_correlation, paperplot_faecal, paperplot_percentages, 
#                     labels = c("A", "B", "C"), font.label = list(size =20), ncol = 3, widths = c(1.3,1.3,0.9)),
#           ggarrange(plotA, ggarrange(NULL, paperplot_dotplot, nrow = 2, heights = c(0.1,1.25)), 
#                   ncol = 2, widths = c(1,0.3), labels = c("D", "E"), font.label = list(size =20)), nrow=2, heights = c(0.6,1))

paperplot_bis <- paperplot_dotplot + theme(axis.text.y = element_text(size = 20,family='sans',angle=0),
                         axis.title.y = element_text(size=20,family='sans',angle=90),
                         axis.ticks.y =element_line(colour = "black"))

comboplot <- ggarrange(
          ggarrange(paperplot_correlation, paperplot_bis +ylab(expression(paste("Cell concentration (cells ", mL^{"-1"}, ")"))),
                    paperplot_faecal,  
                    labels = c("A", "B", "C"), font.label = list(size =20), ncol = 3, widths = c(1.3,0.9,1.4)),
          ggarrange(plot_Biomass_effA + 
                      # ylab(expression(paste("Total cells relative to nutrient load (cells ", g^{"-1"}, ")")))
                    ylab(expression(paste("Nutrient-to-biomass conversion efficiency  (cells ", g^{"-1"}, ")"))),
                     
                    ggarrange(NULL,plot_Biomass_effB, nrow = 2, heights = c(0.055,1)), 
            paperplot_percentages,
                  ncol = 3, widths = c(1, 0.3,0.5), labels = c("D", "E", "F"), font.label = list(size =20)), 
          nrow=2, heights = c(1,1.2))
# comboplot

comboplot <- ggarrange(
          ggarrange(paperplot_correlation + guides(alpha = "none", fill=guide_legend(ncol=1, title.position = "top"), 
            color=guide_legend(ncol = 2, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
              theme(legend.position = c(0.65, 0.13), legend.box = "horizontal", legend.title = element_text(size = 19),
                    legend.text = element_text(size = 19)), 
                    paperplot_bis + ylab(expression(paste("Cell concentration (cells ", mL^{"-1"}, ")"))),
                    paperplot_faecal,  
                    labels = c("A", "B", "C"), font.label = list(size =20), ncol = 3, widths = c(1.35,0.87,1.5)),
          ggarrange(paperplot_carbohydratesA,
                    ggarrange(NULL,paperplot_carbohydratesB, nrow = 2, heights = c(0.05,1)), 
                    paperplot_percentages,
                  ncol = 3, widths = c(1, 0.45,0.4), labels = c("D", "E", "F"), font.label = list(size =20)), 
          nrow=2, heights = c(1,1.2))
# comboplot


comboplot <- ggarrange(
          ggarrange(paperplot_correlation + guides(alpha = "none", fill=guide_legend(ncol=1, title.position = "top"), 
            color=guide_legend(ncol = 2, title.position = "top", title.hjust = 0.5, override.aes = list(size=5))) +
              theme(legend.position = c(0.65, 0.13), legend.box = "horizontal", legend.title = element_text(size = 19),
                    legend.text = element_text(size = 19)), 
                    paperplot_bis + ylab(expression(paste("Cell concentration (cells ", mL^{"-1"}, ")"))) + 
              scale_x_discrete(labels= c("Short", "Med", "Long")),
                    paperplot_faecal,  
                    labels = c("A", "B", "C"), font.label = list(size =22), ncol = 3, widths = c(1.45,0.87,1.5)),
          ggarrange(paperplot_carbohydratesA,
                    ggarrange(NULL,paperplot_carbohydratesB + scale_x_discrete(labels= c("Short", "Med", "Long")), 
                              nrow = 2, heights = c(0.05,1)), 
                    paperplot_percentages +scale_x_discrete(labels= c("Short", "Med", "Long")),
                  ncol = 3, widths = c(1, 0.41,0.35), labels = c("D", "E", "F"), font.label = list(size =22)), 
          nrow=2, heights = c(1,1.2));comboplot


saveplots()
ggsave(plot = comboplot, width = 20, height = 13, dpi = 300, filename = "Figure1.tiff")
```


# Ordination
## db-RDA - 3 parameters
```{r RDA_microbial load and percentage intact, eval=, echo=TRUE, fig.height=20, fig.width=13.5}
library(vegan)
library(ggrepel)
# General parameters
functdatanettrt <- subset(df.counts, Ninetransit == 3)
fdata1 <- subset(functdatanettrt, intTransit == "Short transit donor"); fdata1$ivTransit <- "ST"
fdata2 <- subset(functdatanettrt, intTransit == "Medium transit donor"); fdata2$ivTransit <- "MT"
fdata3 <- subset(functdatanettrt, intTransit == "Long transit donor"); fdata3$ivTransit <- "LT"
functdatanettrt <- rbind(fdata1, 
                         fdata2,
                         fdata3); functdatanettrt$ivTransit <- as.factor(functdatanettrt$ivTransit)
set.seed(0604); labelsint <- c("Int"); labelstot <- c("TC") 
neon <- c("#2f89fc"); neonsize <- 7 ;labelcolour <- c("#fc0202"); linecolour <- c("#fc0202")
legendsize <- 15 ; labelsize <- 6; grobsize <- 14
xgrob <- 0.6;  ygrob <- 0.93; ygrobb <- 0.85; xgrobb <- 0.83; plotlabels = T; plotobjects = T
leg.A <- c(0.13,0.77)
leg.C <- c(0.07,0.7)
leg.E <- c(0.13,0.84)
# neon <- c("#FC7F02")
# neon <- c("#7F02FC") 
lefttitle <- "Total cell concentration (TC)" ; righttitle <- "Percentage intact microbial population (Int)"


## Create data frame with data and the sampleinfo
df.sub <- subset(functdatanettrt, select = c(TotalpermL))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
sampleinfo <- subset(functdatanettrt, select = c(ivTransit, Transit, Day, Donor, Vessel))


# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub
 rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")

## Perform PCoA
 pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points

## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 

 # Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
 
 
 
# SHIME transit time
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrobb,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62; pointsize = 9
pos <- position_jitter(width = 0.0, seed = 2)
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Transit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "SHIME transit", labels = c("Short", "Medium", "Long")) + xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
    ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
    geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = RDA2), 
        color = linecolour) + ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2), 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = RDA2,
                                          label = labelstot,
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ),
                                          fill = "grey",
                                          alpha = alphnumb,
                                          label.size = NA,
                                          # color = labelcolour,
                                          size = labelsize,
                                          fontface = "italic",
                                          position = pos)
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") + ggtitle(lefttitle) 
plotobjrdatop15PDA <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDA}

 
 
# ivTransit
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("Donor R\u00B2 = 0.027", 
                                  "\n",lblInvivo," transit R\u00B2= ",Radj2), x=xgrob, 
                            y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62; pointsize = 9
pos <- position_jitter(width = 0.0, seed = 2)
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("ivTransitST", "ivTransitMT", "ivTransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Donor, shape = ivTransit), alpha = 0.8) +
  scale_colour_manual(values = sixdonors, name = "Donor") +
  scale_shape_manual(name = expression(paste(italic("In vivo"), " transit")), 
              values = c("ST" = 16, "MT" = 17, "LT" = 15), labels = c("Short", "Medium", "Long"))+
  
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
    ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
    geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = RDA2), 
        color = linecolour) + ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2), 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = RDA2,
                                          label = labelstot,
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ),
                                          fill = "grey",
                                          alpha = alphnumb,
                                          label.size = NA,
                                          # color = labelcolour,
                                          size = labelsize,
                                          fontface = "italic",
                                          position = pos)
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 2, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") 
plotobjrdatop15PDC <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDC}







# Vessel
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 =", Radj2), x=xgrobb, 
                            y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62; pointsize = 9
pos <- position_jitter(width = 0.0, seed = 2)
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("VesselP", "VesselD"), 
                                 to = c("Proximal", "Distal"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = P_D), alpha = 0.8) +
  scale_colour_manual(values = c("Proximal" = "#cdb174", "Distal" = "#a48d5c"), name = "Vessel") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
    ylab(paste("PC1", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
    geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = PC1), 
        color = linecolour) + ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = PC1), 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = PC1,
                                          label = labelstot,
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ),
                                          fill = "grey",
                                          alpha = alphnumb,
                                          label.size = NA,
                                          # color = labelcolour,
                                          size = labelsize,
                                          fontface = "italic",
                                          position = pos)
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") 
plotobjrdatop15PDE <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDE}








## Create data frame with data and the sampleinfo
df.sub <- subset(functdatanettrt, select = c(Perc_intact))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
sampleinfo <- subset(functdatanettrt, select = c(ivTransit, Transit, Day, Donor, Vessel))

library(vegan)
library(ggrepel)
# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub
 rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")

## Perform PCoA
 pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points

## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 

 # Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
 
 
 
# SHIME transit time
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrobb,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62; pointsize = 9
pos <- position_jitter(width = 0.0, seed = 2)
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Transit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "SHIME transit", labels = c("Short", "Medium", "Long")) + xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
    ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
    geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = RDA2), 
        color = linecolour) + ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2), 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = RDA2,
                                          label = labelsint,
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ),
                                          fill = "grey",
                                          alpha = alphnumb,
                                          label.size = NA,
                                          # color = labelcolour,
                                          size = labelsize,
                                          fontface = "italic",
                                          position = pos, parse = T)
      
        }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") + ggtitle(righttitle) 
plotobjrdatop15PDB <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDB}

 
 
# ivTransit
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("Donor R\u00B2 = 0.15", 
                                  "\nIn vivo transit R\u00B2= ",Radj2), x=xgrob, 
                            y=ygrobb, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62; pointsize = 9
pos <- position_jitter(width = 0.0, seed = 2)
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("ivTransitST", "ivTransitMT", "ivTransitLT"), 
                                 to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Donor, shape = ivTransit), alpha = 0.8) +
  scale_colour_manual(values = sixdonors, name = "Donor") +
  scale_shape_manual(name = expression(paste(italic("In vivo"), " transit")), 
              values = c("ST" = 16, "MT" = 17, "LT" = 15), labels = c("Short", "Medium", "Long"))+
  
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
    ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
    geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = RDA2), 
        color = linecolour) + ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2), 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = RDA2,
                                          label = labelsint,
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ),
                                          fill = "grey",
                                          alpha = alphnumb,
                                          label.size = NA,
                                          # color = labelcolour,
                                          size = labelsize,
                                          fontface = "italic",
                                          position = pos)
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 2, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") 
plotobjrdatop15PDD <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDD}







# Vessel
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 =", Radj2), x=xgrobb, 
                            y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62; pointsize = 9
pos <- position_jitter(width = 0.0, seed = 2)
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }
## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("VesselP", "VesselD"), 
                                 to = c("Proximal", "Distal"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = P_D), alpha = 0.8) +
  scale_colour_manual(values = c("Proximal" = "#cdb174", "Distal" = "#a48d5c"), name = "Vessel") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
    ylab(paste("PC1", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
    geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = PC1), 
        color = linecolour) +ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = PC1), 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = RDA1, y = PC1,
                                          label = labelsint,
                                          segment.color = "grey50"
                                          # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
                                          # hjust = ifelse(RDA1 >= 0, 0, 0.5)
                                          ),
                                          fill = "grey",
                                          alpha = alphnumb,
                                          label.size = NA,
                                          # color = labelcolour,
                                          size = labelsize,
                                          fontface = "italic",
                                          position = pos)
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") 
plotobjrdatop15PDF <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDF}

ggarrange(plotobjrdatop15PDA + theme(legend.position = "none"), plotobjrdatop15PDB + theme(legend.position = c(0.85,0.5)), 
          plotobjrdatop15PDC+ theme(legend.position = "none"), plotobjrdatop15PDD + theme(legend.position = c(0.85,0.35)), 
          plotobjrdatop15PDE+ theme(legend.position = "none"), plotobjrdatop15PDF + theme(legend.position = c(0.85,0.4)),
          ncol = 2 , nrow =3 )

```

# Figure S5
## db-RDA - 4 parameters
```{r RDA_microbial load and percentage intact, eval=, echo=TRUE, fig.height=18, fig.width=13}
library(vegan)
library(ggrepel)
# General parameters
functdatanettrt <- subset(df.counts, Ninetransit == 3)
fdata1 <- subset(functdatanettrt, intTransit == "Short transit donor"); fdata1$ivTransit <- "ST"
fdata2 <- subset(functdatanettrt, intTransit == "Medium transit donor"); fdata2$ivTransit <- "MT"
fdata3 <- subset(functdatanettrt, intTransit == "Long transit donor"); fdata3$ivTransit <- "LT"
functdatanettrt <- rbind(fdata1, 
                         fdata2,
                         fdata3); functdatanettrt$ivTransit <- as.factor(functdatanettrt$ivTransit)
set.seed(0604); labelsint <- c("Int"); labelstot <- c("TC") 
neon <- c("#2f89fc"); neonsize <- 7 ;labelcolour <- c("#fc0202"); linecolour <- c("#fc0202")
legendsize <- 17 ; labelsize <- 6; grobsize <- 14
xgrob <- 0.7;  ygrob <- 0.93; ygrobb <- 0.85; xgrobb <- 0.83; plotlabels = T; plotobjects = T
xgrob <- 0.65;  xgrobb <- 0.75
leg.A <- c(0.13,0.77)
leg.C <- c(0.07,0.7)
leg.E <- c(0.13,0.84)
# neon <- c("#FC7F02")
# neon <- c("#7F02FC") 
lefttitle <- "Total cell concentration (TC)" ; righttitle <- "Percentage intact microbial population (Int)"

Panova <- c()
## Create data frame with data and the sampleinfo
df.sub <- subset(functdatanettrt, select = c(TotalpermL))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
sampleinfo <- subset(functdatanettrt, select = c(ivTransit, Transit, Day, Donor, Vessel))


# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub; df.sub <- df.sub
 rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")

## Perform PCoA
 pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points

## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 

 # Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
 
 
 
# SHIME transit time
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo)
 rdafunct <- capscale(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
abb_digits = T; dgts = 1; abbnum = 3; alphnumb = 0.62; pointsize = 9
pos <- position_jitter(width = 0.0, seed = 2)
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Transit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "SHIME transit", labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelstot),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") + ggtitle(lefttitle) 
plotobjrdatop15PDA <- plotobj + xlim(min(rdascorevfa)-0.5, max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDA}

 



# Donor
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Donor + Condition(Vessel) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ Donor + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Donor"= anova[1,4])
 
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Donor" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes

if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("Donor1", "Donor2", "Donor3", "Donor4", "Donor5","Donor6"), 
                                 to = seq(1:6))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Donor), alpha = 0.8) +
  scale_colour_manual(values = sixdonors, name = "Donor") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelstot),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") # + ggtitle(lefttitle) 
plotobjrdatop15PDB <- plotobj + xlim(min(points$fa - 0.2), max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDB}



# ivTransit
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "ivtransit"= anova[1,4])
 
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "ivTransit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrobb,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes

if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("ivTransitST", "ivTransitMT", "ivTransitLT"), 
                                 to = c("Short", "Medium", "Long"))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = ivTransit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = paste(lblInvivo, "transit"), labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelstot#, segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelstot),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDC <- plotobj + xlim(min(points$fa - 0.2), max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDC}



# Vessel
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("VesselP", "VesselD"), 
                                 to = c("Proximal", "Distal"))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = P_D), alpha = 0.8) +
  scale_colour_manual(values = c("Proximal" = "#cdb174", "Distal" = "#a48d5c"), name = "Vessel") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = MDS1), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = MDS1),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = MDS1,
      #                                     label = labelstot#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = MDS1, label = labelstot),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
}

plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDD <- plotobj + xlim(min(points$fa - 0.2), max(points$fa) + 0.5) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDD}




# ggarrange(plotobjrdatop15PDA, plotobjrdatop15PDB, plotobjrdatop15PDC, plotobjrdatop15PDD, nrow = 4)
Panova1 <- Panova;Panova <- c()



# Percentage intact cells
## Create data frame with data and the sampleinfo
df.sub <- subset(functdatanettrt, select = c(Perc_intact))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
sampleinfo <- subset(functdatanettrt, select = c(ivTransit, Transit, Day, Donor, Vessel))

# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub
 rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")

## Perform PCoA
 pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points

## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 

 # Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
 
 
 
# SHIME transit time
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo)
 rdafunct <- capscale(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])
 
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrobb,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes

if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), 
                                 to = c("Short", "Medium", "Long"))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Transit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "SHIME transit", labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelsint#,segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelsint),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") + ggtitle(righttitle) 
plotobjrdatop15PDE <- plotobj + xlim(min(points$fa - 0.2), max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDE}

 



# Donor
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Donor + Condition(Vessel) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ Donor + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Donor"= anova[1,4])
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Donor" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrobb,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("Donor1", "Donor2", "Donor3", "Donor4", "Donor5","Donor6"), 
                                 to = seq(1:6))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = Donor), alpha = 0.8) +
  scale_colour_manual(values = sixdonors, name = "Donor") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelsint
      #                                     # segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
    plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelsint),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 2, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 2,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDF <- plotobj + xlim(min(points$fa - 1), max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDF}



# ivTransit
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ ivTransit + Condition(Vessel) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "iv"= anova[1,4])
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "ivTransit" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("ivTransitST", "ivTransitMT", "ivTransitLT"), 
                                 to = c("Short", "Medium", "Long"))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = ivTransit), alpha = 0.8) +
  scale_colour_manual(values = transitcolors, name = "In vivo transit", labels = c("Short", "Medium", "Long")) +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = CAP2), 
               color = linecolour)  +
      ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = CAP2),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = RDA1, y = RDA2),
  #                                        # fill = "grey", alpha = 0.5,
  #   color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = CAP2,
      #                                     label = labelsint
      #                                     # segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
  
    plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = CAP2, label = labelsint),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDG <- plotobj + xlim(min(points$fa - 0.2), max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDG}



# Vessel
## Perform RDA with pcoascores to check if its the same
 rdafunctR <- rda(pcoascores~Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo)
 rdafunct <- capscale(df.sub~ Vessel + Condition(ivTransit) + Condition(Transit), sampleinfo, dist="bray")
 # summary(rdafunct); coef(rdafunct)
 
   anova <- anova.cca(rdafunctR,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunctR)$r.squared
 Radj <- RsquareAdj(rdafunctR)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
 ## As label on plot
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2= ",Radj2), x=xgrobb,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))

## labelling axes
if(abb_digits==T){
 Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,dgts)
 Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,dgts) 
 }else{
   if(round(summary(rdafunct)$cont$importance[2,1]*100,0)==0){
     Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,1)
     }else{
       Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
       }
   if(round(summary(rdafunct)$cont$importance[2,2]*100,0)==0){
     Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,1)
     }else{
       Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
     }
 }

## plot SCALING2
plotobjects2 = F
if(plotobjects2 == TRUE){
  plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
  plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
}
 
 
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = sampleinfo$Donor, 
    P_D = sampleinfo$Vessel, Transit = sampleinfo$Transit, ivTransit = sampleinfo$ivTransit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("VesselP", "VesselD"), 
                                 to = c("Proximal", "Distal"))

plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, size = pointsize, color = P_D), alpha = 0.8) +
  scale_colour_manual(values = c("Proximal" = "#cdb174", "Distal" = "#a48d5c"), name = "Vessel") +
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + 
  ylab(paste("RDA2", Dim2, "%", sep = " ")) + annotation_custom(grob) + 
  geom_segment(data = rdascorevfa, aes(x = 0, xend = CAP1, y = 0, yend = MDS1), 
               color = linecolour)  +
    ggrepel::geom_label_repel(data = rdafactor, aes(x = CAP1, y = MDS1),
                              segment.color = "grey50", alpha = alphnumb+.15, 
                                         # fill = "grey", alpha = 0.5,
    color = neon, label = rownames(rdafactor), size = neonsize)
  
  # ggrepel::geom_text_repel(data = rdafactor, aes(x = CAP1, y = MDS1),
    #                                      # fill = "grey", alpha = 0.5,
    # color = neon, label = rownames(rdafactor), size = neonsize)

if(plotlabels == T){

      # plotobj <- plotobj + ggrepel::geom_label_repel(data = rdascorevfa,  aes(x = CAP1, y = MDS1,
      #                                     label = labelsint,
      #                                     # segment.color = "grey50"
      #                                     # vjust = ifelse(RDA2 >= 0, -0.1, 0.7),
      #                                     # hjust = ifelse(RDA1 >= 0, 0, 0.5)
      #                                     ),
      #                                     color = linecolour,
      #                                     # fill = "grey",
      #                                     alpha = alphnumb,
      #                                     label.size = NA,
      #                                     # color = labelcolour,
      #                                     size = labelsize,
      #                                     fontface = "italic",
      #                                     position = pos)
      
  plotobj <- plotobj + geom_label(data = rdascorevfa,  aes(x = CAP1, y = MDS1, label = labelsint),
                                          color = linecolour, alpha = alphnumb, label.size = NA,
                                          size = labelsize, fontface = "italic")
      }
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1, direction = "horizontal",
      title.position = "top", override.aes = list(size = 5)), shape = guide_legend(ncol = 1,direction = "horizontal", override.aes = list(size = 5), title.position = "top"), size = "none") +
  theme(legend.position = "right") 
# mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position =  c(0.88,0.05), 
        legend.text = element_text(size=legendsize,family='sans',angle=0),
        legend.title = element_text(size=legendsize,family='sans',angle=0),
        legend.direction = "horizontal") #+ ggtitle(lefttitle) 
plotobjrdatop15PDH <- plotobj + xlim(min(points$fa - 0.2), max(points$fa + 0.5)) + 
  # ggtitle(lefttitle) + 
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

if(plotobjects == TRUE){plotobjrdatop15PDH}
 
 

 
 

ggarrange(plotobjrdatop15PDA + theme(legend.position = "none"), plotobjrdatop15PDE + theme(legend.position = c(0.85,0.5)), 
          plotobjrdatop15PDB+ theme(legend.position = "none"), plotobjrdatop15PDF + theme(legend.position = c(0.65,0.2)), 
          plotobjrdatop15PDC+ theme(legend.position = "none"), plotobjrdatop15PDG + theme(legend.position = c(0.21,0.8)),
          plotobjrdatop15PDD+ theme(legend.position = "none"), plotobjrdatop15PDH + theme(legend.position = c(0.61,0.15)),
          ncol = 2 , nrow =4 , labels = "AUTO", font.label = list(size = 20))

 Panova1
 p.adjust(Panova1, method = "holm") 

Panova
 p.adjust(Panova, method = "holm")

```



## db-RDA - Buildup model
```{r RDA_microbial load and percentage intact, eval=, echo=TRUE, fig.height=15, fig.width=13.5}
# General parameters
## Create in vivo transit variable
functdatanettrt <- subset(df.counts, Ninetransit == 3)
functdatanettrt$Day <- as.numeric(functdatanettrt$Day)
# functdatanettrt <- rename_dates(functdatanettrt, type = "xx")
fdata1 <- subset(functdatanettrt, intTransit == "Short transit donor"); fdata1$ivTransit <- "ST"
fdata2 <- subset(functdatanettrt, intTransit == "Medium transit donor"); fdata2$ivTransit <- "MT"
fdata3 <- subset(functdatanettrt, intTransit == "Long transit donor"); fdata3$ivTransit <- "LT"
functdatanettrt <- rbind(fdata1, 
                         fdata2,
                         fdata3); functdatanettrt$ivTransit <- as.factor(functdatanettrt$ivTransit)

set.seed(0604); labelsint <- c("Int"); labelstot <- c("ML") 
neon <- c("#2f89fc"); neonsize <- 7 ;labelcolour <- c("#fc0202"); linecolour <- c("#fc0202")
legendsize <- 15 ; labelsize <- 6; grobsize <- 14
xgrob <- 0.7;  ygrob <- 0.93; xgrobb <- 0.83

xgrob <- 0.6;  ygrob <- 0.93; xgrobb <- 0.7

leg.A <- c(0.13,0.77)
leg.C <- c(0.07,0.7)
leg.E <- c(0.13,0.84)

lefttitle <- "Microbial load" ; righttitle <- "Percentage intact microbial population"

## Create data frame with data and the sampleinfo
df.sub <- subset(functdatanettrt, select = c(TotalpermL))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
sampleinfo <- subset(functdatanettrt, select = c(ivTransit, Transit, Day, Donor, Vessel))

library(vegan)
# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub
 rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")

## Perform PCoA
 pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points

## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)

 ordi
 ordi$anova
 
test <- ordi[["anova"]]
test <- rownames_to_column(test) %>%
  mutate_all(funs(gsub("[[:punct:]]", "", .)))
test <- test %>%
  mutate_all(funs(gsub(" ", "", .)))
test <- test[1:nrow(test) - 1,]
variables <- test$rowname; message(crayon::green(paste("Hey, your variables are:"))); variables




# Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
# SHIME transit time
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Transit + Condition(Vessel) + Condition(Donor), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])
 
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Transit" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Transit + Condition(Vessel) + Condition(Donor),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)


# Colon vessels
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Vessel + Condition(Transit) + Condition(Donor), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Vessel" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Vessel + Condition(Transit) + Condition(Donor),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
# Donor
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Donor + Condition(Transit) + Condition(Vessel), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Donor" = anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Donor" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Donor + Condition(Transit) + Condition(Vessel),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Donor" = Radj) 
 
 ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 Radjs; CheckRadjs
 CheckRadjs_donor <- CheckRadjs
 
 
 
 
# Adjust p-values because of multiple testing
 # Correction for multiple testing (Benjamini–Hochberg procedure, FDR) 
 Panova
 p.adjust(Panova, method = "holm")
 
 
 
 
 
 
 
 # Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
# SHIME transit time
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])
 
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Transit" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)


# Colon vessels
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Vessel + Condition(Transit) + Condition(ivTransit), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Vessel" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Vessel + Condition(Transit) + Condition(ivTransit),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
# Donor
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ ivTransit + Condition(Transit) + Condition(Vessel), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "ivTransit" = anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "ivTransit" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~ivTransit + Condition(Transit) + Condition(Vessel),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "ivTransit" = Radj) 
 
 ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 Radjs; CheckRadjs
 CheckRadjs_iv <- CheckRadjs
 CheckRadjs_donor
 
 
 
# Adjust p-values because of multiple testing
 # Correction for multiple testing (Benjamini–Hochberg procedure, FDR) 
 Panova
 p.adjust(Panova, method = "holm")
 
 
```


## db-RDA - Buildup model - percentage
```{r RDA_microbial load and percentage intact, eval=, echo=TRUE, fig.height=15, fig.width=13.5}
# General parameters
## Create in vivo transit variable
functdatanettrt <- subset(df.counts, Ninetransit == 3)
functdatanettrt$Day <- as.numeric(functdatanettrt$Day)
# functdatanettrt <- rename_dates(functdatanettrt, type = "xx")
fdata1 <- subset(functdatanettrt, intTransit == "Short transit donor"); fdata1$ivTransit <- "ST"
fdata2 <- subset(functdatanettrt, intTransit == "Medium transit donor"); fdata2$ivTransit <- "MT"
fdata3 <- subset(functdatanettrt, intTransit == "Long transit donor"); fdata3$ivTransit <- "LT"
functdatanettrt <- rbind(fdata1, 
                         fdata2,
                         fdata3); functdatanettrt$ivTransit <- as.factor(functdatanettrt$ivTransit)

set.seed(0604); labelsint <- c("Int"); labelstot <- c("ML") 
neon <- c("#2f89fc"); neonsize <- 7 ;labelcolour <- c("#fc0202"); linecolour <- c("#fc0202")
legendsize <- 15 ; labelsize <- 6; grobsize <- 14
xgrob <- 0.7;  ygrob <- 0.93; xgrobb <- 0.83
leg.A <- c(0.13,0.77)
leg.C <- c(0.07,0.7)
leg.E <- c(0.13,0.84)

lefttitle <- "Microbial load" ; righttitle <- "Percentage intact microbial population"

## Create data frame with data and the sampleinfo
df.sub <- subset(functdatanettrt, select = c(Perc_intact))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
sampleinfo <- subset(functdatanettrt, select = c(ivTransit, Transit, Day, Donor, Vessel))

library(vegan)
# Develop correct model
## Compute dissimilarity matrix
 rdaplot <- df.sub
 rdajaccard <- vegdist(rdaplot,method="jaccard",binary="FALSE")
 rdabray <- vegdist(rdaplot,method="bray",binary="FALSE")

## Perform PCoA
 pcoail <- cmdscale(rdajaccard,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoail <- cmdscale(rdabray,k=(nrow(rdaplot)-1),eig=TRUE)
 pcoascores <- pcoail$points

## Automatic stepwise model building for constrained ordination methods
 mod0 <- rda(pcoascores ~ 1, sampleinfo)  # Model with intercept only
 mod1 <- rda(pcoascores ~ ., sampleinfo)  # Model with all explanatory variables
 ordi <- ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)

 ordi
 ordi$anova
 
test <- ordi[["anova"]]
test <- rownames_to_column(test) %>%
  mutate_all(funs(gsub("[[:punct:]]", "", .)))
test <- test %>%
  mutate_all(funs(gsub(" ", "", .)))
test <- test[1:nrow(test) - 1,]
variables <- test$rowname; message(crayon::green(paste("Hey, your variables are:"))); variables




# Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
# SHIME transit time
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Transit + Condition(Vessel) + Condition(Donor), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])
 
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Transit" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Transit + Condition(Vessel) + Condition(Donor),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)


# Colon vessels
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Vessel + Condition(Transit) + Condition(Donor), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Vessel" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Vessel + Condition(Transit) + Condition(Donor),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
# Donor
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Donor + Condition(Transit) + Condition(Vessel), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Donor" = anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Donor" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Donor + Condition(Transit) + Condition(Vessel),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Donor" = Radj) 
 
 ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 Radjs
 CheckRadjs_donor <- CheckRadjs
 
 
 
 
 
 
 
# Go through all the selected variables in the model
 Radjs <- c(); CheckRadjs <- c(); Panova <- c()
 
# SHIME transit time
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Transit + Condition(Vessel) + Condition(ivTransit), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Transit"= anova[1,4])
 
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Transit" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Transit + Condition(Vessel) + Condition(ivTransit),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Transit" = Radj)


# Colon vessels
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ Vessel + Condition(Transit) + Condition(ivTransit), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "Vessel"= anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "Vessel" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~Vessel + Condition(Transit) + Condition(ivTransit),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "Vessel" = Radj)
 
 
# Donor
## to plot original species on graph: capscale function!!!
 dbrdail <- dbrda(df.sub~ ivTransit + Condition(Transit) + Condition(Vessel), sampleinfo, dist="bray")
 summary(dbrdail)
 coef(dbrdail)
 plot(dbrdail)

## permutation test of the results
 anova.cca(dbrdail,step=1000)
 anova <- anova.cca(dbrdail,step=1000)
 Panova <- c(Panova, "ivTransit" = anova[1,4])
 # cores <- makeCluster(4) # Define amount of clusters
 # anova.cca(dbrdail,by="axis",step=1000, parallel = cores)
 # stopCluster(cores)

## explanatory power of the variables included
 Runadj <- RsquareAdj(dbrdail)$r.squared
 Radj <- RsquareAdj(dbrdail)$adj.r.squared
 Radjs <- c(Radjs, "ivTransit" = Radj)
 
## Perform RDA with pcoascores to check if its the same
 rdafunct <- rda(pcoascores~ivTransit + Condition(Transit) + Condition(Vessel),sampleinfo)
 # summary(rdafunct); coef(rdafunct)
 
## explanatory power of the variables included
 Runadj <- RsquareAdj(rdafunct)$r.squared
 Radj <- RsquareAdj(rdafunct)$adj.r.squared
 CheckRadjs <- c(CheckRadjs, "ivTransit" = Radj) 
 
 ordiR2step(mod0, scope = formula(mod1), perm.max = 200)
 # ordistep(mod0, scope = formula(mod1), perm.max = 200)
 Radjs
 CheckRadjs_iv <- CheckRadjs
  CheckRadjs_donor
 
# Adjust p-values because of multiple testing
 # Correction for multiple testing (Benjamini–Hochberg procedure, FDR) 
 Panova
 p.adjust(Panova, method = "holm")
```





## db-RDA - Run model
```{r RDA_microbial load and percentage intact, eval=, echo=TRUE, fig.height=15, fig.width=13.5}
# Transit time
df.sub <- subset(functdatanettrt, select = c(TotalpermL))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)


# Model formula, where the left hand side gives the community data matrix, right hand side gives the constraining variables, 
# and conditioning variables can be given within a special function Condition.
rdafunct <- vegan::cca(df.sub~Transit+Condition(Vessel)+ Condition(Donor), functdatanettrt)
coef(rdafunct); #summary(rdafunct)
## permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.A <- data.frame("Transit","Time","Total", "Cells")
rownames(df.A) <- df.A$X.Transit.
num = anova.cca(rdafunct,step=1000); if(num[1,4]<0.05){message(crayon::green(num[1,4]))}else{message(crayon::red(num[1,4]))}
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.A) <- colnames(num)
df.A <- rbind(df.A, num)
## explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
## plot SCALING2
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = functdatanettrt$Donor, 
                     P_D = functdatanettrt$Vessel, Transit = functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, color = points$Transit)) +
  scale_colour_manual(values = transitcolors, name = "Transit time") + 
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + ylab(paste("PC1", Dim2, "%", sep = " ")) +
  annotation_custom(grob) +
  geom_text_repel(data = rdafactor, aes(x = RDA1, y = PC1), color = neon, label = rownames(rdafactor), 
                  segment.color = "grey50", size = neonsize)
plotobj <- plotobj + geom_text(data = rdascorevfa, aes(x = RDA1, y = PC1, label = labelstot, 
  vjust = ifelse(PC1 >= 0, -0.1, 0.7), hjust = ifelse(RDA1 >= 0, 0, 0.5)), color = linecolour, size = 7, parse = TRUE) +
  geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = PC1), color = labelcolour)
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1)) + theme(legend.position = "right")
mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position = leg.A, legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize))
plotobjrdafunctcellPDA <- plotobj +
  xlim(min(points$fa,rdascorevfa$RDA1)-10000,max(points$fa,rdascorevfa$RDA1) + 10000) +
  ylim(min(points$fa, rdascorevfa$PC1)-10000,max(points$fa, rdascorevfa$PC1+10000))+
  ggtitle(lefttitle) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
plotobjrdafunctcellPDA


# Donor
df.sub <- subset(functdatanettrt, select = c(TotalpermL))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
rdafunct <- rda(df.sub~Donor+Condition(Transit) + Condition(Vessel),functdatanettrt)
coef(rdafunct); #summary(rdafunct)
# permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.C <- data.frame("Donor","","Total", "cells")
rownames(df.C) <- df.C$X.Donor.
num = anova.cca(rdafunct,step=1000)
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.C) <- colnames(num); df.C <- rbind(df.C, num)
# explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
# labelling axes
Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
#plot SCALING2
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
# ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints,Donor=functdatanettrt$Donor,P_D=functdatanettrt$Vessel, Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
 
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("Donor1", "Donor2","Donor3", "Donor4", "Donor5", "Donor6"),
                                 to=c("1","2", "3", "4", "5", "6"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=points$Donor)) + scale_colour_manual(values=sixdonors,name="Donor") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + 
  ylab(paste('PC1',Dim2,"%",sep=" ")) +  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=PC1), color=neon, label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj+geom_text(data=rdascorevfa,aes(x=RDA1,y=PC1,label=labelstot,vjust=ifelse(PC1>= 0,-0.1,0.7),hjust=ifelse(RDA1>=0,0,0.5)),color=linecolour,size=7,parse=TRUE) + geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=PC1),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+ guides(color=guide_legend(ncol=1))+ theme(legend.position = "right")
mylegendPDfunctnet<-g_legend(plotobj)
plotobj <- plotobj + theme(legend.position = leg.C, legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize))
plotobjrdafunctcellPDC <- plotobj +
  xlim(min(points$fa,rdascorevfa$RDA1)-100,max(points$fa,rdascorevfa$RDA1) + 100) +
  ylim(min(points$fa, rdascorevfa$PC1)-100,max(points$fa, rdascorevfa$PC1+100))
plotobjrdafunctcellPDC
# PD_Colon
df.sub <- subset(functdatanettrt, select = c(TotalpermL))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
rdafunct <- rda(df.sub~Vessel+Condition(Transit) + Condition(Donor),functdatanettrt)
coef(rdafunct); #summary(rdafunct)
## permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.E <- data.frame("PD_Colon","","Total", "Cells")
rownames(df.E) <- df.E$X.Donor.
num = anova.cca(rdafunct,step=1000)
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.E) <- colnames(num)
df.E <- rbind(df.E, num)
## explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
## plot SCALING2
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
## ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints, Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel,Nutrient_Load=functdatanettrt$Vessel)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("VesselP", "VesselD"), to=c("Proximal","Distal"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=points$P_D)) + scale_colour_manual(values=vesselcolors,name="Colon") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + ylab(paste('PC1',Dim2,"%",sep=" ")) +
  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=PC1),color=neon,label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj+geom_text(data=rdascorevfa,aes(x=RDA1,y=PC1,label=labelstot,vjust=ifelse(PC1>= 0,-0.1,0.7),hjust=ifelse(RDA1>=0,0,0.5)),color=linecolour,size=7,parse=TRUE) +geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=PC1),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+guides(color=guide_legend(ncol=1))+ 
  theme(legend.position = "right", legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize), legend.title.align = 0.5)
mylegendPD <- g_legend(plotobj)
plotobj <- plotobj +
  xlim(min(points$fa,rdascorevfa$RDA1)-10000,max(points$fa,rdascorevfa$RDA1) + 10000) +
  ylim(min(points$fa, rdascorevfa$PC1)-10000,max(points$fa, rdascorevfa$PC1+10000)) + theme(legend.position = leg.E)
plotobjrdafunctcellPDE <- plotobj 
plotobjrdafunctcellPDE
# Percentage of intact cells
# Transit time
df.sub <- subset(functdatanettrt, select = c(Perc_intact))
# df.sub$Percentage_intact_cells <- df.sub$Percentage_intact_cells/100
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
rdafunct <- rda(df.sub~Transit+Condition(Donor) + Condition(Vessel),functdatanettrt)
coef(rdafunct); #summary(rdafunct)
## permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.B <- data.frame("Nutrient","Load","percentage", "intact")
rownames(df.B) <- df.B$X.Nutrient.
num = anova.cca(rdafunct,step=1000)
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.B) <- colnames(num)
df.B <- rbind(df.B, num)
## explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
## plot SCALING2
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
## ggplot
rdascores <- scores(rdafunct, choices = 1:2, scaling = 2, display = "sites")
firstaxispoints <- rdascores[, 1]; secondaxispoints <- rdascores[, 2]
points <- data.frame(fa = firstaxispoints, sa = secondaxispoints, Donor = functdatanettrt$Donor, 
                     P_D = functdatanettrt$Vessel, Transit = functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D, from = c("P", "D"), to = c("Proximal", "Distal"))
rdascorevfa <- data.frame(scores(rdafunct, choices = 1:2, scaling = 2, display = "species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor), from = c("TransitST", "TransitMT", "TransitLT"), to = c("Short", "Medium", "Long"))
plotobj <- ggplot(as.data.frame(points)) + geom_point(aes(x = fa, y = sa, color = points$Transit)) +
  scale_colour_manual(values = transitcolors, name = "Transit", labels = c("Short", "Medium", "Long")) + 
  xlab(paste("RDA1", Dim1, "%", sep = " ")) + ylab(paste("PC1", Dim2, "%", sep = " ")) +
  annotation_custom(grob) +
  geom_text_repel(data = rdafactor, aes(x = RDA1, y = PC1), color = neon, label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj + geom_text(data = rdascorevfa, aes(x = RDA1, y = PC1, label = labelsint, 
  vjust = ifelse(PC1 >= 0, -0.1, 0.7), hjust = ifelse(RDA1 >= 0, 0, 0.5)), color = linecolour, size = 7, parse = TRUE) +
  geom_segment(data = rdascorevfa, aes(x = 0, xend = RDA1, y = 0, yend = PC1), color = labelcolour)
plotobj <- papertheme(plotobj)
plotobj <- plotobj + guides(color = guide_legend(ncol = 1)) + theme(legend.position = "right")
mylegendPDfunctnet <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position = leg.A, legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize))
plotobjrdafunctcellPDB <- plotobj +
  xlim(min(points$fa,rdascorevfa$RDA1)-1,max(points$fa,rdascorevfa$RDA1) + 1) +
  ylim(min(points$fa, rdascorevfa$PC1)-1,max(points$fa, rdascorevfa$PC1+1)) +
  ggtitle(righttitle) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
plotobjrdafunctcellPDB
# Donor
# PCA with acetate propionate and butyrate
df.sub <- subset(functdatanettrt, select = c(Perc_intact))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
rdafunct <- rda(df.sub~Donor+Condition(Transit) + Condition(Vessel),functdatanettrt)
coef(rdafunct); #summary(rdafunct)
# permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.D <- data.frame("Donor","","percentage", "intact")
rownames(df.D) <- df.D$X.Donor.
num = anova.cca(rdafunct,step=1000)
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.D) <- colnames(num)
df.D <- rbind(df.D, num)
# explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
# labelling axes
Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
#plot SCALING2
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
# ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints,Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel,Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
 
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("Donor1", "Donor2","Donor3", "Donor4", "Donor5", "Donor6"),
                                 to=c("1","2", "3", "4", "5", "6"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=points$Donor)) + scale_colour_manual(values=sixdonors,name="Donor") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + 
  ylab(paste('PC1',Dim2,"%",sep=" ")) +  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=PC1), color=neon, label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj+geom_text(data=rdascorevfa,aes(x=RDA1,y=PC1,label=labelsint,vjust=ifelse(PC1>= 0,-0.1,0.7),hjust=ifelse(RDA1>=0,0,0.5)),color=linecolour,size=7,parse=TRUE) + geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=PC1),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+ guides(color=guide_legend(ncol=1))+ theme(legend.position = "right")
mylegendPDfunctnet<-g_legend(plotobj)
plotobj <- plotobj +
  xlim(min(points$fa,rdascorevfa$RDA1)-1,max(points$fa,rdascorevfa$RDA1) + 1) +
  ylim(min(points$fa, rdascorevfa$PC1)-1,max(points$fa, rdascorevfa$PC1+1)) + 
  theme(legend.position = leg.C, legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize))
plotobjrdafunctcellPDD <- plotobj 
plotobjrdafunctcellPDD
# PD_Colon
## PCA with acetate propionate and butyrate
df.sub <- subset(functdatanettrt, select = c(Perc_intact))
functdatanettrt$Transit <- as.factor(functdatanettrt$Transit)
rdafunct <- rda(df.sub~Vessel+Condition(Transit) + Condition(Donor),functdatanettrt)
coef(rdafunct); #summary(rdafunct)
## permutation test of the results
anova.cca(rdafunct,step=1000)
anova.cca(rdafunct,by="term",step=1000)
df.F <- data.frame("PD_Colon","","percentage", "intact")
rownames(df.F) <- df.F$X.Donor.
num = anova.cca(rdafunct,step=1000)
num$Df <- as.factor(num$Df); num$Variance <- as.factor(num$Variance); num$F <- as.factor(num$F); num$`Pr(>F)` <- as.factor(num$`Pr(>F)`)
colnames(df.F) <- colnames(num)
df.F <- rbind(df.F, num)
## explanatory power of the variables included == constrained waarde (variance corrected) 
Runadj <- RsquareAdj(rdafunct)$r.squared
Radj <- RsquareAdj(rdafunct)$adj.r.squared
Radj
Radj2 <- signif(Radj, digits = 2)
grob <- grobTree(textGrob(paste("R\u00B2 = ", Radj2), x=xgrob,  y=ygrob, hjust=0,  gp=gpar(col="black", fontsize=grobsize, fontface="italic")))
## labelling axes
Dim1 <- round(summary(rdafunct)$cont$importance[2,1]*100,0)
Dim2 <- round(summary(rdafunct)$cont$importance[2,2]*100,0)
## plot SCALING2
plot(rdafunct,scaling=2,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","wa","cn"))
plot(rdafunct,scaling=1,main="Triplot RDA datanormalised_subset ~ functional -scaling 1 ",type = "text",display=c("sp","lc","cn"))
## ggplot
rdascores <-scores(rdafunct,choices=1:2,scaling=2,display="sites")
firstaxispoints <- rdascores[,1]
secondaxispoints <- rdascores[,2]
points <- data.frame(fa=firstaxispoints,sa=secondaxispoints,Donor=functdatanettrt$Donor,
                     P_D=functdatanettrt$Vessel,Transit=functdatanettrt$Transit)
points$P_D <- mapvalues(points$P_D,from=c("P","D"),to=c("Proximal","Distal"))
rdascorevfa <- data.frame(scores(rdafunct,choices=1:2,scaling=2,display="species"))
rdafactor <- data.frame(summary(rdafunct)$centroids)
rownames(rdafactor) <- mapvalues(rownames(rdafactor),from=c("VesselP", "VesselD"), to=c("Proximal","Distal"))
plotobj <- ggplot(as.data.frame(points))+geom_point(aes(x=fa,y=sa,color=points$P_D)) + scale_colour_manual(values=vesselcolors,name="Colon") + xlab(paste('RDA1',Dim1,"%",sep=" ")) + ylab(paste('PC1',Dim2,"%",sep=" ")) +
  annotation_custom(grob) +
  geom_text_repel(data=rdafactor,aes(x=RDA1,y=PC1),color=neon,label = rownames(rdafactor), segment.color = "grey50", size = neonsize)
plotobj <- plotobj+geom_text(data=rdascorevfa,aes(x=RDA1,y=PC1,label=labelsint,vjust=ifelse(PC1>= 0,-0.1,0.7),hjust=ifelse(RDA1>=0,0,0.5)),color=linecolour,size=7,parse=TRUE) +geom_segment(data=rdascorevfa,aes(x=0,xend=RDA1,y=0,yend=PC1),color=labelcolour) 
plotobj <- papertheme(plotobj) 
plotobj <- plotobj+guides(color=guide_legend(ncol=1))+ 
  theme(legend.position = "right", legend.text = element_text(size = legendsize), legend.title = element_text(size = legendsize), legend.title.align = 0.5)
mylegendPD <- g_legend(plotobj)
plotobj <- plotobj + theme(legend.position = leg.E)
plotobjrdafunctcellPDF <- plotobj +
  xlim(min(points$fa,rdascorevfa$RDA1)-1,max(points$fa,rdascorevfa$RDA1) + 1) +
  ylim(min(points$fa, rdascorevfa$PC1)-1,max(points$fa, rdascorevfa$PC1+1))
plotobjrdafunctcellPDF
# leg.A <- c(0.86,0.15)
# leg.C <- c(0.92,0.20)
# leg.E <- c(0.86,0.1)
saveplots()
# ggsave(plot = comboplot, width = 10, height = 15, dpi = 300, filename = "Paperplot.RDA.Cells.png")
# 
# # combine with metabolites
plotobjrdafunctcellPDA1 <- plotobjrdafunctcellPDA + theme(legend.position = "none")
plotobjrdafunctcellPDC1 <- plotobjrdafunctcellPDC + theme(legend.position = "none")
plotobjrdafunctcellPDE1 <- plotobjrdafunctcellPDE + theme(legend.position = "none")
# Combine all plots into 1
comboplot <- ggarrange(ggarrange(plotobjrdafunctcellPDA1,  plotobjrdafunctcellPDC1, plotobjrdafunctcellPDE1, 
                                 nrow = 3, labels = c("A","C","E"), 
                                 heights = c(1,0.95,0.95), font.label = list(size = 20), align = "v"), NULL,
                       ggarrange(plotobjrdafunctcellPDB, plotobjrdafunctcellPDD,  plotobjrdafunctcellPDF,
                                 nrow = 3, labels = c("B","D","F"), 
                                 heights = c(1,0.95,0.95), font.label = list(size = 20), align = "v"),
                       ncol = 3, widths = c(1,0.05,1))
comboplot
                     
saveplots()
ggsave(plot = comboplot, width = 13.5, height = 15, dpi = 200, filename = "Supplementary_figure5_low_res.png")
ggsave(plot = comboplot, width = 13.5, height = 15, dpi = 400, filename = "Supplementary_figure5_high_res.tiff")
df.anova.cca.cell <- rbind(df.A, df.B, df.C, df.D, df.E, df.F)
xgrob <- 0.7;  ygrob <- 0.93; xgrobb <- 0.83
leg.A <- c(0.13,0.77)
leg.C <- c(0.07,0.7)
leg.E <- c(0.13,0.84)
# rm(df.sub, labelsA, labels)
# rm(plotobj, rdascores, firstaxispoints, secondaxispoints, Dim1, Dim2, Radj, Radj2, df.A,  df.D,  df.F)
```


#### Plot 
